import{N as tn,C as sn,G as Oe,T as nn,V as b,S as on,E as an,L as rn,B as ln,a as j,b as Ke,M as Te,c as Gt,A as Z,R as Fe,F as $t,d as qe,e as Qe,f as Ze,g as Je,h as P,i as L,j as lt,k as cn,l as hn,m as dn,n as un,O as mn,o as pn,p as fn,Q as gn,q as _i,r as yn,s as wn,t as _n,u as vn,v as bn,w as Tn}from"./yuka-BscLIxFQ.js";import{T as Sn,a as ls,b as vi,L as Mn,c as dt,F as bi,M as ge,V as Ti,C as Se,d as Me,S as je,e as En,P as Si,D as Mi,f as O,g as S,I as xn,Q as vs,h as An,O as fe,i as _t,j as In,B as Dt,k as Rn,l as Ei,N as Cn,m as Pn,n as Ln,o as cs,p as xi,R as ke,q as kn,r as Dn,s as On,t as Yt,u as Ge,v as R,w as Wt,x as K,y as Fn,z as Ie,A as Nn,E as x,G as pt,H as Ai,J as Bn,K as Hn,U as X,W as bs,X as J,Y as Ii,Z as zn,_ as Un,$ as Gn,a0 as Wn,a1 as Ri,a2 as Vn,a3 as Ls,a4 as ks,a5 as Ds,a6 as Os,a7 as Fs,a8 as jn,a9 as Kn,aa as $n,ab as Yn,ac as Xn,ad as qn,ae as Ts,af as Ci,ag as F,ah as Ss,ai as le,aj as te,ak as Pi,al as ct,am as me,an as Ms,ao as Li,ap as Qn,aq as ft,ar as ne,as as Ft,at as ki,au as N,av as Zn,aw as Jn,ax as eo,ay as Ns,az as to,aA as Di,aB as so,aC as io,aD as no,aE as oo,aF as ao,aG as ro}from"./three-DdimqtIv.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();function Bs(r,e){if(e===Sn)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),r;if(e===ls||e===vi){let t=r.getIndex();if(t===null){const o=[],a=r.getAttribute("position");if(a!==void 0){for(let l=0;l<a.count;l++)o.push(l);r.setIndex(o),t=r.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),r}const s=t.count-2,i=[];if(e===ls)for(let o=1;o<=s;o++)i.push(t.getX(0)),i.push(t.getX(o)),i.push(t.getX(o+1));else for(let o=0;o<s;o++)o%2===0?(i.push(t.getX(o)),i.push(t.getX(o+1)),i.push(t.getX(o+2))):(i.push(t.getX(o+2)),i.push(t.getX(o+1)),i.push(t.getX(o)));i.length/3!==s&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const n=r.clone();return n.setIndex(i),n.clearGroups(),n}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),r}class lo extends Mn{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new po(t)}),this.register(function(t){return new fo(t)}),this.register(function(t){return new Mo(t)}),this.register(function(t){return new Eo(t)}),this.register(function(t){return new xo(t)}),this.register(function(t){return new yo(t)}),this.register(function(t){return new wo(t)}),this.register(function(t){return new _o(t)}),this.register(function(t){return new vo(t)}),this.register(function(t){return new mo(t)}),this.register(function(t){return new bo(t)}),this.register(function(t){return new go(t)}),this.register(function(t){return new So(t)}),this.register(function(t){return new To(t)}),this.register(function(t){return new ho(t)}),this.register(function(t){return new Ao(t)}),this.register(function(t){return new Io(t)})}load(e,t,s,i){const n=this;let o;if(this.resourcePath!=="")o=this.resourcePath;else if(this.path!==""){const c=dt.extractUrlBase(e);o=dt.resolveURL(c,this.path)}else o=dt.extractUrlBase(e);this.manager.itemStart(e);const a=function(c){i?i(c):console.error(c),n.manager.itemError(e),n.manager.itemEnd(e)},l=new bi(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(c){try{n.parse(c,o,function(h){t(h),n.manager.itemEnd(e)},a)}catch(h){a(h)}},s,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){let n;const o={},a={},l=new TextDecoder;if(typeof e=="string")n=JSON.parse(e);else if(e instanceof ArrayBuffer)if(l.decode(new Uint8Array(e,0,4))===Oi){try{o[A.KHR_BINARY_GLTF]=new Ro(e)}catch(d){i&&i(d);return}n=JSON.parse(o[A.KHR_BINARY_GLTF].content)}else n=JSON.parse(l.decode(e));else n=e;if(n.asset===void 0||n.asset.version[0]<2){i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new Go(n,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const d=this.pluginCallbacks[h](c);d.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[d.name]=d,o[d.name]=!0}if(n.extensionsUsed)for(let h=0;h<n.extensionsUsed.length;++h){const d=n.extensionsUsed[h],u=n.extensionsRequired||[];switch(d){case A.KHR_MATERIALS_UNLIT:o[d]=new uo;break;case A.KHR_DRACO_MESH_COMPRESSION:o[d]=new Co(n,this.dracoLoader);break;case A.KHR_TEXTURE_TRANSFORM:o[d]=new Po;break;case A.KHR_MESH_QUANTIZATION:o[d]=new Lo;break;default:u.indexOf(d)>=0&&a[d]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+d+'".')}}c.setExtensions(o),c.setPlugins(a),c.parse(s,i)}parseAsync(e,t){const s=this;return new Promise(function(i,n){s.parse(e,t,i,n)})}}function co(){let r={};return{get:function(e){return r[e]},add:function(e,t){r[e]=t},remove:function(e){delete r[e]},removeAll:function(){r={}}}}const A={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class ho{constructor(e){this.parser=e,this.name=A.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,i=t.length;s<i;s++){const n=t[s];n.extensions&&n.extensions[this.name]&&n.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let i=t.cache.get(s);if(i)return i;const n=t.json,l=((n.extensions&&n.extensions[this.name]||{}).lights||[])[e];let c;const h=new Se(16777215);l.color!==void 0&&h.setRGB(l.color[0],l.color[1],l.color[2],Me);const d=l.range!==void 0?l.range:0;switch(l.type){case"directional":c=new Mi(h),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new Si(h),c.distance=d;break;case"spot":c=new En(h),c.distance=d,l.spot=l.spot||{},l.spot.innerConeAngle=l.spot.innerConeAngle!==void 0?l.spot.innerConeAngle:0,l.spot.outerConeAngle=l.spot.outerConeAngle!==void 0?l.spot.outerConeAngle:Math.PI/4,c.angle=l.spot.outerConeAngle,c.penumbra=1-l.spot.innerConeAngle/l.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+l.type)}return c.position.set(0,0,0),pe(c,l),l.intensity!==void 0&&(c.intensity=l.intensity),c.name=t.createUniqueName(l.name||"light_"+e),i=Promise.resolve(c),t.cache.add(s,i),i}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,n=s.json.nodes[e],a=(n.extensions&&n.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(l){return s._getNodeRef(t.cache,a,l)})}}class uo{constructor(){this.name=A.KHR_MATERIALS_UNLIT}getMaterialType(){return K}extendParams(e,t,s){const i=[];e.color=new Se(1,1,1),e.opacity=1;const n=t.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){const o=n.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],Me),e.opacity=o[3]}n.baseColorTexture!==void 0&&i.push(s.assignTexture(e,"map",n.baseColorTexture,je))}return Promise.all(i)}}class mo{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name].emissiveStrength;return n!==void 0&&(t.emissiveIntensity=n),Promise.resolve()}}class po{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ge}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],o=i.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&n.push(s.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&n.push(s.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(n.push(s.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const a=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Ti(a,a)}return Promise.all(n)}}class fo{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_DISPERSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ge}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return t.dispersion=n.dispersion!==void 0?n.dispersion:0,Promise.resolve()}}class go{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ge}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],o=i.extensions[this.name];return o.iridescenceFactor!==void 0&&(t.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&n.push(s.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(t.iridescenceIOR=o.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&n.push(s.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(n)}}class yo{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_SHEEN}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ge}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[];t.sheenColor=new Se(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=i.extensions[this.name];if(o.sheenColorFactor!==void 0){const a=o.sheenColorFactor;t.sheenColor.setRGB(a[0],a[1],a[2],Me)}return o.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&n.push(s.assignTexture(t,"sheenColorMap",o.sheenColorTexture,je)),o.sheenRoughnessTexture!==void 0&&n.push(s.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(n)}}class wo{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ge}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],o=i.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&n.push(s.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(n)}}class _o{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_VOLUME}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ge}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],o=i.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&n.push(s.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const a=o.attenuationColor||[1,1,1];return t.attenuationColor=new Se().setRGB(a[0],a[1],a[2],Me),Promise.all(n)}}class vo{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_IOR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ge}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return t.ior=n.ior!==void 0?n.ior:1.5,Promise.resolve()}}class bo{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_SPECULAR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ge}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],o=i.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&n.push(s.assignTexture(t,"specularIntensityMap",o.specularTexture));const a=o.specularColorFactor||[1,1,1];return t.specularColor=new Se().setRGB(a[0],a[1],a[2],Me),o.specularColorTexture!==void 0&&n.push(s.assignTexture(t,"specularColorMap",o.specularColorTexture,je)),Promise.all(n)}}class To{constructor(e){this.parser=e,this.name=A.EXT_MATERIALS_BUMP}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ge}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],o=i.extensions[this.name];return t.bumpScale=o.bumpFactor!==void 0?o.bumpFactor:1,o.bumpTexture!==void 0&&n.push(s.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(n)}}class So{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:ge}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],o=i.extensions[this.name];return o.anisotropyStrength!==void 0&&(t.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(t.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&n.push(s.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(n)}}class Mo{constructor(e){this.parser=e,this.name=A.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,i=s.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const n=i.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,n.source,o)}}class Eo{constructor(e){this.parser=e,this.name=A.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,s=this.parser,i=s.json,n=i.textures[e];if(!n.extensions||!n.extensions[t])return null;const o=n.extensions[t],a=i.images[o.source];let l=s.textureLoader;if(a.uri){const c=s.options.manager.getHandler(a.uri);c!==null&&(l=c)}return s.loadTextureImage(e,o.source,l)}}class xo{constructor(e){this.parser=e,this.name=A.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,s=this.parser,i=s.json,n=i.textures[e];if(!n.extensions||!n.extensions[t])return null;const o=n.extensions[t],a=i.images[o.source];let l=s.textureLoader;if(a.uri){const c=s.options.manager.getHandler(a.uri);c!==null&&(l=c)}return s.loadTextureImage(e,o.source,l)}}class Ao{constructor(e){this.name=A.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const i=s.extensions[this.name],n=this.parser.getDependency("buffer",i.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then(function(a){const l=i.byteOffset||0,c=i.byteLength||0,h=i.count,d=i.byteStride,u=new Uint8Array(a,l,c);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(h,d,u,i.mode,i.filter).then(function(p){return p.buffer}):o.ready.then(function(){const p=new ArrayBuffer(h*d);return o.decodeGltfBuffer(new Uint8Array(p),h,d,u,i.mode,i.filter),p})})}else return null}}class Io{constructor(e){this.name=A.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||s.mesh===void 0)return null;const i=t.meshes[s.mesh];for(const c of i.primitives)if(c.mode!==ae.TRIANGLES&&c.mode!==ae.TRIANGLE_STRIP&&c.mode!==ae.TRIANGLE_FAN&&c.mode!==void 0)return null;const o=s.extensions[this.name].attributes,a=[],l={};for(const c in o)a.push(this.parser.getDependency("accessor",o[c]).then(h=>(l[c]=h,l[c])));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then(c=>{const h=c.pop(),d=h.isGroup?h.children:[h],u=c[0].count,p=[];for(const y of d){const m=new O,f=new S,_=new vs,M=new S(1,1,1),E=new xn(y.geometry,y.material,u);for(let T=0;T<u;T++)l.TRANSLATION&&f.fromBufferAttribute(l.TRANSLATION,T),l.ROTATION&&_.fromBufferAttribute(l.ROTATION,T),l.SCALE&&M.fromBufferAttribute(l.SCALE,T),E.setMatrixAt(T,m.compose(f,_,M));for(const T in l)if(T==="_COLOR_0"){const I=l[T];E.instanceColor=new An(I.array,I.itemSize,I.normalized)}else T!=="TRANSLATION"&&T!=="ROTATION"&&T!=="SCALE"&&y.geometry.setAttribute(T,l[T]);fe.prototype.copy.call(E,y),this.parser.assignFinalMaterial(E),p.push(E)}return h.isGroup?(h.clear(),h.add(...p),h):p[0]}))}}const Oi="glTF",et=12,Hs={JSON:1313821514,BIN:5130562};class Ro{constructor(e){this.name=A.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,et),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Oi)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-et,n=new DataView(e,et);let o=0;for(;o<i;){const a=n.getUint32(o,!0);o+=4;const l=n.getUint32(o,!0);if(o+=4,l===Hs.JSON){const c=new Uint8Array(e,et+o,a);this.content=s.decode(c)}else if(l===Hs.BIN){const c=et+o;this.body=e.slice(c,c+a)}o+=a}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Co{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=A.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,i=this.dracoLoader,n=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,a={},l={},c={};for(const h in o){const d=hs[h]||h.toLowerCase();a[d]=o[h]}for(const h in e.attributes){const d=hs[h]||h.toLowerCase();if(o[h]!==void 0){const u=s.accessors[e.attributes[h]],p=We[u.componentType];c[d]=p.name,l[d]=u.normalized===!0}}return t.getDependency("bufferView",n).then(function(h){return new Promise(function(d,u){i.decodeDracoFile(h,function(p){for(const y in p.attributes){const m=p.attributes[y],f=l[y];f!==void 0&&(m.normalized=f)}d(p)},a,c,Me,u)})})}}class Po{constructor(){this.name=A.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Lo{constructor(){this.name=A.KHR_MESH_QUANTIZATION}}class Fi extends Kn{constructor(e,t,s,i){super(e,t,s,i)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,i=this.valueSize,n=e*i*3+i;for(let o=0;o!==i;o++)t[o]=s[n+o];return t}interpolate_(e,t,s,i){const n=this.resultBuffer,o=this.sampleValues,a=this.valueSize,l=a*2,c=a*3,h=i-t,d=(s-t)/h,u=d*d,p=u*d,y=e*c,m=y-c,f=-2*p+3*u,_=p-u,M=1-f,E=_-u+d;for(let T=0;T!==a;T++){const I=o[m+T+a],G=o[m+T+l]*h,B=o[y+T+a],$=o[y+T]*h;n[T]=M*I+E*G+f*B+_*$}return n}}const ko=new vs;class Do extends Fi{interpolate_(e,t,s,i){const n=super.interpolate_(e,t,s,i);return ko.fromArray(n).normalize().toArray(n),n}}const ae={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},We={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},zs={9728:xi,9729:cs,9984:Ln,9985:Pn,9986:Cn,9987:Ei},Us={33071:Dn,33648:kn,10497:ke},Xt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},hs={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Ae={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Oo={CUBICSPLINE:void 0,LINEAR:Ri,STEP:Wn},qt={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Fo(r){return r.DefaultMaterial===void 0&&(r.DefaultMaterial=new R({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:jn})),r.DefaultMaterial}function Le(r,e,t){for(const s in t.extensions)r[s]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[s]=t.extensions[s])}function pe(r,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(r.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function No(r,e,t){let s=!1,i=!1,n=!1;for(let c=0,h=e.length;c<h;c++){const d=e[c];if(d.POSITION!==void 0&&(s=!0),d.NORMAL!==void 0&&(i=!0),d.COLOR_0!==void 0&&(n=!0),s&&i&&n)break}if(!s&&!i&&!n)return Promise.resolve(r);const o=[],a=[],l=[];for(let c=0,h=e.length;c<h;c++){const d=e[c];if(s){const u=d.POSITION!==void 0?t.getDependency("accessor",d.POSITION):r.attributes.position;o.push(u)}if(i){const u=d.NORMAL!==void 0?t.getDependency("accessor",d.NORMAL):r.attributes.normal;a.push(u)}if(n){const u=d.COLOR_0!==void 0?t.getDependency("accessor",d.COLOR_0):r.attributes.color;l.push(u)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l)]).then(function(c){const h=c[0],d=c[1],u=c[2];return s&&(r.morphAttributes.position=h),i&&(r.morphAttributes.normal=d),n&&(r.morphAttributes.color=u),r.morphTargetsRelative=!0,r})}function Bo(r,e){if(r.updateMorphTargets(),e.weights!==void 0)for(let t=0,s=e.weights.length;t<s;t++)r.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(r.morphTargetInfluences.length===t.length){r.morphTargetDictionary={};for(let s=0,i=t.length;s<i;s++)r.morphTargetDictionary[t[s]]=s}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Ho(r){let e;const t=r.extensions&&r.extensions[A.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Qt(t.attributes):e=r.indices+":"+Qt(r.attributes)+":"+r.mode,r.targets!==void 0)for(let s=0,i=r.targets.length;s<i;s++)e+=":"+Qt(r.targets[s]);return e}function Qt(r){let e="";const t=Object.keys(r).sort();for(let s=0,i=t.length;s<i;s++)e+=t[s]+":"+r[t[s]]+";";return e}function ds(r){switch(r){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function zo(r){return r.search(/\.jpe?g($|\?)/i)>0||r.search(/^data\:image\/jpeg/)===0?"image/jpeg":r.search(/\.webp($|\?)/i)>0||r.search(/^data\:image\/webp/)===0?"image/webp":r.search(/\.ktx2($|\?)/i)>0||r.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const Uo=new O;class Go{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new co,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,i=-1,n=!1,o=-1;if(typeof navigator<"u"){const a=navigator.userAgent;s=/^((?!chrome|android).)*safari/i.test(a)===!0;const l=a.match(/Version\/(\d+)/);i=s&&l?parseInt(l[1],10):-1,n=a.indexOf("Firefox")>-1,o=n?a.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||s&&i<17||n&&o<98?this.textureLoader=new _t(this.options.manager):this.textureLoader=new In(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new bi(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,i=this.json,n=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(o){const a={scene:o[0][i.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:i.asset,parser:s,userData:{}};return Le(n,a,i),pe(a,i),Promise.all(s._invokeAll(function(l){return l.afterRoot&&l.afterRoot(a)})).then(function(){for(const l of a.scenes)l.updateMatrixWorld();e(a)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let i=0,n=t.length;i<n;i++){const o=t[i].joints;for(let a=0,l=o.length;a<l;a++)e[o[a]].isBone=!0}for(let i=0,n=e.length;i<n;i++){const o=e[i];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(s[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const i=s.clone(),n=(o,a)=>{const l=this.associations.get(o);l!=null&&this.associations.set(a,l);for(const[c,h]of o.children.entries())n(h,a.children[c])};return n(s,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const i=e(t[s]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let i=0;i<t.length;i++){const n=e(t[i]);n&&s.push(n)}return s}getDependency(e,t){const s=e+":"+t;let i=this.cache.get(s);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne(function(n){return n.loadNode&&n.loadNode(t)});break;case"mesh":i=this._invokeOne(function(n){return n.loadMesh&&n.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(n){return n.loadBufferView&&n.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(n){return n.loadMaterial&&n.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(n){return n.loadTexture&&n.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne(function(n){return n.loadAnimation&&n.loadAnimation(t)});break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)}),!i)throw new Error("Unknown type: "+e);break}this.cache.add(s,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,i=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(i.map(function(n,o){return s.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[A.KHR_BINARY_GLTF].body);const i=this.options;return new Promise(function(n,o){s.load(dt.resolveURL(t.uri,i.path),n,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(s){const i=t.byteLength||0,n=t.byteOffset||0;return s.slice(n,n+i)})}loadAccessor(e){const t=this,s=this.json,i=this.json.accessors[e];if(i.bufferView===void 0&&i.sparse===void 0){const o=Xt[i.type],a=We[i.componentType],l=i.normalized===!0,c=new a(i.count*o);return Promise.resolve(new Dt(c,o,l))}const n=[];return i.bufferView!==void 0?n.push(this.getDependency("bufferView",i.bufferView)):n.push(null),i.sparse!==void 0&&(n.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),n.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(n).then(function(o){const a=o[0],l=Xt[i.type],c=We[i.componentType],h=c.BYTES_PER_ELEMENT,d=h*l,u=i.byteOffset||0,p=i.bufferView!==void 0?s.bufferViews[i.bufferView].byteStride:void 0,y=i.normalized===!0;let m,f;if(p&&p!==d){const _=Math.floor(u/p),M="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+_+":"+i.count;let E=t.cache.get(M);E||(m=new c(a,_*p,i.count*p/h),E=new Rn(m,p/h),t.cache.add(M,E)),f=new Vn(E,l,u%p/h,y)}else a===null?m=new c(i.count*l):m=new c(a,u,i.count*l),f=new Dt(m,l,y);if(i.sparse!==void 0){const _=Xt.SCALAR,M=We[i.sparse.indices.componentType],E=i.sparse.indices.byteOffset||0,T=i.sparse.values.byteOffset||0,I=new M(o[1],E,i.sparse.count*_),G=new c(o[2],T,i.sparse.count*l);a!==null&&(f=new Dt(f.array.slice(),f.itemSize,f.normalized)),f.normalized=!1;for(let B=0,$=I.length;B<$;B++){const Y=I[B];if(f.setX(Y,G[B*l]),l>=2&&f.setY(Y,G[B*l+1]),l>=3&&f.setZ(Y,G[B*l+2]),l>=4&&f.setW(Y,G[B*l+3]),l>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}f.normalized=y}return f})}loadTexture(e){const t=this.json,s=this.options,n=t.textures[e].source,o=t.images[n];let a=this.textureLoader;if(o.uri){const l=s.manager.getHandler(o.uri);l!==null&&(a=l)}return this.loadTextureImage(e,n,a)}loadTextureImage(e,t,s){const i=this,n=this.json,o=n.textures[e],a=n.images[t],l=(a.uri||a.bufferView)+":"+o.sampler;if(this.textureCache[l])return this.textureCache[l];const c=this.loadImageSource(t,s).then(function(h){h.flipY=!1,h.name=o.name||a.name||"",h.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(h.name=a.uri);const u=(n.samplers||{})[o.sampler]||{};return h.magFilter=zs[u.magFilter]||cs,h.minFilter=zs[u.minFilter]||Ei,h.wrapS=Us[u.wrapS]||ke,h.wrapT=Us[u.wrapT]||ke,h.generateMipmaps=!h.isCompressedTexture&&h.minFilter!==xi&&h.minFilter!==cs,i.associations.set(h,{textures:e}),h}).catch(function(){return null});return this.textureCache[l]=c,c}loadImageSource(e,t){const s=this,i=this.json,n=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(d=>d.clone());const o=i.images[e],a=self.URL||self.webkitURL;let l=o.uri||"",c=!1;if(o.bufferView!==void 0)l=s.getDependency("bufferView",o.bufferView).then(function(d){c=!0;const u=new Blob([d],{type:o.mimeType});return l=a.createObjectURL(u),l});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(l).then(function(d){return new Promise(function(u,p){let y=u;t.isImageBitmapLoader===!0&&(y=function(m){const f=new Ls(m);f.needsUpdate=!0,u(f)}),t.load(dt.resolveURL(d,n.path),y,void 0,p)})}).then(function(d){return c===!0&&a.revokeObjectURL(l),pe(d,o),d.userData.mimeType=o.mimeType||zo(o.uri),d}).catch(function(d){throw console.error("THREE.GLTFLoader: Couldn't load texture",l),d});return this.sourceCache[e]=h,h}assignTexture(e,t,s,i){const n=this;return this.getDependency("texture",s.index).then(function(o){if(!o)return null;if(s.texCoord!==void 0&&s.texCoord>0&&(o=o.clone(),o.channel=s.texCoord),n.extensions[A.KHR_TEXTURE_TRANSFORM]){const a=s.extensions!==void 0?s.extensions[A.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const l=n.associations.get(o);o=n.extensions[A.KHR_TEXTURE_TRANSFORM].extendTexture(o,a),n.associations.set(o,l)}}return i!==void 0&&(o.colorSpace=i),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const i=t.attributes.tangent===void 0,n=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+s.uuid;let l=this.cache.get(a);l||(l=new On,Yt.prototype.copy.call(l,s),l.color.copy(s.color),l.map=s.map,l.sizeAttenuation=!1,this.cache.add(a,l)),s=l}else if(e.isLine){const a="LineBasicMaterial:"+s.uuid;let l=this.cache.get(a);l||(l=new Ge,Yt.prototype.copy.call(l,s),l.color.copy(s.color),l.map=s.map,this.cache.add(a,l)),s=l}if(i||n||o){let a="ClonedMaterial:"+s.uuid+":";i&&(a+="derivative-tangents:"),n&&(a+="vertex-colors:"),o&&(a+="flat-shading:");let l=this.cache.get(a);l||(l=s.clone(),n&&(l.vertexColors=!0),o&&(l.flatShading=!0),i&&(l.normalScale&&(l.normalScale.y*=-1),l.clearcoatNormalScale&&(l.clearcoatNormalScale.y*=-1)),this.cache.add(a,l),this.associations.set(l,this.associations.get(s))),s=l}e.material=s}getMaterialType(){return R}loadMaterial(e){const t=this,s=this.json,i=this.extensions,n=s.materials[e];let o;const a={},l=n.extensions||{},c=[];if(l[A.KHR_MATERIALS_UNLIT]){const d=i[A.KHR_MATERIALS_UNLIT];o=d.getMaterialType(),c.push(d.extendParams(a,n,t))}else{const d=n.pbrMetallicRoughness||{};if(a.color=new Se(1,1,1),a.opacity=1,Array.isArray(d.baseColorFactor)){const u=d.baseColorFactor;a.color.setRGB(u[0],u[1],u[2],Me),a.opacity=u[3]}d.baseColorTexture!==void 0&&c.push(t.assignTexture(a,"map",d.baseColorTexture,je)),a.metalness=d.metallicFactor!==void 0?d.metallicFactor:1,a.roughness=d.roughnessFactor!==void 0?d.roughnessFactor:1,d.metallicRoughnessTexture!==void 0&&(c.push(t.assignTexture(a,"metalnessMap",d.metallicRoughnessTexture)),c.push(t.assignTexture(a,"roughnessMap",d.metallicRoughnessTexture))),o=this._invokeOne(function(u){return u.getMaterialType&&u.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(u){return u.extendMaterialParams&&u.extendMaterialParams(e,a)})))}n.doubleSided===!0&&(a.side=Wt);const h=n.alphaMode||qt.OPAQUE;if(h===qt.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,h===qt.MASK&&(a.alphaTest=n.alphaCutoff!==void 0?n.alphaCutoff:.5)),n.normalTexture!==void 0&&o!==K&&(c.push(t.assignTexture(a,"normalMap",n.normalTexture)),a.normalScale=new Ti(1,1),n.normalTexture.scale!==void 0)){const d=n.normalTexture.scale;a.normalScale.set(d,d)}if(n.occlusionTexture!==void 0&&o!==K&&(c.push(t.assignTexture(a,"aoMap",n.occlusionTexture)),n.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=n.occlusionTexture.strength)),n.emissiveFactor!==void 0&&o!==K){const d=n.emissiveFactor;a.emissive=new Se().setRGB(d[0],d[1],d[2],Me)}return n.emissiveTexture!==void 0&&o!==K&&c.push(t.assignTexture(a,"emissiveMap",n.emissiveTexture,je)),Promise.all(c).then(function(){const d=new o(a);return n.name&&(d.name=n.name),pe(d,n),t.associations.set(d,{materials:e}),n.extensions&&Le(i,d,n),d})}createUniqueName(e){const t=Fn.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,i=this.primitiveCache;function n(a){return s[A.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,t).then(function(l){return Gs(l,a,t)})}const o=[];for(let a=0,l=e.length;a<l;a++){const c=e[a],h=Ho(c),d=i[h];if(d)o.push(d.promise);else{let u;c.extensions&&c.extensions[A.KHR_DRACO_MESH_COMPRESSION]?u=n(c):u=Gs(new Ie,c,t),i[h]={primitive:c,promise:u},o.push(u)}}return Promise.all(o)}loadMesh(e){const t=this,s=this.json,i=this.extensions,n=s.meshes[e],o=n.primitives,a=[];for(let l=0,c=o.length;l<c;l++){const h=o[l].material===void 0?Fo(this.cache):this.getDependency("material",o[l].material);a.push(h)}return a.push(t.loadGeometries(o)),Promise.all(a).then(function(l){const c=l.slice(0,l.length-1),h=l[l.length-1],d=[];for(let p=0,y=h.length;p<y;p++){const m=h[p],f=o[p];let _;const M=c[p];if(f.mode===ae.TRIANGLES||f.mode===ae.TRIANGLE_STRIP||f.mode===ae.TRIANGLE_FAN||f.mode===void 0)_=n.isSkinnedMesh===!0?new Nn(m,M):new x(m,M),_.isSkinnedMesh===!0&&_.normalizeSkinWeights(),f.mode===ae.TRIANGLE_STRIP?_.geometry=Bs(_.geometry,vi):f.mode===ae.TRIANGLE_FAN&&(_.geometry=Bs(_.geometry,ls));else if(f.mode===ae.LINES)_=new pt(m,M);else if(f.mode===ae.LINE_STRIP)_=new Ai(m,M);else if(f.mode===ae.LINE_LOOP)_=new Bn(m,M);else if(f.mode===ae.POINTS)_=new Hn(m,M);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+f.mode);Object.keys(_.geometry.morphAttributes).length>0&&Bo(_,n),_.name=t.createUniqueName(n.name||"mesh_"+e),pe(_,n),f.extensions&&Le(i,_,f),t.assignFinalMaterial(_),d.push(_)}for(let p=0,y=d.length;p<y;p++)t.associations.set(d[p],{meshes:e,primitives:p});if(d.length===1)return n.extensions&&Le(i,d[0],n),d[0];const u=new X;n.extensions&&Le(i,u,n),t.associations.set(u,{meshes:e});for(let p=0,y=d.length;p<y;p++)u.add(d[p]);return u})}loadCamera(e){let t;const s=this.json.cameras[e],i=s[s.type];if(!i){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return s.type==="perspective"?t=new bs(J.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):s.type==="orthographic"&&(t=new Ii(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),pe(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let i=0,n=t.joints.length;i<n;i++)s.push(this._loadNodeShallow(t.joints[i]));return t.inverseBindMatrices!==void 0?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(i){const n=i.pop(),o=i,a=[],l=[];for(let c=0,h=o.length;c<h;c++){const d=o[c];if(d){a.push(d);const u=new O;n!==null&&u.fromArray(n.array,c*16),l.push(u)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[c])}return new zn(a,l)})}loadAnimation(e){const t=this.json,s=this,i=t.animations[e],n=i.name?i.name:"animation_"+e,o=[],a=[],l=[],c=[],h=[];for(let d=0,u=i.channels.length;d<u;d++){const p=i.channels[d],y=i.samplers[p.sampler],m=p.target,f=m.node,_=i.parameters!==void 0?i.parameters[y.input]:y.input,M=i.parameters!==void 0?i.parameters[y.output]:y.output;m.node!==void 0&&(o.push(this.getDependency("node",f)),a.push(this.getDependency("accessor",_)),l.push(this.getDependency("accessor",M)),c.push(y),h.push(m))}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(h)]).then(function(d){const u=d[0],p=d[1],y=d[2],m=d[3],f=d[4],_=[];for(let E=0,T=u.length;E<T;E++){const I=u[E],G=p[E],B=y[E],$=m[E],Y=f[E];if(I===void 0)continue;I.updateMatrix&&I.updateMatrix();const Ee=s._createAnimationTracks(I,G,B,$,Y);if(Ee)for(let $e=0;$e<Ee.length;$e++)_.push(Ee[$e])}const M=new Un(n,void 0,_);return pe(M,i),M})}createNodeMesh(e){const t=this.json,s=this,i=t.nodes[e];return i.mesh===void 0?null:s.getDependency("mesh",i.mesh).then(function(n){const o=s._getNodeRef(s.meshCache,i.mesh,n);return i.weights!==void 0&&o.traverse(function(a){if(a.isMesh)for(let l=0,c=i.weights.length;l<c;l++)a.morphTargetInfluences[l]=i.weights[l]}),o})}loadNode(e){const t=this.json,s=this,i=t.nodes[e],n=s._loadNodeShallow(e),o=[],a=i.children||[];for(let c=0,h=a.length;c<h;c++)o.push(s.getDependency("node",a[c]));const l=i.skin===void 0?Promise.resolve(null):s.getDependency("skin",i.skin);return Promise.all([n,Promise.all(o),l]).then(function(c){const h=c[0],d=c[1],u=c[2];u!==null&&h.traverse(function(p){p.isSkinnedMesh&&p.bind(u,Uo)});for(let p=0,y=d.length;p<y;p++)h.add(d[p]);return h})}_loadNodeShallow(e){const t=this.json,s=this.extensions,i=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const n=t.nodes[e],o=n.name?i.createUniqueName(n.name):"",a=[],l=i._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(e)});return l&&a.push(l),n.camera!==void 0&&a.push(i.getDependency("camera",n.camera).then(function(c){return i._getNodeRef(i.cameraCache,n.camera,c)})),i._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(e)}).forEach(function(c){a.push(c)}),this.nodeCache[e]=Promise.all(a).then(function(c){let h;if(n.isBone===!0?h=new Gn:c.length>1?h=new X:c.length===1?h=c[0]:h=new fe,h!==c[0])for(let d=0,u=c.length;d<u;d++)h.add(c[d]);if(n.name&&(h.userData.name=n.name,h.name=o),pe(h,n),n.extensions&&Le(s,h,n),n.matrix!==void 0){const d=new O;d.fromArray(n.matrix),h.applyMatrix4(d)}else n.translation!==void 0&&h.position.fromArray(n.translation),n.rotation!==void 0&&h.quaternion.fromArray(n.rotation),n.scale!==void 0&&h.scale.fromArray(n.scale);if(!i.associations.has(h))i.associations.set(h,{});else if(n.mesh!==void 0&&i.meshCache.refs[n.mesh]>1){const d=i.associations.get(h);i.associations.set(h,{...d})}return i.associations.get(h).nodes=e,h}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],i=this,n=new X;s.name&&(n.name=i.createUniqueName(s.name)),pe(n,s),s.extensions&&Le(t,n,s);const o=s.nodes||[],a=[];for(let l=0,c=o.length;l<c;l++)a.push(i.getDependency("node",o[l]));return Promise.all(a).then(function(l){for(let h=0,d=l.length;h<d;h++)n.add(l[h]);const c=h=>{const d=new Map;for(const[u,p]of i.associations)(u instanceof Yt||u instanceof Ls)&&d.set(u,p);return h.traverse(u=>{const p=i.associations.get(u);p!=null&&d.set(u,p)}),d};return i.associations=c(n),n})}_createAnimationTracks(e,t,s,i,n){const o=[],a=e.name?e.name:e.uuid,l=[];Ae[n.path]===Ae.weights?e.traverse(function(u){u.morphTargetInfluences&&l.push(u.name?u.name:u.uuid)}):l.push(a);let c;switch(Ae[n.path]){case Ae.weights:c=Ds;break;case Ae.rotation:c=Os;break;case Ae.translation:case Ae.scale:c=ks;break;default:switch(s.itemSize){case 1:c=Ds;break;case 2:case 3:default:c=ks;break}break}const h=i.interpolation!==void 0?Oo[i.interpolation]:Ri,d=this._getArrayFromAccessor(s);for(let u=0,p=l.length;u<p;u++){const y=new c(l[u]+"."+Ae[n.path],t.array,d,h);i.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(y),o.push(y)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const s=ds(t.constructor),i=new Float32Array(t.length);for(let n=0,o=t.length;n<o;n++)i[n]=t[n]*s;t=i}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(s){const i=this instanceof Os?Do:Fi;return new i(this.times,this.values,this.getValueSize()/3,s)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Wo(r,e,t){const s=e.attributes,i=new $n;if(s.POSITION!==void 0){const a=t.json.accessors[s.POSITION],l=a.min,c=a.max;if(l!==void 0&&c!==void 0){if(i.set(new S(l[0],l[1],l[2]),new S(c[0],c[1],c[2])),a.normalized){const h=ds(We[a.componentType]);i.min.multiplyScalar(h),i.max.multiplyScalar(h)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const n=e.targets;if(n!==void 0){const a=new S,l=new S;for(let c=0,h=n.length;c<h;c++){const d=n[c];if(d.POSITION!==void 0){const u=t.json.accessors[d.POSITION],p=u.min,y=u.max;if(p!==void 0&&y!==void 0){if(l.setX(Math.max(Math.abs(p[0]),Math.abs(y[0]))),l.setY(Math.max(Math.abs(p[1]),Math.abs(y[1]))),l.setZ(Math.max(Math.abs(p[2]),Math.abs(y[2]))),u.normalized){const m=ds(We[u.componentType]);l.multiplyScalar(m)}a.max(l)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(a)}r.boundingBox=i;const o=new Yn;i.getCenter(o.center),o.radius=i.min.distanceTo(i.max)/2,r.boundingSphere=o}function Gs(r,e,t){const s=e.attributes,i=[];function n(o,a){return t.getDependency("accessor",o).then(function(l){r.setAttribute(a,l)})}for(const o in s){const a=hs[o]||o.toLowerCase();a in r.attributes||i.push(n(s[o],a))}if(e.indices!==void 0&&!r.index){const o=t.getDependency("accessor",e.indices).then(function(a){r.setIndex(a)});i.push(o)}return Fs.workingColorSpace!==Me&&"COLOR_0"in s&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Fs.workingColorSpace}" not supported.`),pe(r,e),Wo(r,e,t),Promise.all(i).then(function(){return e.targets!==void 0?No(r,e.targets,t):r})}const w={AUDIO:{VOLUME_IMPACT:.2},PLAYER:{BOUNDING_RADIUS:.5,DYING_TIME:3,HEAD_HEIGHT:1.7,MAX_HEALTH:100,MAX_SPEED:6},CONTROLS:{LOOKING_SPEED:2,BRAKING_POWER:10,HEAD_MOVEMENT:1.2,WEAPON_MOVEMENT:1.2},HEALTH_PACK:{HEALTH:50,RESPAWN_TIME:10,RADIUS:1},BOT:{MOVEMENT:{MAX_SPEED:3,DODGE_SIZE:4},GOAL:{ITEM_VISIBILITY_UPDATE_FREQUENCY:1},MEMORY:{SPAN:20},NAVIGATION:{NEXT_WAYPOINT_DISTANCE:.5,ARRIVE_DECELERATION:2,ARRIVE_TOLERANCE:1,PATH_RADIUS:.1,ONPATH_WEIGHT:1},TARGET_SYSTEM:{UPDATE_FREQUENCY:5},VISION:{UPDATE_FREQUENCY:5,FOV:140,RANGE:40},WEAPON:{UPDATE_FREQUENCY:4,REACTION_TIME:1,AIM_ACCURACY:3,CHANGE_COST:.5,NOISE_MAX_DISTANCE:100},BOUNDING_RADIUS:.5,COUNT:3,HEAD_HEIGHT:1.5,MAX_HEALTH:100,DYING_TIME:3,SEARCH_FOR_ATTACKER_TIME:3,MIN_ITEM_RANGE:2,MAX_ITEM_RANGE:25,IGNORE_ITEMS_TIMEOUT:30,GOAL_ARBITRATION_FREQUENCY:5},BLASTER:{ROUNDS_LEFT:12,ROUNDS_PER_CLIP:12,AMMO:48,MAX_AMMO:48,SHOT_TIME:.4,RELOAD_TIME:1.6,MUZZLE_TIME:.04,EQUIP_TIME:.5,HIDE_TIME:.5,RESPAWN_TIME:10,RADIUS:1},SHOTGUN:{ROUNDS_LEFT:6,ROUNDS_PER_CLIP:6,AMMO:24,MAX_AMMO:24,SHOT_TIME:1.2,RELOAD_TIME:1.6,SHOT_RELOAD_TIME:.5,MUZZLE_TIME:.04,EQUIP_TIME:1,HIDE_TIME:1,SPREAD:.05,BULLETS_PER_SHOT:6,RESPAWN_TIME:10,RADIUS:1},ASSAULT_RIFLE:{ROUNDS_LEFT:30,ROUNDS_PER_CLIP:30,AMMO:90,MAX_AMMO:90,SHOT_TIME:.2,RELOAD_TIME:1.6,MUZZLE_TIME:.04,EQUIP_TIME:1,HIDE_TIME:1,RESPAWN_TIME:10,RADIUS:1},BULLET:{MAX_SPEED:400,LIFETIME:1,DAMAGE:20},UI:{CROSSHAIRS:{HIT_TIME:.3,OPACITY:.5,SCALE:40},DAMAGE_INDICATOR:{OPACITY:.5,SCALE:256,TIME:.5},FRAGS:{TIME:5}},NAVMESH:{HEIGHT_CHANGE_FACTOR:.2}};class Vo{constructor(){this.loadingManager=new Xn,this.animationLoader=new qn(this.loadingManager),this.audioLoader=new Ts(this.loadingManager),this.textureLoader=new _t(this.loadingManager),this.gltfLoader=new lo(this.loadingManager),this.navMeshLoader=new tn,this.listener=new Ci,this.animations=new Map,this.audios=new Map,this.configs=new Map,this.models=new Map,this.textures=new Map,this.navMesh=null,this.costTable=null}init(){return this._loadAnimations(),this._loadAudios(),this._loadConfigs(),this._loadModels(),this._loadTextures(),this._loadNavMesh(),new Promise(e=>{this.loadingManager.onLoad=()=>{e(void 0)}})}cloneAudio(e){const t=new F(e.listener);return t.buffer=e.buffer,t}_loadAnimations(){const e=this.animationLoader;return e.load("./assets/animations/player.json",t=>{for(const s of t)this.animations.set(s.name,s)}),e.load("./assets/animations/blaster.json",t=>{for(const s of t)this.animations.set(s.name,s)}),e.load("./assets/animations/shotgun.json",t=>{for(const s of t)this.animations.set(s.name,s)}),e.load("./assets/animations/assaultRifle.json",t=>{for(const s of t)this.animations.set(s.name,s)}),this}_loadAudios(){const e=this.audioLoader,t=this.audios,s=this.listener,i=new F(s);i.matrixAutoUpdate=!1;const n=new F(s);n.matrixAutoUpdate=!1;const o=new F(s);o.matrixAutoUpdate=!1;const a=new F(s);a.matrixAutoUpdate=!1;const l=new F(s);l.matrixAutoUpdate=!1;const c=new F(s);c.matrixAutoUpdate=!1;const h=new F(s);h.matrixAutoUpdate=!1;const d=new F(s);d.setVolume(w.AUDIO.VOLUME_IMPACT),d.matrixAutoUpdate=!1;const u=new F(s);u.setVolume(w.AUDIO.VOLUME_IMPACT),u.matrixAutoUpdate=!1;const p=new F(s);p.setVolume(w.AUDIO.VOLUME_IMPACT),p.matrixAutoUpdate=!1;const y=new F(s);y.setVolume(w.AUDIO.VOLUME_IMPACT),y.matrixAutoUpdate=!1;const m=new F(s);m.setVolume(w.AUDIO.VOLUME_IMPACT),m.matrixAutoUpdate=!1;const f=new F(s);f.setVolume(w.AUDIO.VOLUME_IMPACT),f.matrixAutoUpdate=!1;const _=new F(s);_.setVolume(w.AUDIO.VOLUME_IMPACT),_.matrixAutoUpdate=!1;const M=new F(s);M.matrixAutoUpdate=!1;const E=new F(s);return E.matrixAutoUpdate=!1,e.load("./assets/audio/sfx/weapons/blaster_shot.ogg",T=>i.setBuffer(T)),e.load("./assets/audio/sfx/weapons/shotgun_shot.ogg",T=>n.setBuffer(T)),e.load("./assets/audio/sfx/weapons/assault_rifle_shot.ogg",T=>o.setBuffer(T)),e.load("./assets/audio/sfx/weapons/reload.ogg",T=>a.setBuffer(T)),e.load("./assets/audio/sfx/weapons/shotgun_shot_reload.ogg",T=>l.setBuffer(T)),e.load("./assets/audio/sfx/player/step1.ogg",T=>c.setBuffer(T)),e.load("./assets/audio/sfx/player/step2.ogg",T=>h.setBuffer(T)),e.load("./assets/audio/sfx/impacts/impact1.ogg",T=>d.setBuffer(T)),e.load("./assets/audio/sfx/impacts/impact2.ogg",T=>u.setBuffer(T)),e.load("./assets/audio/sfx/impacts/impact3.ogg",T=>p.setBuffer(T)),e.load("./assets/audio/sfx/impacts/impact4.ogg",T=>y.setBuffer(T)),e.load("./assets/audio/sfx/impacts/impact5.ogg",T=>m.setBuffer(T)),e.load("./assets/audio/sfx/impacts/impact6.ogg",T=>f.setBuffer(T)),e.load("./assets/audio/sfx/impacts/impact7.ogg",T=>_.setBuffer(T)),e.load("./assets/audio/sfx/ui/health.ogg",T=>M.setBuffer(T)),e.load("./assets/audio/sfx/ui/ammo.ogg",T=>E.setBuffer(T)),t.set("blaster_shot",i),t.set("shotgun_shot",n),t.set("assault_rifle_shot",o),t.set("reload",a),t.set("shotgun_shot_reload",l),t.set("step1",c),t.set("step2",h),t.set("impact1",d),t.set("impact2",u),t.set("impact3",p),t.set("impact4",y),t.set("impact5",m),t.set("impact6",f),t.set("impact7",_),t.set("health",M),t.set("ammo",E),this}_loadConfigs(){const e=this.loadingManager,t=this.configs;return e.itemStart("levelConfig"),fetch("./assets/data/config/level.json").then(s=>s.json()).then(s=>{t.set("level",s),e.itemEnd("levelConfig")}),this}_loadModels(){const e=this.gltfLoader,t=this.textureLoader,s=this.models,i=this.animations,n=t.load("./assets/textures/environment/shadow.png"),o=new Ss,a=new K({map:n,transparent:!0,opacity:.4}),l=new x(o,a);l.position.set(0,.05,0),l.rotation.set(-Math.PI*.5,0,0),l.scale.multiplyScalar(2),l.matrixAutoUpdate=!1,l.updateMatrix(),e.load("./assets/models/characters/soldier.glb",m=>{const f=m.scene;f.animations=m.animations,f.matrixAutoUpdate=!1,f.updateMatrix(),f.traverse(_=>{_ instanceof x&&(_.material.side=Wt,_.matrixAutoUpdate=!1,_.updateMatrix())}),f.add(l),s.set("soldier",f);for(let _ of m.animations)i.set(_.name,_)}),e.load("./assets/models/environment/level.glb",m=>{const f=m.scene;f.matrixAutoUpdate=!1,f.updateMatrix(),f.traverse(M=>{M.matrixAutoUpdate=!1,M.updateMatrix()});const _=f.getObjectByName("level");if(_&&_.material){const M=_.material,E=(W,ye,Ye)=>{const Xe=Math.sin(W*12.9898+ye*78.233+Ye*45.164)*43758.5453;return Xe-Math.floor(Xe)},T=_.geometry,I=T.attributes.position,G=T.attributes.normal,B=new Float32Array(I.count*3);let $=1/0,Y=-1/0;for(let W=0;W<I.count;W++){I.getX(W);const ye=I.getY(W);I.getZ(W),ye<$&&($=ye),ye>Y&&(Y=ye)}const Ee=Y-$;for(let W=0;W<I.count;W++){const ye=I.getX(W),Ye=I.getY(W),Xe=I.getZ(W);let xe=.2+(Ye-$)/Ee*.6;const Zi=E(ye*.1,Ye*.1,Xe*.1);if(xe+=(Zi-.5)*.08,G){const en=(G.getY(W)+1)*.5;xe*=.7+en*.3}const Ji=E(ye*.05,Ye*.05,Xe*.05);xe+=(Ji-.5)*.05,xe=Math.max(.15,Math.min(.85,xe)),B[W*3]=xe*.98,B[W*3+1]=xe,B[W*3+2]=xe*1.02}T.setAttribute("color",new Dt(B,3));const $e=new R({vertexColors:!0,color:16777215,roughness:.9,metalness:0,flatShading:!1,envMapIntensity:.3});_.material=$e,M.dispose()}s.set("level",f)}),e.load("./assets/models/weapons/blaster_high.glb",m=>{const f=m.scene;f.matrixAutoUpdate=!1,f.updateMatrix(),f.traverse(_=>{_.matrixAutoUpdate=!1,_.updateMatrix()}),s.set("blaster_high",f)}),e.load("./assets/models/weapons/blaster_low.glb",m=>{const f=m.scene;f.matrixAutoUpdate=!1,f.updateMatrix(),f.traverse(_=>{_.matrixAutoUpdate=!1,_.updateMatrix()}),s.set("blaster_low",f)}),e.load("./assets/models/weapons/shotgun_high.glb",m=>{const f=m.scene;f.matrixAutoUpdate=!1,f.updateMatrix(),f.traverse(_=>{_.matrixAutoUpdate=!1,_.updateMatrix()}),s.set("shotgun_high",f)}),e.load("./assets/models/weapons/shotgun_low.glb",m=>{const f=m.scene;f.matrixAutoUpdate=!1,f.updateMatrix(),f.traverse(_=>{_.matrixAutoUpdate=!1,_.updateMatrix()}),s.set("shotgun_low",f)}),e.load("./assets/models/weapons/assaultRifle_high.glb",m=>{const f=m.scene;f.matrixAutoUpdate=!1,f.updateMatrix(),f.traverse(_=>{_.matrixAutoUpdate=!1,_.updateMatrix()}),s.set("assaultRifle_high",f)}),e.load("./assets/models/weapons/assaultRifle_low.glb",m=>{const f=m.scene;f.matrixAutoUpdate=!1,f.updateMatrix(),f.traverse(_=>{_.matrixAutoUpdate=!1,_.updateMatrix()}),s.set("assaultRifle_low",f)}),e.load("./assets/models/props/healthPack.glb",m=>{const f=m.scene;f.matrixAutoUpdate=!1,f.updateMatrix(),f.traverse(_=>{_.matrixAutoUpdate=!1,_.updateMatrix()}),s.set("healthPack",f)});const c=t.load("./assets/textures/effects/muzzle.png");c.matrixAutoUpdate=!1;const h=new le({map:c}),d=new te(h);d.matrixAutoUpdate=!1,d.visible=!1,s.set("muzzle",d);const u=new Ie,p=new Ge({color:16513254});u.setFromPoints([new S,new S(0,0,-1)]);const y=new pt(u,p);y.matrixAutoUpdate=!1,s.set("bulletLine",y)}_loadTextures(){const e=this.textureLoader;let t=e.load("./assets/textures/ui/crosshairs.png");return t.matrixAutoUpdate=!1,this.textures.set("crosshairs",t),t=e.load("./assets/textures/ui/damageIndicatorFront.png"),t.matrixAutoUpdate=!1,this.textures.set("damageIndicatorFront",t),t=e.load("./assets/textures/ui/damageIndicatorRight.png"),t.matrixAutoUpdate=!1,this.textures.set("damageIndicatorRight",t),t=e.load("./assets/textures/ui/damageIndicatorLeft.png"),t.matrixAutoUpdate=!1,this.textures.set("damageIndicatorLeft",t),t=e.load("./assets/textures/ui/damageIndicatorBack.png"),t.matrixAutoUpdate=!1,this.textures.set("damageIndicatorBack",t),this}_loadNavMesh(){const e=this.navMeshLoader,t=this.loadingManager;return t.itemStart("navmesh"),e.load("./assets/data/navmeshes/navmesh.glb").then(s=>{this.navMesh=s,t.itemEnd("navmesh")}),t.itemStart("costTable"),fetch("./assets/data/navmeshes/costTable.json").then(s=>s.json()).then(s=>{this.costTable=new sn().fromJSON(s),t.itemEnd("costTable")}),this}}class Ni extends Oe{constructor(e,t){super(),this.canActivateTrigger=!1,this.currentTime=0,this.nextSpawnTime=1/0,this.respawnTime=t,this.type=e,this.currentRegion=null,this._audio=null}prepareRespawn(){this.active=!1,this._renderComponent.visible=!1;const e=this._audio;return e.isPlaying===!0&&e.stop(),e.play(),this.nextSpawnTime=this.currentTime+this.respawnTime,this}finishRespawn(){return this.active=!0,this._renderComponent.visible=!0,this.nextSpawnTime=1/0,this}addItemToEntity(e){}}const ee=1,q=2,Q=3,ce=4,Es=5,xs=6,Ve=7,Vt=8,jo=9,Ko=10,us=11,V=12,Nt=13,Bt=14,gt=15,yt="HIT",ms="DEAD";class $o extends Ni{constructor(){super(gt,w.HEALTH_PACK.RESPAWN_TIME),this.health=w.HEALTH_PACK.HEALTH}addItemToEntity(e){return e.addHealth(this.health),this}}class Yo extends nn{constructor(e,t){super(e),this.item=t}execute(e){const t=this.item;return this.active=!1,t.addItemToEntity(e),t.prepareRespawn(),this}}class Ot{static cloneWithSkinning(e){const t=new Map,s=e.clone();return Bi(e,s,(i,n)=>{t.set(i,n)}),e.traverse(function(i){if(!i.isSkinnedMesh)return;const n=i.skeleton.bones,o=t.get(i);o.skeleton=i.skeleton.clone(),o.skeleton.bones=n.map(a=>{if(!t.has(a))throw new Error("SceneUtils: Required bones are not descendants of the given object.");return t.get(a)}),o.bind(o.skeleton,i.bindMatrix)}),s}static createUUIDLabel(e){const t=document.createElement("canvas"),s=t.getContext("2d");t.width=512,t.height=64,s.fillStyle="#ee0808",s.fillRect(0,0,t.width,t.height),s.fillStyle="#ffffff",s.font="24px Arial",s.textAlign="center",s.textBaseline="middle",s.fillText(e,t.width/2,t.height/2);const i=new Pi(t),n=new le({map:i}),o=new te(n);return o.scale.set(4,.5,1),o}static createHitboxHelper(e){var t=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],s=[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],i=new Ie;i.setIndex(t),i.setAttribute("position",new ct(s,3));const n=new pt(i,new Ge({color:16777215}));return n.matrixAutoUpdate=!1,e.getCenter(n.position),e.getSize(n.scale),n.scale.multiplyScalar(.5),n.updateMatrix(),n}static createSpawnPointHelper(e){const t=new X;t.matrixAutoUpdate=!1;const s=16711680,i=new K({color:s}),n=new me(.2,.2,.5);n.translate(0,.25,0);for(let o=0,a=e.length;o<a;o++){const l=new x(n,i);l.position.copy(e[o].position),l.matrixAutoUpdate=!1,l.updateMatrix(),t.add(l)}return t.visible=!1,t}static createTriggerHelper(e){const t=new Ms(e.region.radius,16,16),s=new K({color:6325186,wireframe:!0}),i=new x(t,s);return i.matrixAutoUpdate=!1,i.visible=!1,i}}function Bi(r,e,t){t(r,e);for(let s=0;s<r.children.length;s++)Bi(r.children[s],e.children[s],t)}class Zt extends Ni{constructor(e,t,s){super(e,t),this.ammo=s}addItemToEntity(e){return e.addWeapon(this.type),this}}class Xo{constructor(e){this.world=e,this.spawningPoints=new Array,this.itemTriggerMap=new Map,this.healthPacks=new Array,this.healthPackSpawningPoints=new Array,this.blasters=new Array,this.blasterSpawningPoints=new Array,this.shotguns=new Array,this.shotgunSpawningPoints=new Array,this.assaultRilfles=new Array,this.assaultRilflesSpawningPoints=new Array}update(e){return this.updateItemList(this.healthPacks,e),this.updateItemList(this.blasters,e),this.updateItemList(this.shotguns,e),this.updateItemList(this.assaultRilfles,e),this}updateItemList(e,t){for(let s=0,i=e.length;s<i;s++){const n=e[s];n.currentTime+=t,n.currentTime>=n.nextSpawnTime&&this._respawnItem(n)}return this}getItemList(e){let t=null;switch(e){case gt:t=this.healthPacks;break;case ee:t=this.blasters;break;case q:t=this.shotguns;break;case Q:t=this.assaultRilfles;break;default:console.error("DIVE.SpawningManager: Invalid item type:",e);break}return t}respawnCompetitor(e){const t=this.getSpawnPoint(e);return e.position.copy(t.position),e.rotation.fromEuler(t.rotation.x,t.rotation.y,t.rotation.z),e.isPlayer&&e.head.rotation.set(0,0,0,1),this.world.navMesh&&(e.currentRegion=this.world.navMesh.getRegionForPoint(e.position,1),e.previousPosition.copy(e.position)),this}getSpawnPoint(e){const t=this.spawningPoints,s=this.world.competitors;let i=-1/0,n=null;for(let o=0,a=t.length;o<a;o++){const l=t[o];let c=1/0;for(let h=0,d=s.length;h<d;h++){const u=s[h];if(u!==e){const p=l.position.squaredDistanceTo(u.position);p<c&&(c=p)}}c>i&&(i=c,n=l)}return n}init(){return this.initSpawningPoints(),this.initHealthPacks(),this.initWeapons(),this}initSpawningPoints(){const e=this.world.assetManager.configs.get("level");for(const t of e.competitorSpawningPoints){const s=t.position,i=t.rotation;this.spawningPoints.push({position:new b().fromArray(s),rotation:{x:i[0],y:i[1],z:i[2]}})}for(const t of e.healthPackSpawningPoints)this.healthPackSpawningPoints.push(new b().fromArray(t));for(const t of e.shotgunSpawningPoints)this.shotgunSpawningPoints.push(new b().fromArray(t));for(const t of e.assaultRilflesSpawningPoints)this.assaultRilflesSpawningPoints.push(new b().fromArray(t));return this}initHealthPacks(){const e=this.world,t=e.assetManager;for(let s of this.healthPackSpawningPoints){const i=new $o;i.position.copy(s);const n=e.assetManager.models.get("healthPack").clone();n.position.copy(i.position),i.setRenderComponent(n,tt),this.healthPacks.push(i),e.add(i),i.currentRegion=e.navMesh.getRegionForPoint(i.position,1);const o=t.cloneAudio(t.audios.get("health"));i._audio=o,n.add(o),this.createTrigger(i,w.HEALTH_PACK.RADIUS)}return this}initWeapons(){const e=this.world,t=e.assetManager;for(let s of this.blasterSpawningPoints){const i=new Zt(ee,w.BLASTER.RESPAWN_TIME,w.BLASTER.AMMO);i.position.copy(s);const n=t.models.get("blaster_low").clone();n.position.copy(i.position),i.setRenderComponent(n,tt),this.blasters.push(i),e.add(i),i.currentRegion=e.navMesh.getRegionForPoint(i.position,1);const o=t.cloneAudio(t.audios.get("ammo"));i._audio=o,o.setVolume(.5),n.add(o),this.createTrigger(i,w.BLASTER.RADIUS)}for(let s of this.shotgunSpawningPoints){const i=new Zt(q,w.SHOTGUN.RESPAWN_TIME,w.SHOTGUN.AMMO);i.position.copy(s);const n=t.models.get("shotgun_low").clone();n.position.copy(i.position),i.setRenderComponent(n,tt),this.shotguns.push(i),e.add(i),i.currentRegion=e.navMesh.getRegionForPoint(i.position,1);const o=t.cloneAudio(t.audios.get("ammo"));i._audio=o,o.setVolume(.5),n.add(o),this.createTrigger(i,w.SHOTGUN.RADIUS)}for(let s of this.assaultRilflesSpawningPoints){const i=new Zt(Q,w.ASSAULT_RIFLE.RESPAWN_TIME,w.ASSAULT_RIFLE.AMMO);i.position.copy(s);const n=t.models.get("assaultRifle_low").clone();n.position.copy(i.position),i.setRenderComponent(n,tt),this.assaultRilfles.push(i),this.world.add(i),i.currentRegion=e.navMesh.getRegionForPoint(i.position,1);const o=t.cloneAudio(t.audios.get("ammo"));o.setVolume(.5),i._audio=o,n.add(o),this.createTrigger(i,w.ASSAULT_RIFLE.RADIUS)}return this}createTrigger(e,t){const s=new on(t),i=new Yo(s,e);if(e.add(i),this.itemTriggerMap.set(e,i),this.world.debug){const n=Ot.createTriggerHelper(i);i.setRenderComponent(n,tt),this.world.helpers.itemHelpers.push(n),this.world.scene.add(n)}return this}_respawnItem(e){const t=this.itemTriggerMap.get(e);return t.active=!0,e.finishRespawn(),this}}function tt(r,e){e.matrix.copy(r.worldMatrix)}function qo(r){if(!(typeof window>"u")){var e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=r,document.head.appendChild(e),r}}function Ue(r,e){var t=r.__state.conversionName.toString(),s=Math.round(r.r),i=Math.round(r.g),n=Math.round(r.b),o=r.a,a=Math.round(r.h),l=r.s.toFixed(1),c=r.v.toFixed(1);if(e||t==="THREE_CHAR_HEX"||t==="SIX_CHAR_HEX"){for(var h=r.hex.toString(16);h.length<6;)h="0"+h;return"#"+h}else{if(t==="CSS_RGB")return"rgb("+s+","+i+","+n+")";if(t==="CSS_RGBA")return"rgba("+s+","+i+","+n+","+o+")";if(t==="HEX")return"0x"+r.hex.toString(16);if(t==="RGB_ARRAY")return"["+s+","+i+","+n+"]";if(t==="RGBA_ARRAY")return"["+s+","+i+","+n+","+o+"]";if(t==="RGB_OBJ")return"{r:"+s+",g:"+i+",b:"+n+"}";if(t==="RGBA_OBJ")return"{r:"+s+",g:"+i+",b:"+n+",a:"+o+"}";if(t==="HSV_OBJ")return"{h:"+a+",s:"+l+",v:"+c+"}";if(t==="HSVA_OBJ")return"{h:"+a+",s:"+l+",v:"+c+",a:"+o+"}"}return"unknown format"}var Ws=Array.prototype.forEach,st=Array.prototype.slice,v={BREAK:{},extend:function(e){return this.each(st.call(arguments,1),function(t){var s=this.isObject(t)?Object.keys(t):[];s.forEach((function(i){this.isUndefined(t[i])||(e[i]=t[i])}).bind(this))},this),e},defaults:function(e){return this.each(st.call(arguments,1),function(t){var s=this.isObject(t)?Object.keys(t):[];s.forEach((function(i){this.isUndefined(e[i])&&(e[i]=t[i])}).bind(this))},this),e},compose:function(){var e=st.call(arguments);return function(){for(var t=st.call(arguments),s=e.length-1;s>=0;s--)t=[e[s].apply(this,t)];return t[0]}},each:function(e,t,s){if(e){if(Ws&&e.forEach&&e.forEach===Ws)e.forEach(t,s);else if(e.length===e.length+0){var i=void 0,n=void 0;for(i=0,n=e.length;i<n;i++)if(i in e&&t.call(s,e[i],i)===this.BREAK)return}else for(var o in e)if(t.call(s,e[o],o)===this.BREAK)return}},defer:function(e){setTimeout(e,0)},debounce:function(e,t,s){var i=void 0;return function(){var n=this,o=arguments;function a(){i=null,s||e.apply(n,o)}var l=s||!i;clearTimeout(i),i=setTimeout(a,t),l&&e.apply(n,o)}},toArray:function(e){return e.toArray?e.toArray():st.call(e)},isUndefined:function(e){return e===void 0},isNull:function(e){return e===null},isNaN:(function(r){function e(t){return r.apply(this,arguments)}return e.toString=function(){return r.toString()},e})(function(r){return isNaN(r)}),isArray:Array.isArray||function(r){return r.constructor===Array},isObject:function(e){return e===Object(e)},isNumber:function(e){return e===e+0},isString:function(e){return e===e+""},isBoolean:function(e){return e===!1||e===!0},isFunction:function(e){return e instanceof Function}},Qo=[{litmus:v.isString,conversions:{THREE_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return t===null?!1:{space:"HEX",hex:parseInt("0x"+t[1].toString()+t[1].toString()+t[2].toString()+t[2].toString()+t[3].toString()+t[3].toString(),0)}},write:Ue},SIX_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9]{6})$/i);return t===null?!1:{space:"HEX",hex:parseInt("0x"+t[1].toString(),0)}},write:Ue},CSS_RGB:{read:function(e){var t=e.match(/^rgb\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return t===null?!1:{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3])}},write:Ue},CSS_RGBA:{read:function(e){var t=e.match(/^rgba\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return t===null?!1:{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3]),a:parseFloat(t[4])}},write:Ue}}},{litmus:v.isNumber,conversions:{HEX:{read:function(e){return{space:"HEX",hex:e,conversionName:"HEX"}},write:function(e){return e.hex}}}},{litmus:v.isArray,conversions:{RGB_ARRAY:{read:function(e){return e.length!==3?!1:{space:"RGB",r:e[0],g:e[1],b:e[2]}},write:function(e){return[e.r,e.g,e.b]}},RGBA_ARRAY:{read:function(e){return e.length!==4?!1:{space:"RGB",r:e[0],g:e[1],b:e[2],a:e[3]}},write:function(e){return[e.r,e.g,e.b,e.a]}}}},{litmus:v.isObject,conversions:{RGBA_OBJ:{read:function(e){return v.isNumber(e.r)&&v.isNumber(e.g)&&v.isNumber(e.b)&&v.isNumber(e.a)?{space:"RGB",r:e.r,g:e.g,b:e.b,a:e.a}:!1},write:function(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}},RGB_OBJ:{read:function(e){return v.isNumber(e.r)&&v.isNumber(e.g)&&v.isNumber(e.b)?{space:"RGB",r:e.r,g:e.g,b:e.b}:!1},write:function(e){return{r:e.r,g:e.g,b:e.b}}},HSVA_OBJ:{read:function(e){return v.isNumber(e.h)&&v.isNumber(e.s)&&v.isNumber(e.v)&&v.isNumber(e.a)?{space:"HSV",h:e.h,s:e.s,v:e.v,a:e.a}:!1},write:function(e){return{h:e.h,s:e.s,v:e.v,a:e.a}}},HSV_OBJ:{read:function(e){return v.isNumber(e.h)&&v.isNumber(e.s)&&v.isNumber(e.v)?{space:"HSV",h:e.h,s:e.s,v:e.v}:!1},write:function(e){return{h:e.h,s:e.s,v:e.v}}}}}],it=void 0,vt=void 0,ps=function(){vt=!1;var e=arguments.length>1?v.toArray(arguments):arguments[0];return v.each(Qo,function(t){if(t.litmus(e))return v.each(t.conversions,function(s,i){if(it=s.read(e),vt===!1&&it!==!1)return vt=it,it.conversionName=i,it.conversion=s,v.BREAK}),v.BREAK}),vt},Vs=void 0,Ht={hsv_to_rgb:function(e,t,s){var i=Math.floor(e/60)%6,n=e/60-Math.floor(e/60),o=s*(1-t),a=s*(1-n*t),l=s*(1-(1-n)*t),c=[[s,l,o],[a,s,o],[o,s,l],[o,a,s],[l,o,s],[s,o,a]][i];return{r:c[0]*255,g:c[1]*255,b:c[2]*255}},rgb_to_hsv:function(e,t,s){var i=Math.min(e,t,s),n=Math.max(e,t,s),o=n-i,a=void 0,l=void 0;if(n!==0)l=o/n;else return{h:NaN,s:0,v:0};return e===n?a=(t-s)/o:t===n?a=2+(s-e)/o:a=4+(e-t)/o,a/=6,a<0&&(a+=1),{h:a*360,s:l,v:n/255}},rgb_to_hex:function(e,t,s){var i=this.hex_with_component(0,2,e);return i=this.hex_with_component(i,1,t),i=this.hex_with_component(i,0,s),i},component_from_hex:function(e,t){return e>>t*8&255},hex_with_component:function(e,t,s){return s<<(Vs=t*8)|e&~(255<<Vs)}},Zo=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},he=function(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")},de=(function(){function r(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,s){return t&&r(e.prototype,t),s&&r(e,s),e}})(),Re=function r(e,t,s){e===null&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,t);if(i===void 0){var n=Object.getPrototypeOf(e);return n===null?void 0:r(n,t,s)}else{if("value"in i)return i.value;var o=i.get;return o===void 0?void 0:o.call(s)}},Ce=function(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(r,e):r.__proto__=e)},Pe=function(r,e){if(!r)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:r},U=(function(){function r(){if(he(this,r),this.__state=ps.apply(this,arguments),this.__state===!1)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return de(r,[{key:"toString",value:function(){return Ue(this)}},{key:"toHexString",value:function(){return Ue(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),r})();function As(r,e,t){Object.defineProperty(r,e,{get:function(){return this.__state.space==="RGB"?this.__state[e]:(U.recalculateRGB(this,e,t),this.__state[e])},set:function(i){this.__state.space!=="RGB"&&(U.recalculateRGB(this,e,t),this.__state.space="RGB"),this.__state[e]=i}})}function Is(r,e){Object.defineProperty(r,e,{get:function(){return this.__state.space==="HSV"?this.__state[e]:(U.recalculateHSV(this),this.__state[e])},set:function(s){this.__state.space!=="HSV"&&(U.recalculateHSV(this),this.__state.space="HSV"),this.__state[e]=s}})}U.recalculateRGB=function(r,e,t){if(r.__state.space==="HEX")r.__state[e]=Ht.component_from_hex(r.__state.hex,t);else if(r.__state.space==="HSV")v.extend(r.__state,Ht.hsv_to_rgb(r.__state.h,r.__state.s,r.__state.v));else throw new Error("Corrupted color state")};U.recalculateHSV=function(r){var e=Ht.rgb_to_hsv(r.r,r.g,r.b);v.extend(r.__state,{s:e.s,v:e.v}),v.isNaN(e.h)?v.isUndefined(r.__state.h)&&(r.__state.h=0):r.__state.h=e.h};U.COMPONENTS=["r","g","b","h","s","v","hex","a"];As(U.prototype,"r",2);As(U.prototype,"g",1);As(U.prototype,"b",0);Is(U.prototype,"h");Is(U.prototype,"s");Is(U.prototype,"v");Object.defineProperty(U.prototype,"a",{get:function(){return this.__state.a},set:function(e){this.__state.a=e}});Object.defineProperty(U.prototype,"hex",{get:function(){return this.__state.space!=="HEX"&&(this.__state.hex=Ht.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(e){this.__state.space="HEX",this.__state.hex=e}});var Ne=(function(){function r(e,t){he(this,r),this.initialValue=e[t],this.domElement=document.createElement("div"),this.object=e,this.property=t,this.__onChange=void 0,this.__onFinishChange=void 0}return de(r,[{key:"onChange",value:function(t){return this.__onChange=t,this}},{key:"onFinishChange",value:function(t){return this.__onFinishChange=t,this}},{key:"setValue",value:function(t){return this.object[this.property]=t,this.__onChange&&this.__onChange.call(this,t),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),r})(),Jo={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},Hi={};v.each(Jo,function(r,e){v.each(r,function(t){Hi[t]=e})});var ea=/(\d+(\.\d+)?)px/;function ue(r){if(r==="0"||v.isUndefined(r))return 0;var e=r.match(ea);return v.isNull(e)?0:parseFloat(e[1])}var g={makeSelectable:function(e,t){e===void 0||e.style===void 0||(e.onselectstart=t?function(){return!1}:function(){},e.style.MozUserSelect=t?"auto":"none",e.style.KhtmlUserSelect=t?"auto":"none",e.unselectable=t?"on":"off")},makeFullscreen:function(e,t,s){var i=s,n=t;v.isUndefined(n)&&(n=!0),v.isUndefined(i)&&(i=!0),e.style.position="absolute",n&&(e.style.left=0,e.style.right=0),i&&(e.style.top=0,e.style.bottom=0)},fakeEvent:function(e,t,s,i){var n=s||{},o=Hi[t];if(!o)throw new Error("Event type "+t+" not supported.");var a=document.createEvent(o);switch(o){case"MouseEvents":{var l=n.x||n.clientX||0,c=n.y||n.clientY||0;a.initMouseEvent(t,n.bubbles||!1,n.cancelable||!0,window,n.clickCount||1,0,0,l,c,!1,!1,!1,!1,0,null);break}case"KeyboardEvents":{var h=a.initKeyboardEvent||a.initKeyEvent;v.defaults(n,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),h(t,n.bubbles||!1,n.cancelable,window,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.keyCode,n.charCode);break}default:{a.initEvent(t,n.bubbles||!1,n.cancelable||!0);break}}v.defaults(a,i),e.dispatchEvent(a)},bind:function(e,t,s,i){var n=i||!1;return e.addEventListener?e.addEventListener(t,s,n):e.attachEvent&&e.attachEvent("on"+t,s),g},unbind:function(e,t,s,i){var n=i||!1;return e.removeEventListener?e.removeEventListener(t,s,n):e.detachEvent&&e.detachEvent("on"+t,s),g},addClass:function(e,t){if(e.className===void 0)e.className=t;else if(e.className!==t){var s=e.className.split(/ +/);s.indexOf(t)===-1&&(s.push(t),e.className=s.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return g},removeClass:function(e,t){if(t)if(e.className===t)e.removeAttribute("class");else{var s=e.className.split(/ +/),i=s.indexOf(t);i!==-1&&(s.splice(i,1),e.className=s.join(" "))}else e.className=void 0;return g},hasClass:function(e,t){return new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)").test(e.className)||!1},getWidth:function(e){var t=getComputedStyle(e);return ue(t["border-left-width"])+ue(t["border-right-width"])+ue(t["padding-left"])+ue(t["padding-right"])+ue(t.width)},getHeight:function(e){var t=getComputedStyle(e);return ue(t["border-top-width"])+ue(t["border-bottom-width"])+ue(t["padding-top"])+ue(t["padding-bottom"])+ue(t.height)},getOffset:function(e){var t=e,s={left:0,top:0};if(t.offsetParent)do s.left+=t.offsetLeft,s.top+=t.offsetTop,t=t.offsetParent;while(t);return s},isActive:function(e){return e===document.activeElement&&(e.type||e.href)}},zi=(function(r){Ce(e,r);function e(t,s){he(this,e);var i=Pe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,s)),n=i;i.__prev=i.getValue(),i.__checkbox=document.createElement("input"),i.__checkbox.setAttribute("type","checkbox");function o(){n.setValue(!n.__prev)}return g.bind(i.__checkbox,"change",o,!1),i.domElement.appendChild(i.__checkbox),i.updateDisplay(),i}return de(e,[{key:"setValue",value:function(s){var i=Re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,s);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),i}},{key:"updateDisplay",value:function(){return this.getValue()===!0?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),Re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e})(Ne),ta=(function(r){Ce(e,r);function e(t,s,i){he(this,e);var n=Pe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,s)),o=i,a=n;if(n.__select=document.createElement("select"),v.isArray(o)){var l={};v.each(o,function(c){l[c]=c}),o=l}return v.each(o,function(c,h){var d=document.createElement("option");d.innerHTML=h,d.setAttribute("value",c),a.__select.appendChild(d)}),n.updateDisplay(),g.bind(n.__select,"change",function(){var c=this.options[this.selectedIndex].value;a.setValue(c)}),n.domElement.appendChild(n.__select),n}return de(e,[{key:"setValue",value:function(s){var i=Re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,s);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),i}},{key:"updateDisplay",value:function(){return g.isActive(this.__select)?this:(this.__select.value=this.getValue(),Re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this))}}]),e})(Ne),sa=(function(r){Ce(e,r);function e(t,s){he(this,e);var i=Pe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,s)),n=i;function o(){n.setValue(n.__input.value)}function a(){n.__onFinishChange&&n.__onFinishChange.call(n,n.getValue())}return i.__input=document.createElement("input"),i.__input.setAttribute("type","text"),g.bind(i.__input,"keyup",o),g.bind(i.__input,"change",o),g.bind(i.__input,"blur",a),g.bind(i.__input,"keydown",function(l){l.keyCode===13&&this.blur()}),i.updateDisplay(),i.domElement.appendChild(i.__input),i}return de(e,[{key:"updateDisplay",value:function(){return g.isActive(this.__input)||(this.__input.value=this.getValue()),Re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e})(Ne);function js(r){var e=r.toString();return e.indexOf(".")>-1?e.length-e.indexOf(".")-1:0}var Ui=(function(r){Ce(e,r);function e(t,s,i){he(this,e);var n=Pe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,s)),o=i||{};return n.__min=o.min,n.__max=o.max,n.__step=o.step,v.isUndefined(n.__step)?n.initialValue===0?n.__impliedStep=1:n.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(n.initialValue))/Math.LN10))/10:n.__impliedStep=n.__step,n.__precision=js(n.__impliedStep),n}return de(e,[{key:"setValue",value:function(s){var i=s;return this.__min!==void 0&&i<this.__min?i=this.__min:this.__max!==void 0&&i>this.__max&&(i=this.__max),this.__step!==void 0&&i%this.__step!==0&&(i=Math.round(i/this.__step)*this.__step),Re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,i)}},{key:"min",value:function(s){return this.__min=s,this}},{key:"max",value:function(s){return this.__max=s,this}},{key:"step",value:function(s){return this.__step=s,this.__impliedStep=s,this.__precision=js(s),this}}]),e})(Ne);function ia(r,e){var t=Math.pow(10,e);return Math.round(r*t)/t}var zt=(function(r){Ce(e,r);function e(t,s,i){he(this,e);var n=Pe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,s,i));n.__truncationSuspended=!1;var o=n,a=void 0;function l(){var y=parseFloat(o.__input.value);v.isNaN(y)||o.setValue(y)}function c(){o.__onFinishChange&&o.__onFinishChange.call(o,o.getValue())}function h(){c()}function d(y){var m=a-y.clientY;o.setValue(o.getValue()+m*o.__impliedStep),a=y.clientY}function u(){g.unbind(window,"mousemove",d),g.unbind(window,"mouseup",u),c()}function p(y){g.bind(window,"mousemove",d),g.bind(window,"mouseup",u),a=y.clientY}return n.__input=document.createElement("input"),n.__input.setAttribute("type","text"),g.bind(n.__input,"change",l),g.bind(n.__input,"blur",h),g.bind(n.__input,"mousedown",p),g.bind(n.__input,"keydown",function(y){y.keyCode===13&&(o.__truncationSuspended=!0,this.blur(),o.__truncationSuspended=!1,c())}),n.updateDisplay(),n.domElement.appendChild(n.__input),n}return de(e,[{key:"updateDisplay",value:function(){return this.__input.value=this.__truncationSuspended?this.getValue():ia(this.getValue(),this.__precision),Re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e})(Ui);function Ks(r,e,t,s,i){return s+(i-s)*((r-e)/(t-e))}var fs=(function(r){Ce(e,r);function e(t,s,i,n,o){he(this,e);var a=Pe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,s,{min:i,max:n,step:o})),l=a;a.__background=document.createElement("div"),a.__foreground=document.createElement("div"),g.bind(a.__background,"mousedown",c),g.bind(a.__background,"touchstart",u),g.addClass(a.__background,"slider"),g.addClass(a.__foreground,"slider-fg");function c(m){document.activeElement.blur(),g.bind(window,"mousemove",h),g.bind(window,"mouseup",d),h(m)}function h(m){m.preventDefault();var f=l.__background.getBoundingClientRect();return l.setValue(Ks(m.clientX,f.left,f.right,l.__min,l.__max)),!1}function d(){g.unbind(window,"mousemove",h),g.unbind(window,"mouseup",d),l.__onFinishChange&&l.__onFinishChange.call(l,l.getValue())}function u(m){m.touches.length===1&&(g.bind(window,"touchmove",p),g.bind(window,"touchend",y),p(m))}function p(m){var f=m.touches[0].clientX,_=l.__background.getBoundingClientRect();l.setValue(Ks(f,_.left,_.right,l.__min,l.__max))}function y(){g.unbind(window,"touchmove",p),g.unbind(window,"touchend",y),l.__onFinishChange&&l.__onFinishChange.call(l,l.getValue())}return a.updateDisplay(),a.__background.appendChild(a.__foreground),a.domElement.appendChild(a.__background),a}return de(e,[{key:"updateDisplay",value:function(){var s=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=s*100+"%",Re(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e})(Ui),Gi=(function(r){Ce(e,r);function e(t,s,i){he(this,e);var n=Pe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,s)),o=n;return n.__button=document.createElement("div"),n.__button.innerHTML=i===void 0?"Fire":i,g.bind(n.__button,"click",function(a){return a.preventDefault(),o.fire(),!1}),g.addClass(n.__button,"button"),n.domElement.appendChild(n.__button),n}return de(e,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),e})(Ne),gs=(function(r){Ce(e,r);function e(t,s){he(this,e);var i=Pe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,s));i.__color=new U(i.getValue()),i.__temp=new U(0);var n=i;i.domElement=document.createElement("div"),g.makeSelectable(i.domElement,!1),i.__selector=document.createElement("div"),i.__selector.className="selector",i.__saturation_field=document.createElement("div"),i.__saturation_field.className="saturation-field",i.__field_knob=document.createElement("div"),i.__field_knob.className="field-knob",i.__field_knob_border="2px solid ",i.__hue_knob=document.createElement("div"),i.__hue_knob.className="hue-knob",i.__hue_field=document.createElement("div"),i.__hue_field.className="hue-field",i.__input=document.createElement("input"),i.__input.type="text",i.__input_textShadow="0 1px 1px ",g.bind(i.__input,"keydown",function(m){m.keyCode===13&&d.call(this)}),g.bind(i.__input,"blur",d),g.bind(i.__selector,"mousedown",function(){g.addClass(this,"drag").bind(window,"mouseup",function(){g.removeClass(n.__selector,"drag")})}),g.bind(i.__selector,"touchstart",function(){g.addClass(this,"drag").bind(window,"touchend",function(){g.removeClass(n.__selector,"drag")})});var o=document.createElement("div");v.extend(i.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),v.extend(i.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:i.__field_knob_border+(i.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),v.extend(i.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),v.extend(i.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),v.extend(o.style,{width:"100%",height:"100%",background:"none"}),$s(o,"top","rgba(0,0,0,0)","#000"),v.extend(i.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),oa(i.__hue_field),v.extend(i.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:i.__input_textShadow+"rgba(0,0,0,0.7)"}),g.bind(i.__saturation_field,"mousedown",a),g.bind(i.__saturation_field,"touchstart",a),g.bind(i.__field_knob,"mousedown",a),g.bind(i.__field_knob,"touchstart",a),g.bind(i.__hue_field,"mousedown",l),g.bind(i.__hue_field,"touchstart",l);function a(m){p(m),g.bind(window,"mousemove",p),g.bind(window,"touchmove",p),g.bind(window,"mouseup",c),g.bind(window,"touchend",c)}function l(m){y(m),g.bind(window,"mousemove",y),g.bind(window,"touchmove",y),g.bind(window,"mouseup",h),g.bind(window,"touchend",h)}function c(){g.unbind(window,"mousemove",p),g.unbind(window,"touchmove",p),g.unbind(window,"mouseup",c),g.unbind(window,"touchend",c),u()}function h(){g.unbind(window,"mousemove",y),g.unbind(window,"touchmove",y),g.unbind(window,"mouseup",h),g.unbind(window,"touchend",h),u()}function d(){var m=ps(this.value);m!==!1?(n.__color.__state=m,n.setValue(n.__color.toOriginal())):this.value=n.__color.toString()}function u(){n.__onFinishChange&&n.__onFinishChange.call(n,n.__color.toOriginal())}i.__saturation_field.appendChild(o),i.__selector.appendChild(i.__field_knob),i.__selector.appendChild(i.__saturation_field),i.__selector.appendChild(i.__hue_field),i.__hue_field.appendChild(i.__hue_knob),i.domElement.appendChild(i.__input),i.domElement.appendChild(i.__selector),i.updateDisplay();function p(m){m.type.indexOf("touch")===-1&&m.preventDefault();var f=n.__saturation_field.getBoundingClientRect(),_=m.touches&&m.touches[0]||m,M=_.clientX,E=_.clientY,T=(M-f.left)/(f.right-f.left),I=1-(E-f.top)/(f.bottom-f.top);return I>1?I=1:I<0&&(I=0),T>1?T=1:T<0&&(T=0),n.__color.v=I,n.__color.s=T,n.setValue(n.__color.toOriginal()),!1}function y(m){m.type.indexOf("touch")===-1&&m.preventDefault();var f=n.__hue_field.getBoundingClientRect(),_=m.touches&&m.touches[0]||m,M=_.clientY,E=1-(M-f.top)/(f.bottom-f.top);return E>1?E=1:E<0&&(E=0),n.__color.h=E*360,n.setValue(n.__color.toOriginal()),!1}return i}return de(e,[{key:"updateDisplay",value:function(){var s=ps(this.getValue());if(s!==!1){var i=!1;v.each(U.COMPONENTS,function(a){if(!v.isUndefined(s[a])&&!v.isUndefined(this.__color.__state[a])&&s[a]!==this.__color.__state[a])return i=!0,{}},this),i&&v.extend(this.__color.__state,s)}v.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var n=this.__color.v<.5||this.__color.s>.5?255:0,o=255-n;v.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+n+","+n+","+n+")"}),this.__hue_knob.style.marginTop=(1-this.__color.h/360)*100+"px",this.__temp.s=1,this.__temp.v=1,$s(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),v.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+n+","+n+","+n+")",textShadow:this.__input_textShadow+"rgba("+o+","+o+","+o+",.7)"})}}]),e})(Ne),na=["-moz-","-o-","-webkit-","-ms-",""];function $s(r,e,t,s){r.style.background="",v.each(na,function(i){r.style.cssText+="background: "+i+"linear-gradient("+e+", "+t+" 0%, "+s+" 100%); "})}function oa(r){r.style.background="",r.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",r.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",r.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",r.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",r.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var aa={load:function(e,t){var s=t||document,i=s.createElement("link");i.type="text/css",i.rel="stylesheet",i.href=e,s.getElementsByTagName("head")[0].appendChild(i)},inject:function(e,t){var s=t||document,i=document.createElement("style");i.type="text/css",i.innerHTML=e;var n=s.getElementsByTagName("head")[0];try{n.appendChild(i)}catch{}}},ra=`<div id="dg-save" class="dg dialogue">

  Here's the new load parameter for your <code>GUI</code>'s constructor:

  <textarea id="dg-new-constructor"></textarea>

  <div id="dg-save-locally">

    <input id="dg-local-storage" type="checkbox"/> Automatically save
    values to <code>localStorage</code> on exit.

    <div id="dg-local-explain">The values saved to <code>localStorage</code> will
      override those passed to <code>dat.GUI</code>'s constructor. This makes it
      easier to work incrementally, but <code>localStorage</code> is fragile,
      and your friends may not see the same values you do.

    </div>

  </div>

</div>`,la=function(e,t){var s=e[t];return v.isArray(arguments[2])||v.isObject(arguments[2])?new ta(e,t,arguments[2]):v.isNumber(s)?v.isNumber(arguments[2])&&v.isNumber(arguments[3])?v.isNumber(arguments[4])?new fs(e,t,arguments[2],arguments[3],arguments[4]):new fs(e,t,arguments[2],arguments[3]):v.isNumber(arguments[4])?new zt(e,t,{min:arguments[2],max:arguments[3],step:arguments[4]}):new zt(e,t,{min:arguments[2],max:arguments[3]}):v.isString(s)?new sa(e,t):v.isFunction(s)?new Gi(e,t,""):v.isBoolean(s)?new zi(e,t):null};function ca(r){setTimeout(r,1e3/60)}var ha=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||ca,da=(function(){function r(){he(this,r),this.backgroundElement=document.createElement("div"),v.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),g.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),v.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var e=this;g.bind(this.backgroundElement,"click",function(){e.hide()})}return de(r,[{key:"show",value:function(){var t=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),v.defer(function(){t.backgroundElement.style.opacity=1,t.domElement.style.opacity=1,t.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var t=this,s=function i(){t.domElement.style.display="none",t.backgroundElement.style.display="none",g.unbind(t.domElement,"webkitTransitionEnd",i),g.unbind(t.domElement,"transitionend",i),g.unbind(t.domElement,"oTransitionEnd",i)};g.bind(this.domElement,"webkitTransitionEnd",s),g.bind(this.domElement,"transitionend",s),g.bind(this.domElement,"oTransitionEnd",s),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-g.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-g.getHeight(this.domElement)/2+"px"}}]),r})(),ua=qo(`.dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .cr.function .property-name{width:100%}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}
`);aa.inject(ua);var Ys="dg",Xs=72,qs=20,wt="Default",ht=(function(){try{return!!window.localStorage}catch{return!1}})(),ut=void 0,Qs=!0,He=void 0,Jt=!1,Wi=[],k=function r(e){var t=this,s=e||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),g.addClass(this.domElement,Ys),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],s=v.defaults(s,{closeOnTop:!1,autoPlace:!0,width:r.DEFAULT_WIDTH}),s=v.defaults(s,{resizable:s.autoPlace,hideable:s.autoPlace}),v.isUndefined(s.load)?s.load={preset:wt}:s.preset&&(s.load.preset=s.preset),v.isUndefined(s.parent)&&s.hideable&&Wi.push(this),s.resizable=v.isUndefined(s.parent)&&s.resizable,s.autoPlace&&v.isUndefined(s.scrollable)&&(s.scrollable=!0);var i=ht&&localStorage.getItem(ze(this,"isLocal"))==="true",n=void 0,o=void 0;if(Object.defineProperties(this,{parent:{get:function(){return s.parent}},scrollable:{get:function(){return s.scrollable}},autoPlace:{get:function(){return s.autoPlace}},closeOnTop:{get:function(){return s.closeOnTop}},preset:{get:function(){return t.parent?t.getRoot().preset:s.load.preset},set:function(u){t.parent?t.getRoot().preset=u:s.load.preset=u,ga(this),t.revert()}},width:{get:function(){return s.width},set:function(u){s.width=u,_s(t,u)}},name:{get:function(){return s.name},set:function(u){s.name=u,o&&(o.innerHTML=s.name)}},closed:{get:function(){return s.closed},set:function(u){s.closed=u,s.closed?g.addClass(t.__ul,r.CLASS_CLOSED):g.removeClass(t.__ul,r.CLASS_CLOSED),this.onResize(),t.__closeButton&&(t.__closeButton.innerHTML=u?r.TEXT_OPEN:r.TEXT_CLOSED)}},load:{get:function(){return s.load}},useLocalStorage:{get:function(){return i},set:function(u){ht&&(i=u,u?g.bind(window,"unload",n):g.unbind(window,"unload",n),localStorage.setItem(ze(t,"isLocal"),u))}}}),v.isUndefined(s.parent)){if(this.closed=s.closed||!1,g.addClass(this.domElement,r.CLASS_MAIN),g.makeSelectable(this.domElement,!1),ht&&i){t.useLocalStorage=!0;var a=localStorage.getItem(ze(this,"gui"));a&&(s.load=JSON.parse(a))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=r.TEXT_CLOSED,g.addClass(this.__closeButton,r.CLASS_CLOSE_BUTTON),s.closeOnTop?(g.addClass(this.__closeButton,r.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(g.addClass(this.__closeButton,r.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),g.bind(this.__closeButton,"click",function(){t.closed=!t.closed})}else{s.closed===void 0&&(s.closed=!0);var l=document.createTextNode(s.name);g.addClass(l,"controller-name"),o=Rs(t,l);var c=function(u){return u.preventDefault(),t.closed=!t.closed,!1};g.addClass(this.__ul,r.CLASS_CLOSED),g.addClass(o,"title"),g.bind(o,"click",c),s.closed||(this.closed=!1)}s.autoPlace&&(v.isUndefined(s.parent)&&(Qs&&(He=document.createElement("div"),g.addClass(He,Ys),g.addClass(He,r.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(He),Qs=!1),He.appendChild(this.domElement),g.addClass(this.domElement,r.CLASS_AUTO_PLACE)),this.parent||_s(t,s.width)),this.__resizeHandler=function(){t.onResizeDebounced()},g.bind(window,"resize",this.__resizeHandler),g.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),g.bind(this.__ul,"transitionend",this.__resizeHandler),g.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),s.resizable&&fa(this),n=function(){ht&&localStorage.getItem(ze(t,"isLocal"))==="true"&&localStorage.setItem(ze(t,"gui"),JSON.stringify(t.getSaveObject()))},this.saveToLocalStorageIfPossible=n;function h(){var d=t.getRoot();d.width+=1,v.defer(function(){d.width-=1})}s.parent||h()};k.toggleHide=function(){Jt=!Jt,v.each(Wi,function(r){r.domElement.style.display=Jt?"none":""})};k.CLASS_AUTO_PLACE="a";k.CLASS_AUTO_PLACE_CONTAINER="ac";k.CLASS_MAIN="main";k.CLASS_CONTROLLER_ROW="cr";k.CLASS_TOO_TALL="taller-than-window";k.CLASS_CLOSED="closed";k.CLASS_CLOSE_BUTTON="close-button";k.CLASS_CLOSE_TOP="close-top";k.CLASS_CLOSE_BOTTOM="close-bottom";k.CLASS_DRAG="drag";k.DEFAULT_WIDTH=245;k.TEXT_CLOSED="Close Controls";k.TEXT_OPEN="Open Controls";k._keydownHandler=function(r){document.activeElement.type!=="text"&&(r.which===Xs||r.keyCode===Xs)&&k.toggleHide()};g.bind(window,"keydown",k._keydownHandler,!1);v.extend(k.prototype,{add:function(e,t){return mt(this,e,t,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(e,t){return mt(this,e,t,{color:!0})},remove:function(e){this.__ul.removeChild(e.__li),this.__controllers.splice(this.__controllers.indexOf(e),1);var t=this;v.defer(function(){t.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&He.removeChild(this.domElement);var e=this;v.each(this.__folders,function(t){e.removeFolder(t)}),g.unbind(window,"keydown",k._keydownHandler,!1),Zs(this)},addFolder:function(e){if(this.__folders[e]!==void 0)throw new Error('You already have a folder in this GUI by the name "'+e+'"');var t={name:e,parent:this};t.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[e]&&(t.closed=this.load.folders[e].closed,t.load=this.load.folders[e]);var s=new k(t);this.__folders[e]=s;var i=Rs(this,s.domElement);return g.addClass(i,"folder"),s},removeFolder:function(e){this.__ul.removeChild(e.domElement.parentElement),delete this.__folders[e.name],this.load&&this.load.folders&&this.load.folders[e.name]&&delete this.load.folders[e.name],Zs(e);var t=this;v.each(e.__folders,function(s){e.removeFolder(s)}),v.defer(function(){t.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var e=this.getRoot();if(e.scrollable){var t=g.getOffset(e.__ul).top,s=0;v.each(e.__ul.childNodes,function(i){e.autoPlace&&i===e.__save_row||(s+=g.getHeight(i))}),window.innerHeight-t-qs<s?(g.addClass(e.domElement,k.CLASS_TOO_TALL),e.__ul.style.height=window.innerHeight-t-qs+"px"):(g.removeClass(e.domElement,k.CLASS_TOO_TALL),e.__ul.style.height="auto")}e.__resize_handle&&v.defer(function(){e.__resize_handle.style.height=e.__ul.offsetHeight+"px"}),e.__closeButton&&(e.__closeButton.style.width=e.width+"px")},onResizeDebounced:v.debounce(function(){this.onResize()},50),remember:function(){if(v.isUndefined(ut)&&(ut=new da,ut.domElement.innerHTML=ra),this.parent)throw new Error("You can only call remember on a top level GUI.");var e=this;v.each(Array.prototype.slice.call(arguments),function(t){e.__rememberedObjects.length===0&&pa(e),e.__rememberedObjects.indexOf(t)===-1&&e.__rememberedObjects.push(t)}),this.autoPlace&&_s(this,this.width)},getRoot:function(){for(var e=this;e.parent;)e=e.parent;return e},getSaveObject:function(){var e=this.load;return e.closed=this.closed,this.__rememberedObjects.length>0&&(e.preset=this.preset,e.remembered||(e.remembered={}),e.remembered[this.preset]=bt(this)),e.folders={},v.each(this.__folders,function(t,s){e.folders[s]=t.getSaveObject()}),e},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=bt(this),ys(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(e){this.load.remembered||(this.load.remembered={},this.load.remembered[wt]=bt(this,!0)),this.load.remembered[e]=bt(this),this.preset=e,ws(this,e,!0),this.saveToLocalStorageIfPossible()},revert:function(e){v.each(this.__controllers,function(t){this.getRoot().load.remembered?Vi(e||this.getRoot(),t):t.setValue(t.initialValue),t.__onFinishChange&&t.__onFinishChange.call(t,t.getValue())},this),v.each(this.__folders,function(t){t.revert(t)}),e||ys(this.getRoot(),!1)},listen:function(e){var t=this.__listening.length===0;this.__listening.push(e),t&&ji(this.__listening)},updateDisplay:function(){v.each(this.__controllers,function(e){e.updateDisplay()}),v.each(this.__folders,function(e){e.updateDisplay()})}});function Rs(r,e,t){var s=document.createElement("li");return e&&s.appendChild(e),t?r.__ul.insertBefore(s,t):r.__ul.appendChild(s),r.onResize(),s}function Zs(r){g.unbind(window,"resize",r.__resizeHandler),r.saveToLocalStorageIfPossible&&g.unbind(window,"unload",r.saveToLocalStorageIfPossible)}function ys(r,e){var t=r.__preset_select[r.__preset_select.selectedIndex];e?t.innerHTML=t.value+"*":t.innerHTML=t.value}function ma(r,e,t){if(t.__li=e,t.__gui=r,v.extend(t,{options:function(o){if(arguments.length>1){var a=t.__li.nextElementSibling;return t.remove(),mt(r,t.object,t.property,{before:a,factoryArgs:[v.toArray(arguments)]})}if(v.isArray(o)||v.isObject(o)){var l=t.__li.nextElementSibling;return t.remove(),mt(r,t.object,t.property,{before:l,factoryArgs:[o]})}},name:function(o){return t.__li.firstElementChild.firstElementChild.innerHTML=o,t},listen:function(){return t.__gui.listen(t),t},remove:function(){return t.__gui.remove(t),t}}),t instanceof fs){var s=new zt(t.object,t.property,{min:t.__min,max:t.__max,step:t.__step});v.each(["updateDisplay","onChange","onFinishChange","step","min","max"],function(n){var o=t[n],a=s[n];t[n]=s[n]=function(){var l=Array.prototype.slice.call(arguments);return a.apply(s,l),o.apply(t,l)}}),g.addClass(e,"has-slider"),t.domElement.insertBefore(s.domElement,t.domElement.firstElementChild)}else if(t instanceof zt){var i=function(o){if(v.isNumber(t.__min)&&v.isNumber(t.__max)){var a=t.__li.firstElementChild.firstElementChild.innerHTML,l=t.__gui.__listening.indexOf(t)>-1;t.remove();var c=mt(r,t.object,t.property,{before:t.__li.nextElementSibling,factoryArgs:[t.__min,t.__max,t.__step]});return c.name(a),l&&c.listen(),c}return o};t.min=v.compose(i,t.min),t.max=v.compose(i,t.max)}else t instanceof zi?(g.bind(e,"click",function(){g.fakeEvent(t.__checkbox,"click")}),g.bind(t.__checkbox,"click",function(n){n.stopPropagation()})):t instanceof Gi?(g.bind(e,"click",function(){g.fakeEvent(t.__button,"click")}),g.bind(e,"mouseover",function(){g.addClass(t.__button,"hover")}),g.bind(e,"mouseout",function(){g.removeClass(t.__button,"hover")})):t instanceof gs&&(g.addClass(e,"color"),t.updateDisplay=v.compose(function(n){return e.style.borderLeftColor=t.__color.toString(),n},t.updateDisplay),t.updateDisplay());t.setValue=v.compose(function(n){return r.getRoot().__preset_select&&t.isModified()&&ys(r.getRoot(),!0),n},t.setValue)}function Vi(r,e){var t=r.getRoot(),s=t.__rememberedObjects.indexOf(e.object);if(s!==-1){var i=t.__rememberedObjectIndecesToControllers[s];if(i===void 0&&(i={},t.__rememberedObjectIndecesToControllers[s]=i),i[e.property]=e,t.load&&t.load.remembered){var n=t.load.remembered,o=void 0;if(n[r.preset])o=n[r.preset];else if(n[wt])o=n[wt];else return;if(o[s]&&o[s][e.property]!==void 0){var a=o[s][e.property];e.initialValue=a,e.setValue(a)}}}}function mt(r,e,t,s){if(e[t]===void 0)throw new Error('Object "'+e+'" has no property "'+t+'"');var i=void 0;if(s.color)i=new gs(e,t);else{var n=[e,t].concat(s.factoryArgs);i=la.apply(r,n)}s.before instanceof Ne&&(s.before=s.before.__li),Vi(r,i),g.addClass(i.domElement,"c");var o=document.createElement("span");g.addClass(o,"property-name"),o.innerHTML=i.property;var a=document.createElement("div");a.appendChild(o),a.appendChild(i.domElement);var l=Rs(r,a,s.before);return g.addClass(l,k.CLASS_CONTROLLER_ROW),i instanceof gs?g.addClass(l,"color"):g.addClass(l,Zo(i.getValue())),ma(r,l,i),r.__controllers.push(i),i}function ze(r,e){return document.location.href+"."+e}function ws(r,e,t){var s=document.createElement("option");s.innerHTML=e,s.value=e,r.__preset_select.appendChild(s),t&&(r.__preset_select.selectedIndex=r.__preset_select.length-1)}function Js(r,e){e.style.display=r.useLocalStorage?"block":"none"}function pa(r){var e=r.__save_row=document.createElement("li");g.addClass(r.domElement,"has-save"),r.__ul.insertBefore(e,r.__ul.firstChild),g.addClass(e,"save-row");var t=document.createElement("span");t.innerHTML="&nbsp;",g.addClass(t,"button gears");var s=document.createElement("span");s.innerHTML="Save",g.addClass(s,"button"),g.addClass(s,"save");var i=document.createElement("span");i.innerHTML="New",g.addClass(i,"button"),g.addClass(i,"save-as");var n=document.createElement("span");n.innerHTML="Revert",g.addClass(n,"button"),g.addClass(n,"revert");var o=r.__preset_select=document.createElement("select");if(r.load&&r.load.remembered?v.each(r.load.remembered,function(d,u){ws(r,u,u===r.preset)}):ws(r,wt,!1),g.bind(o,"change",function(){for(var d=0;d<r.__preset_select.length;d++)r.__preset_select[d].innerHTML=r.__preset_select[d].value;r.preset=this.value}),e.appendChild(o),e.appendChild(t),e.appendChild(s),e.appendChild(i),e.appendChild(n),ht){var a=document.getElementById("dg-local-explain"),l=document.getElementById("dg-local-storage"),c=document.getElementById("dg-save-locally");c.style.display="block",localStorage.getItem(ze(r,"isLocal"))==="true"&&l.setAttribute("checked","checked"),Js(r,a),g.bind(l,"change",function(){r.useLocalStorage=!r.useLocalStorage,Js(r,a)})}var h=document.getElementById("dg-new-constructor");g.bind(h,"keydown",function(d){d.metaKey&&(d.which===67||d.keyCode===67)&&ut.hide()}),g.bind(t,"click",function(){h.innerHTML=JSON.stringify(r.getSaveObject(),void 0,2),ut.show(),h.focus(),h.select()}),g.bind(s,"click",function(){r.save()}),g.bind(i,"click",function(){var d=prompt("Enter a new preset name.");d&&r.saveAs(d)}),g.bind(n,"click",function(){r.revert()})}function fa(r){var e=void 0;r.__resize_handle=document.createElement("div"),v.extend(r.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});function t(n){return n.preventDefault(),r.width+=e-n.clientX,r.onResize(),e=n.clientX,!1}function s(){g.removeClass(r.__closeButton,k.CLASS_DRAG),g.unbind(window,"mousemove",t),g.unbind(window,"mouseup",s)}function i(n){return n.preventDefault(),e=n.clientX,g.addClass(r.__closeButton,k.CLASS_DRAG),g.bind(window,"mousemove",t),g.bind(window,"mouseup",s),!1}g.bind(r.__resize_handle,"mousedown",i),g.bind(r.__closeButton,"mousedown",i),r.domElement.insertBefore(r.__resize_handle,r.domElement.firstElementChild)}function _s(r,e){r.domElement.style.width=e+"px",r.__save_row&&r.autoPlace&&(r.__save_row.style.width=e+"px"),r.__closeButton&&(r.__closeButton.style.width=e+"px")}function bt(r,e){var t={};return v.each(r.__rememberedObjects,function(s,i){var n={},o=r.__rememberedObjectIndecesToControllers[i];v.each(o,function(a,l){n[l]=e?a.initialValue:a.getValue()}),t[i]=n}),t}function ga(r){for(var e=0;e<r.__preset_select.length;e++)r.__preset_select[e].value===r.preset&&(r.__preset_select.selectedIndex=e)}function ji(r){r.length!==0&&ha.call(window,function(){ji(r)}),v.each(r,function(e){e.updateDisplay()})}var ya=k;const Tt=Math.PI*.25,ei=Math.PI*.75;class wa{constructor(e){this.world=e,this.currentTime=0,this.hitIndicationTime=w.UI.CROSSHAIRS.HIT_TIME,this.endTimeHitIndication=1/0,this.damageIndicationTime=w.UI.DAMAGE_INDICATOR.TIME,this.endTimeDamageIndicationFront=1/0,this.endTimeDamageIndicationRight=1/0,this.endTimeDamageIndicationLeft=1/0,this.endTimeDamageIndicationBack=1/0,this.fragMessages=new Array,this.html={loadingScreen:document.getElementById("loadingScreen"),hudAmmo:document.getElementById("hudAmmo"),hudHealth:document.getElementById("hudHealth"),roundsLeft:document.getElementById("roundsLeft"),ammo:document.getElementById("ammo"),health:document.getElementById("health"),hudFragList:document.getElementById("hudFragList"),fragList:document.getElementById("fragList")},this.sprites={crosshairs:null,frontIndicator:null,rightIndicator:null,leftIndicator:null,backIndicator:null};const t=window.innerWidth,s=window.innerHeight;this.camera=new Ii(-t/2,t/2,s/2,-s/2,1,10),this.camera.position.z=10,this.scene=new Li,this.datGui=null,this.debugParameter={showRegions:!1,showAxes:!1,showPaths:!1,showGraph:!1,showSpawnPoints:!1,showUUIDHelpers:!1,showSkeletons:!1,showItemRadius:!1,showWireframe:!1,showSpatialIndex:!1,enableFPSControls:()=>{this.world.fpsControls.connect()}}}init(){this._buildFPSInterface();const e=this.world;if(e.debug===!0){const t=new ya({width:300}),s=this.debugParameter,i=t.addFolder("Navigation Mesh");i.open(),i.add(s,"showRegions").name("show convex regions").onChange(a=>{e.helpers.convexRegionHelper.visible=a}),i.add(s,"showSpatialIndex",1,30).name("show spatial index").onChange(a=>{e.helpers.spatialIndexHelper.visible=a}),i.add(s,"showPaths",1,30).name("show navigation paths").onChange(a=>{for(const l of e.helpers.pathHelpers)l.visible=a}),i.add(s,"showGraph").name("show graph").onChange(a=>{e.helpers.graphHelper.visible=a});const n=t.addFolder("World");n.open(),n.add(s,"showAxes").name("show axes helper").onChange(a=>{e.helpers.axesHelper.visible=a}),n.add(s,"showSpawnPoints").name("show spawn points").onChange(a=>{e.helpers.spawnHelpers.visible=a}),n.add(s,"showItemRadius").name("show item radius").onChange(a=>{for(const l of e.helpers.itemHelpers)l.visible=a}),n.add(s,"showWireframe").name("show wireframe").onChange(a=>{const l=this.world.scene.getObjectByName("level");l.material.wireframe=a}),n.add(s,"enableFPSControls").name("enable FPS controls");const o=t.addFolder("Enemy");o.open(),o.add(s,"showUUIDHelpers",1,30).name("show UUID helpers").onChange(a=>{for(const l of e.helpers.uuidHelpers)l.visible=a}),o.add(s,"showSkeletons",1,30).name("show skeletons").onChange(a=>{for(const l of e.helpers.skeletonHelpers)l.visible=a}),t.open(),this.datGui=t}return this.html.loadingScreen.addEventListener("transitionend",t=>{t.target.remove(),this.html.loadingScreen=null}),this.html.loadingScreen.classList.add("fade-out"),this}update(e){return this.currentTime+=e,this.currentTime>=this.endTimeHitIndication&&this.hideHitIndication(),this.currentTime>=this.endTimeDamageIndicationFront&&(this.sprites.frontIndicator.visible=!1),this.currentTime>=this.endTimeDamageIndicationRight&&(this.sprites.rightIndicator.visible=!1),this.currentTime>=this.endTimeDamageIndicationLeft&&(this.sprites.leftIndicator.visible=!1),this.currentTime>=this.endTimeDamageIndicationBack&&(this.sprites.backIndicator.visible=!1),this._updateFragList(),this._render(),this}showHitIndication(){return this.sprites.crosshairs.material.color.set(16711680),this.endTimeHitIndication=this.currentTime+this.hitIndicationTime,this}hideHitIndication(){return this.sprites.crosshairs.material.color.set(16777215),this.endTimeHitIndication=1/0,this}showDamageIndication(e){return e>=-Tt&&e<=Tt?(this.sprites.frontIndicator.visible=!0,this.endTimeDamageIndicationFront=this.currentTime+this.damageIndicationTime):e>Tt&&e<=ei?(this.sprites.rightIndicator.visible=!0,this.endTimeDamageIndicationRight=this.currentTime+this.damageIndicationTime):e>=-ei&&e<-Tt?(this.sprites.leftIndicator.visible=!0,this.endTimeDamageIndicationLeft=this.currentTime+this.damageIndicationTime):(this.sprites.backIndicator.visible=!0,this.endTimeDamageIndicationBack=this.currentTime+this.damageIndicationTime),this}showFPSInterface(){return this.sprites.crosshairs.visible=!0,this.html.hudAmmo.classList.remove("hidden"),this.html.hudHealth.classList.remove("hidden"),this.updateAmmoStatus(),this.updateHealthStatus(),this}hideFPSInterface(){return this.html.hudAmmo.classList.add("hidden"),this.html.hudHealth.classList.add("hidden"),this.sprites.crosshairs.visible=!1,this.sprites.frontIndicator.visible=!1,this.sprites.rightIndicator.visible=!1,this.sprites.leftIndicator.visible=!1,this.sprites.backIndicator.visible=!1,this}setSize(e,t){return this.camera.left=-e/2,this.camera.right=e/2,this.camera.top=t/2,this.camera.bottom=-t/2,this.camera.updateProjectionMatrix(),this}_updateFragList(){const e=this.fragMessages;for(let t=e.length-1;t>=0;t--){const s=e[t];this.currentTime>=s.endTime&&(e.splice(t,1),this.html.fragList.removeChild(s.html))}return e.length===0&&this.html.hudFragList.classList.add("hidden"),this}addFragMessage(e,t){this.html.hudFragList.classList.remove("hidden");const s=e.name+" fragged "+t.name,i=document.createElement("span");i.style.color="#00ff00",i.textContent=e.name;const n=document.createElement("span");n.textContent=" fragged ";const o=document.createElement("span");o.style.color="#ff0000",o.textContent=t.name;const a=document.createElement("li");a.appendChild(i),a.appendChild(n),a.appendChild(o);const l={text:s,endTime:this.currentTime+w.UI.FRAGS.TIME,html:a};return this.fragMessages.push(l),this.html.fragList.appendChild(a),this}updateAmmoStatus(){const t=this.world.player.weaponSystem.currentWeapon;return t&&(this.html.roundsLeft.textContent=t.roundsLeft,this.html.ammo.textContent=t.ammo),this}updateHealthStatus(){const e=this.world.player;return this.html.health.textContent=e.health,this}openDebugUI(){return this.datGui.open(),this}closeDebugUI(){return this.datGui.close(),this}_buildFPSInterface(){const e=this.world.assetManager.textures.get("crosshairs"),t=new le({map:e,opacity:w.UI.CROSSHAIRS.OPACITY}),s=new te(t);s.matrixAutoUpdate=!1,s.visible=!1,s.position.set(0,0,1),s.scale.set(w.UI.CROSSHAIRS.SCALE,w.UI.CROSSHAIRS.SCALE,1),s.updateMatrix(),this.scene.add(s),this.sprites.crosshairs=s;const i=this.world.assetManager.textures.get("damageIndicatorFront"),n=new le({map:i,opacity:w.UI.DAMAGE_INDICATOR.OPACITY}),o=new te(n);o.matrixAutoUpdate=!1,o.visible=!1,o.position.set(0,0,1),o.scale.set(w.UI.DAMAGE_INDICATOR.SCALE,w.UI.DAMAGE_INDICATOR.SCALE,1),o.updateMatrix(),this.scene.add(o),this.sprites.frontIndicator=o;const a=this.world.assetManager.textures.get("damageIndicatorRight"),l=new le({map:a,opacity:w.UI.DAMAGE_INDICATOR.OPACITY}),c=new te(l);c.matrixAutoUpdate=!1,c.visible=!1,c.position.set(0,0,1),c.scale.set(w.UI.DAMAGE_INDICATOR.SCALE,w.UI.DAMAGE_INDICATOR.SCALE,1),c.updateMatrix(),this.scene.add(c),this.sprites.rightIndicator=c;const h=this.world.assetManager.textures.get("damageIndicatorLeft"),d=new le({map:h,opacity:w.UI.DAMAGE_INDICATOR.OPACITY}),u=new te(d);u.matrixAutoUpdate=!1,u.visible=!1,u.position.set(0,0,1),u.scale.set(w.UI.DAMAGE_INDICATOR.SCALE,w.UI.DAMAGE_INDICATOR.SCALE,1),u.updateMatrix(),this.scene.add(u),this.sprites.leftIndicator=u;const p=this.world.assetManager.textures.get("damageIndicatorBack"),y=new le({map:p,opacity:w.UI.DAMAGE_INDICATOR.OPACITY}),m=new te(y);return m.matrixAutoUpdate=!1,m.visible=!1,m.position.set(0,0,1),m.scale.set(w.UI.DAMAGE_INDICATOR.SCALE,w.UI.DAMAGE_INDICATOR.SCALE,1),m.updateMatrix(),this.scene.add(m),this.sprites.backIndicator=m,this}_render(){return this.world.renderer.clearDepth(),this.world.renderer.render(this.scene,this.camera),this}}const ti=Math.PI/2,_a=new b;let es=0;const St={x:0,y:0,z:0};class va extends an{constructor(e=null){super(),this.owner=e,this.active=!0,this.movementX=0,this.movementY=0,this.lookingSpeed=w.CONTROLS.LOOKING_SPEED,this.brakingPower=w.CONTROLS.BRAKING_POWER,this.headMovement=w.CONTROLS.HEAD_MOVEMENT,this.weaponMovement=w.CONTROLS.WEAPON_MOVEMENT,this.isSprinting=!1,this.sprintMultiplier=1.6,this.input={forward:!1,backward:!1,right:!1,left:!1,mouseDown:!1,sprint:!1,jump:!1,crouch:!1},this.sounds=new Map,this._mouseDownHandler=ba.bind(this),this._mouseUpHandler=Ta.bind(this),this._mouseMoveHandler=Sa.bind(this),this._pointerlockChangeHandler=Ma.bind(this),this._pointerlockErrorHandler=Ea.bind(this),this._keyDownHandler=xa.bind(this),this._keyUpHandler=Aa.bind(this),this._wheelHandler=Ia.bind(this),this._contextMenuHandler=Ra.bind(this)}connect(){return document.addEventListener("mousedown",this._mouseDownHandler,!1),document.addEventListener("mouseup",this._mouseUpHandler,!1),document.addEventListener("mousemove",this._mouseMoveHandler,!1),document.addEventListener("wheel",this._wheelHandler,!1),document.addEventListener("pointerlockchange",this._pointerlockChangeHandler,!1),document.addEventListener("pointerlockerror",this._pointerlockErrorHandler,!1),document.addEventListener("keydown",this._keyDownHandler,!1),document.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("contextmenu",this._contextMenuHandler,!1),document.body.requestPointerLock().catch(e=>{console.log("Pointer lock will be requested on first click:",e)}),this}disconnect(){return document.removeEventListener("mousedown",this._mouseDownHandler,!1),document.removeEventListener("mouseup",this._mouseUpHandler,!1),document.removeEventListener("mousemove",this._mouseMoveHandler,!1),document.removeEventListener("wheel",this._wheelHandler,!1),document.removeEventListener("pointerlockchange",this._pointerlockChangeHandler,!1),document.removeEventListener("pointerlockerror",this._pointerlockErrorHandler,!1),document.removeEventListener("keydown",this._keyDownHandler,!1),document.removeEventListener("keyup",this._keyUpHandler,!1),document.removeEventListener("contextmenu",this._contextMenuHandler,!1),document.pointerLockElement===document.body&&document.exitPointerLock(),this}sync(){return this.owner?(this.owner.rotation.toEuler(St),this.movementX=St.y,this.owner.head.rotation.toEuler(St),this.movementY=St.x,this):this}reset(){this.active=!0,this.movementX=0,this.movementY=0,this.input.forward=!1,this.input.backward=!1,this.input.right=!1,this.input.left=!1,this.input.mouseDown=!1,this.input.sprint=!1,this.isSprinting=!1,es=0,_a.set(0,0,0)}update(e){if(this.active&&this.owner){this._updateVelocity(e);const t=this.owner.getSpeed();es+=e*t,this._updateHead(),this._updateWeapon(),this.input.mouseDown&&this.owner&&(this.owner.world.rift?this.owner.world.rift.weaponSystem.currentConfig.automatic&&this.owner.shoot():this.owner.isAutomaticWeaponUsed()&&this.owner.shoot())}return this}_updateVelocity(e){const t=this.input,s=t.forward&&!t.backward;return this.isSprinting=t.sprint&&s,this}_updateHead(){return this}_updateWeapon(){const e=this.owner;if(!e)return this;const t=e.weaponContainer,s=Math.sin(es*this.weaponMovement);return t.position.x=s*.005,t.position.y=Math.abs(s)*.002,this}}function ba(r){if(this.active&&r.which===1){if(document.pointerLockElement!==document.body){r.preventDefault(),document.body.requestPointerLock();return}r.preventDefault(),this.input.mouseDown=!0,this.owner&&this.owner.shoot()}if(this.active&&r.which===3){if(r.preventDefault(),document.pointerLockElement!==document.body)return;this.owner&&this.owner.world&&this.owner.world.rift&&this.owner.world.rift.weaponSystem.setZoom(!0)}}function Ta(r){this.active&&r.which===1&&(r.preventDefault(),this.input.mouseDown=!1),this.active&&r.which===3&&(r.preventDefault(),this.owner&&this.owner.world&&this.owner.world.rift&&this.owner.world.rift.weaponSystem.setZoom(!1))}function Sa(r){if(this.active&&document.pointerLockElement===document.body){let e=1;this.owner&&this.owner.world&&this.owner.world.rift&&this.owner.world.rift.weaponSystem.isZoomed&&(e=.3),this.movementX-=r.movementX*.001*this.lookingSpeed*e,this.movementY-=r.movementY*.001*this.lookingSpeed*e,this.movementY=Math.max(-ti,Math.min(ti,this.movementY)),this.owner&&(this.owner.rotation.fromEuler(0,this.movementX,0),this.owner.head.rotation.fromEuler(this.movementY,0,0),this.owner.world&&this.owner.world.onMouseMove&&this.owner.world.onMouseMove(r.movementX,r.movementY))}}function Ma(){document.pointerLockElement===document.body?this.dispatchEvent({type:"lock"}):this.dispatchEvent({type:"unlock"})}function Ea(){rn.warn("Dive.FirstPersonControls: Unable to use Pointer Lock API.")}function xa(r){if(this.active)switch(r.keyCode){case 38:case 87:this.input.forward=!0;break;case 37:case 65:this.input.left=!0;break;case 40:case 83:this.input.backward=!0;break;case 39:case 68:this.input.right=!0;break;case 16:this.input.sprint=!0;break;case 32:this.input.jump=!0;break;case 67:case 17:this.input.crouch=!0;break;case 82:if(!this.owner)break;this.owner.reload();break;case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(this.owner&&this.owner.world.rift){const e=r.keyCode-49,t=this.owner.world.rift.weaponSystem.getEquippedWeapons();e<t.length&&this.owner.world.rift.weaponSystem.switchWeapon(e)}else r.keyCode===49&&this.owner?this.owner.changeWeapon(ee):r.keyCode===50&&this.owner&&this.owner.hasWeapon(q)?this.owner.changeWeapon(q):r.keyCode===51&&this.owner&&this.owner.hasWeapon(Q)&&this.owner.changeWeapon(Q);break}}function Aa(r){if(this.active)switch(r.keyCode){case 38:case 87:this.input.forward=!1;break;case 37:case 65:this.input.left=!1;break;case 40:case 83:this.input.backward=!1;break;case 39:case 68:this.input.right=!1;break;case 16:this.input.sprint=!1;break;case 32:this.input.jump=!1;break;case 67:case 17:this.input.crouch=!1;break}}function Ia(r){if(this.active&&this.owner&&this.owner.world.rift){r.preventDefault();const e=r.deltaY>0?1:-1;this.owner.world.rift.weaponSystem.scrollWeapon(e)}}function Ra(r){r.preventDefault()}class Mt{static createConvexRegionHelper(e){const t=e.regions,s=new Ie,i=new K({vertexColors:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-4}),n=new x(s,i);n.matrixAutoUpdate=!1,n.visible=!1;const o=[],a=[],l=new Se;for(let c of t){l.setHex(Math.random()*16777215);let h=c.edge;const d=[];do d.push(h),h=h.next;while(h!==c.edge);const u=d.length-2;for(let p=1,y=u;p<=y;p++){const m=d[0].vertex,f=d[p+0].vertex,_=d[p+1].vertex;o.push(m.x,m.y,m.z),o.push(f.x,f.y,f.z),o.push(_.x,_.y,_.z),a.push(l.r,l.g,l.b),a.push(l.r,l.g,l.b),a.push(l.r,l.g,l.b)}}return s.setAttribute("position",new ct(o,3)),s.setAttribute("color",new ct(a,3)),n}static createPathHelper(){const e=new Ai(new Ie,new Ge({color:16711680}));return e.matrixAutoUpdate=!1,e.visible=!1,e}static createGraphHelper(e,t=1,s=5145796,i=16777215){const n=new X;n.visible=!1;const o=new K({color:s}),a=new Qn(t,2),l=[];e.getNodes(l);for(let y of l){const m=new x(a,o);m.position.copy(y.position),m.userData.nodeIndex=y.index,m.matrixAutoUpdate=!1,m.updateMatrix(),n.add(m)}const c=new Ie,h=[],d=new Ge({color:i}),u=[];for(let y of l){e.getEdgesOfNode(y.index,u);for(let m of u){const f=e.getNode(m.from),_=e.getNode(m.to);h.push(f.position.x,f.position.y,f.position.z),h.push(_.position.x,_.position.y,_.position.z)}}c.setAttribute("position",new ct(h,3));const p=new pt(c,d);return p.matrixAutoUpdate=!1,n.add(p),n}static createCellSpaceHelper(e){const t=e.cells,s=new Ie,i=new Ge({color:16711680}),n=new pt(s,i);n.visible=!1,n.matrixAutoUpdate=!1;const o=[];for(let a=0,l=t.length;a<l;a++){const c=t[a],h=c.aabb.min,d=c.aabb.max;o.push(h.x,h.y,h.z,d.x,h.y,h.z),o.push(h.x,h.y,h.z,h.x,h.y,d.z),o.push(d.x,h.y,d.z,d.x,h.y,h.z),o.push(d.x,h.y,d.z,h.x,h.y,d.z),o.push(h.x,d.y,h.z,d.x,d.y,h.z),o.push(h.x,d.y,h.z,h.x,d.y,d.z),o.push(d.x,d.y,d.z,d.x,d.y,h.z),o.push(d.x,d.y,d.z,h.x,d.y,d.z),o.push(h.x,h.y,h.z,h.x,d.y,h.z),o.push(d.x,h.y,h.z,d.x,d.y,h.z),o.push(d.x,h.y,d.z,d.x,d.y,d.z),o.push(h.x,h.y,d.z,h.x,d.y,d.z)}return s.setAttribute("position",new ct(o,3)),n}}class Ca extends Oe{get renderComponent(){return this._renderComponent||null}constructor(e){super(),this.bvh=new ln().fromMeshGeometry(e),this.canActivateTrigger=!1}handleMessage(){return!0}checkProjectileIntersection(e,t){return e.intersectBVH(this.bvh,t)}lineOfSightTest(e,t){return e.intersectBVH(this.bvh,t)}}class jt extends j{constructor(e){super(e),this.to=null}activate(){const e=this.owner,t=e.path;if(t!==null){if(e.world.debug){const n=e.pathHelper;n.geometry.dispose(),n.geometry=new Ie().setFromPoints(t),n.visible=e.world.uiManager.debugParameter.showPaths}const s=e.steering.behaviors[0];s.active=!0,s.path.clear();const i=e.steering.behaviors[1];i.active=!0;for(let n=0,o=t.length;n<o;n++){const a=t[n];s.path.add(a)}this.to=t[t.length-1]}else this.status=j.STATUS.FAILED}execute(){if(this.active()){const e=this.owner;this.to!==null&&e.atPosition(this.to)&&(this.status=j.STATUS.COMPLETED)}}terminate(){const e=this.owner,t=e.steering.behaviors[0];t.active=!1;const s=e.steering.behaviors[1];s.active=!1}}class Kt extends j{constructor(e,t,s){super(e),this.from=t,this.to=s}activate(){const e=this.owner,t=e.world.pathPlanner;e.path=null,t.findPath(e,this.from,this.to,Pa)}execute(){this.owner.path&&(this.status=j.STATUS.COMPLETED)}}function Pa(r,e){r.path=e}class La extends Ke{constructor(e){super(e)}activate(){this.clearSubgoals();const e=this.owner,t=e.targetSystem.getLastSensedPosition(),s=new b().copy(e.position),i=new b().copy(t);this.addSubgoal(new Kt(e,s,i)),this.addSubgoal(new jt(e))}execute(){const e=this.owner;if(e.targetSystem.isTargetShootable())this.status=j.STATUS.COMPLETED;else if(this.status=this.executeSubgoals(),this.completed()){const t=e.targetSystem.getTarget();e.removeEntityFromMemory(t),e.targetSystem.update()}else this.replanIfFailed()}terminate(){this.clearSubgoals()}}class si extends j{constructor(e,t=new b){super(e),this.target=t}activate(){const t=this.owner.steering.behaviors[2];t.target.copy(this.target),t.active=!0}execute(){this.owner.atPosition(this.target)&&(this.status=j.STATUS.COMPLETED)}terminate(){const e=this.owner.steering.behaviors[2];e.active=!1}}const ka=new b(1,0,0),Da=new b(-1,0,0);class ts extends Ke{constructor(e,t){super(e),this.right=t,this.targetPosition=new b}activate(){this.clearSubgoals();const e=this.owner;this.right?e.canMoveInDirection(ka,this.targetPosition)?this.addSubgoal(new si(e,this.targetPosition)):(this.right=!1,this.status=j.STATUS.INACTIVE):e.canMoveInDirection(Da,this.targetPosition)?this.addSubgoal(new si(e,this.targetPosition)):(this.right=!0,this.status=j.STATUS.INACTIVE)}execute(){this.active()&&(this.owner.targetSystem.isTargetShootable()===!1?this.status=j.STATUS.COMPLETED:(this.status=this.executeSubgoals(),this.replanIfFailed(),this.completed()&&(this.status=j.STATUS.INACTIVE)))}terminate(){this.clearSubgoals()}}class Oa extends Ke{constructor(e){super(e)}activate(){this.clearSubgoals();const e=this.owner,t=e.targetSystem.getTarget(),s=new b().copy(e.position),i=new b().copy(t.position);this.addSubgoal(new Kt(e,s,i)),this.addSubgoal(new jt(e))}execute(){this.owner.targetSystem.isTargetShootable()===!1?this.status=j.STATUS.COMPLETED:(this.status=this.executeSubgoals(),this.replanIfFailed())}terminate(){this.clearSubgoals()}}const Fa=new b(-1,0,0),Na=new b(1,0,0),ii=new b;class ni extends Ke{constructor(e){super(e)}activate(){this.clearSubgoals();const e=this.owner;e.targetSystem.isTargetShootable()===!0?e.canMoveInDirection(Fa,ii)?this.addSubgoal(new ts(e,!1)):e.canMoveInDirection(Na,ii)?this.addSubgoal(new ts(e,!0)):this.addSubgoal(new Oa(e)):this.addSubgoal(new La(e))}execute(){if(this.owner.targetSystem.hasTarget()===!1)this.status=j.STATUS.COMPLETED;else{const t=this.currentSubgoal(),s=this.executeSubgoals();t instanceof ts&&t.inactive()?this.status=j.STATUS.ACTIVE:(this.status=s,this.replanIfFailed())}}terminate(){this.clearSubgoals()}}const ss={distance:1/0,item:null};class De{static totalWeaponStrength(e){const t=e.weaponSystem,s=t.getRemainingAmmoForWeapon(ee),i=t.getRemainingAmmoForWeapon(q),n=t.getRemainingAmmoForWeapon(Q),o=s/w.BLASTER.MAX_AMMO,a=i/w.SHOTGUN.MAX_AMMO,l=n/w.ASSAULT_RIFLE.MAX_AMMO;return(o+a+l)/3}static individualWeaponStrength(e,t){const s=e.weaponSystem.getWeapon(t);return s?s.ammo/s.maxAmmo:0}static health(e){return e.health/e.maxHealth}static distanceToItem(e,t){let s=1;if(e.world.getClosestItem(e,t,ss),ss.item){let i=ss.distance;i=Te.clamp(i,w.BOT.MIN_ITEM_RANGE,w.BOT.MAX_ITEM_RANGE),s=i/w.BOT.MAX_ITEM_RANGE}return s}}class Ba extends Gt{constructor(e=1){super(e),this.tweaker=1}calculateDesirability(e){let t=0;return e.targetSystem.hasTarget()&&(t=this.tweaker*De.totalWeaponStrength(e)*De.health(e)),t}setGoal(e){e.brain.currentSubgoal()instanceof ni||(e.brain.clearSubgoals(),e.brain.addSubgoal(new ni(e)))}}class oi extends Ke{constructor(e){super(e)}activate(){const e=this.owner;this.clearSubgoals();const t=e.world.navMesh.getRandomRegion(),s=new b().copy(e.position),i=new b().copy(t.centroid);this.addSubgoal(new Kt(e,s,i)),this.addSubgoal(new jt(e))}execute(){this.status=this.executeSubgoals(),this.replanIfFailed()}terminate(){this.clearSubgoals()}}class Ha extends Gt{constructor(e=1){super(e)}calculateDesirability(){return .1}setGoal(e){e.brain.currentSubgoal()instanceof oi||(e.brain.clearSubgoals(),e.brain.addSubgoal(new oi(e)))}}const is=new Fe;class za{constructor(e){this.owner=e,this._outerHitbox=new Z,this._outerHitboxDefinition=new Z,this._innerHitboxes=[],this._cache=new Map}init(){this._outerHitboxDefinition.set(new b(-.5,0,-.5),new b(.5,1.8,.5));const t=this.owner._renderComponent,s=this._innerHitboxes;t.updateMatrixWorld(!0);const i=t.getObjectByName("Armature_mixamorigHead"),n=new Z(new b(-.1,1.6,-.1),new b(.1,1.8,.1));let o=new O().copy(i.matrixWorld),a=new O().copy(o).invert();s.push({aabb:n,bone:i,bindMatrix:o,bindMatrixInverse:a});const l=t.getObjectByName("Armature_mixamorigSpine1"),c=new Z(new b(-.2,1,-.2),new b(.2,1.6,.2));o=new O().copy(l.matrixWorld),a=new O().copy(o).invert(),s.push({aabb:c,bone:l,bindMatrix:o,bindMatrixInverse:a});const h=t.getObjectByName("Armature_mixamorigRightArm"),d=new Z(new b(-.4,1.42,-.15),new b(-.2,1.58,.1));o=new O().copy(h.matrixWorld),a=new O().copy(o).invert(),s.push({aabb:d,bone:h,bindMatrix:o,bindMatrixInverse:a});const u=t.getObjectByName("Armature_mixamorigRightForeArm"),p=new Z(new b(-.8,1.42,-.15),new b(-.4,1.55,.05));o=new O().copy(u.matrixWorld),a=new O().copy(o).invert(),s.push({aabb:p,bone:u,bindMatrix:o,bindMatrixInverse:a});const y=t.getObjectByName("Armature_mixamorigLeftArm"),m=new Z(new b(.2,1.42,-.15),new b(.4,1.58,.1));o=new O().copy(y.matrixWorld),a=new O().copy(o).invert(),s.push({aabb:m,bone:y,bindMatrix:o,bindMatrixInverse:a});const f=t.getObjectByName("Armature_mixamorigLeftForeArm"),_=new Z(new b(.4,1.42,-.15),new b(.8,1.55,.05));o=new O().copy(f.matrixWorld),a=new O().copy(o).invert(),s.push({aabb:_,bone:f,bindMatrix:o,bindMatrixInverse:a});const M=t.getObjectByName("Armature_mixamorigRightUpLeg"),E=new Z(new b(-.2,.6,-.15),new b(0,1,.15));o=new O().copy(M.matrixWorld),a=new O().copy(o).invert(),s.push({aabb:E,bone:M,bindMatrix:o,bindMatrixInverse:a});const T=t.getObjectByName("Armature_mixamorigRightLeg"),I=new Z(new b(-.2,0,-.15),new b(0,.6,.15));o=new O().copy(T.matrixWorld),a=new O().copy(o).invert(),s.push({aabb:I,bone:T,bindMatrix:o,bindMatrixInverse:a});const G=t.getObjectByName("Armature_mixamorigLeftUpLeg"),B=new Z(new b(0,.6,-.15),new b(.2,1,.15));o=new O().copy(G.matrixWorld),a=new O().copy(o).invert(),s.push({aabb:B,bone:G,bindMatrix:o,bindMatrixInverse:a});const $=t.getObjectByName("Armature_mixamorigLeftLeg"),Y=new Z(new b(0,0,-.15),new b(.2,.6,.15));return o=new O().copy($.matrixWorld),a=new O().copy(o).invert(),s.push({aabb:Y,bone:$,bindMatrix:o,bindMatrixInverse:a}),this}update(){return this._outerHitbox.copy(this._outerHitboxDefinition).applyMatrix4(this.owner.worldMatrix),this}getCenter(e){return this._outerHitbox.getCenter(e)}intersectRay(e,t){if(e.intersectAABB(this._outerHitbox,t)){const s=this._innerHitboxes;for(let i=0,n=s.length;i<n;i++){const o=s[i],a=o.bone,l=this._getInverseBoneMatrix(a);if(is.copy(e).applyMatrix4(l),is.applyMatrix4(o.bindMatrix),is.intersectAABB(o.aabb,t))return t.applyMatrix4(o.bindMatrixInverse).applyMatrix4(a.matrixWorld),t}}return null}_getInverseBoneMatrix(e){const t=this.owner.world,s=t.tick;let i=this._cache.get(e);return i===void 0?(i={tick:s,inverseBoneMatrix:new O().copy(e.matrixWorld).invert()},this._cache.set(e,i)):i.tick<s?(i.tick=s,i.inverseBoneMatrix.copy(e.matrixWorld).invert()):t.debug&&console.log("DIVE.CharacterBounds: Inverse matrix found in cache for bone."),i.inverseBoneMatrix}}class Cs extends Oe{constructor(e){super(),this.owner=e,this.canActivateTrigger=!1,this.type=null,this.status=us,this.previousState=ce,this.roundsLeft=0,this.roundsPerClip=0,this.ammo=0,this.maxAmmo=0,this.currentTime=0,this.shotTime=1/0,this.reloadTime=1/0,this.equipTime=1/0,this.hideTime=1/0,this.endTimeShot=1/0,this.endTimeReload=1/0,this.endTimeEquip=1/0,this.endTimeHide=1/0,this.endTimeMuzzleFire=1/0,this.fuzzyModule=null,this.muzzle=null,this.audios=null,this.mixer=null,this.animations=null}addRounds(e){return this.ammo=Te.clamp(this.ammo+e,0,this.maxAmmo),this}getRemainingRounds(){return this.ammo}getDesirability(e){return 0}equip(){if(this.status=jo,this.endTimeEquip=this.currentTime+this.equipTime,this.mixer){let e=this.animations.get("hide");e.stop(),e=this.animations.get("equip"),e.stop(),e.play()}return this.owner.isPlayer&&this.owner.world.uiManager.updateAmmoStatus(),this}hide(){if(this.previousState=this.status,this.status=Ko,this.endTimeHide=this.currentTime+this.hideTime,this.mixer){const e=this.animations.get("hide");e.stop(),e.play()}return this}reload(){}shoot(e){}update(e){return this.currentTime+=e,this.currentTime>=this.endTimeEquip&&(this.status=this.previousState,this.endTimeEquip=1/0),this.currentTime>=this.endTimeHide&&(this.status=us,this.endTimeHide=1/0),this.mixer&&this.mixer.update(e),this}}const Et=new b;class Ua extends Cs{constructor(e){super(e),this.type=ee,this.roundsLeft=w.BLASTER.ROUNDS_LEFT,this.roundsPerClip=w.BLASTER.ROUNDS_PER_CLIP,this.ammo=w.BLASTER.AMMO,this.maxAmmo=w.BLASTER.MAX_AMMO,this.shotTime=w.BLASTER.SHOT_TIME,this.reloadTime=w.BLASTER.RELOAD_TIME,this.equipTime=w.BLASTER.EQUIP_TIME,this.hideTime=w.BLASTER.HIDE_TIME,this.muzzleFireTime=w.BLASTER.MUZZLE_TIME}update(e){if(super.update(e),this.currentTime>=this.endTimeReload){const t=this.roundsPerClip-this.roundsLeft;this.ammo>=t?(this.roundsLeft=this.roundsPerClip,this.ammo-=t):(this.roundsLeft+=this.ammo,this.ammo=0),this.owner.isPlayer&&this.owner.world.uiManager.updateAmmoStatus(),this.status=ce,this.endTimeReload=1/0}return this.currentTime>=this.endTimeMuzzleFire&&(this.muzzle.visible=!1,this.endTimeMuzzleFire=1/0),this.currentTime>=this.endTimeShot&&(this.roundsLeft===0?this.ammo===0?this.status=Vt:this.status=Ve:this.status=ce,this.endTimeShot=1/0),this}reload(){this.status=xs;const e=this.audios.get("reload");if(e.isPlaying===!0&&e.stop(),e.play(),this.mixer){const t=this.animations.get("reload");t.stop(),t.play()}return this.endTimeReload=this.currentTime+this.reloadTime,this}shoot(e){this.status=Es;const t=this.audios.get("shot");if(t.isPlaying===!0&&t.stop(),t.play(),this.mixer){const i=this.animations.get("shot");i.stop(),i.play()}this.muzzle.visible=!0,this.muzzle.material.rotation=Math.random()*Math.PI,this.endTimeMuzzleFire=this.currentTime+this.muzzleFireTime;const s=new Fe;return this.getWorldPosition(s.origin),s.direction.subVectors(e,s.origin).normalize(),Et.x=(1-Math.random()*2)*.01,Et.y=(1-Math.random()*2)*.01,Et.z=(1-Math.random()*2)*.01,s.direction.add(Et).normalize(),this.owner.world.addBullet(this.owner,s),this.roundsLeft--,this.endTimeShot=this.currentTime+this.shotTime,this}getDesirability(e){return this.fuzzyModule.fuzzify("distanceToTarget",e),this.fuzzyModule.fuzzify("ammoStatus",this.roundsLeft),this.fuzzyModule.defuzzify("desirability")/100}initAnimations(){const e=this.owner.world.assetManager,t=new ft(this),s=new Map,i=e.animations.get("blaster_shot"),n=e.animations.get("blaster_reload"),o=e.animations.get("blaster_hide"),a=e.animations.get("blaster_equip"),l=t.clipAction(i);l.loop=ne;const c=t.clipAction(n);c.loop=ne;const h=t.clipAction(o);h.loop=ne,h.clampWhenFinished=!0;const d=t.clipAction(a);return d.loop=ne,s.set("shot",l),s.set("reload",c),s.set("hide",h),s.set("equip",d),this.animations=s,this.mixer=t,this}}const xt=new b;class Ga extends Cs{constructor(e){super(e),this.type=q,this.roundsLeft=w.SHOTGUN.ROUNDS_LEFT,this.roundsPerClip=w.SHOTGUN.ROUNDS_PER_CLIP,this.ammo=w.SHOTGUN.AMMO,this.maxAmmo=w.SHOTGUN.MAX_AMMO,this.shotTime=w.SHOTGUN.SHOT_TIME,this.reloadTime=w.SHOTGUN.RELOAD_TIME,this.equipTime=w.SHOTGUN.EQUIP_TIME,this.hideTime=w.SHOTGUN.HIDE_TIME,this.muzzleFireTime=w.SHOTGUN.MUZZLE_TIME,this.bulletsPerShot=w.SHOTGUN.BULLETS_PER_SHOT,this.spread=w.SHOTGUN.SPREAD,this.shotReloadTime=w.SHOTGUN.SHOT_RELOAD_TIME,this.endTimeShotReload=1/0}update(e){if(super.update(e),this.currentTime>=this.endTimeShotReload){const t=this.audios.get("shot_reload");t.isPlaying===!0&&t.stop(),t.play(),this.endTimeShotReload=1/0}if(this.currentTime>=this.endTimeReload){const t=this.roundsPerClip-this.roundsLeft;this.ammo>=t?(this.roundsLeft=this.roundsPerClip,this.ammo-=t):(this.roundsLeft+=this.ammo,this.ammo=0),this.owner.isPlayer&&this.owner.world.uiManager.updateAmmoStatus(),this.status=ce,this.endTimeReload=1/0}return this.currentTime>=this.endTimeMuzzleFire&&(this.muzzle.visible=!1,this.endTimeMuzzleFire=1/0),this.currentTime>=this.endTimeShot&&(this.roundsLeft===0?this.ammo===0?this.status=Vt:this.status=Ve:this.status=ce,this.endTimeShot=1/0),this}reload(){this.status=xs;const e=this.audios.get("reload");if(e.isPlaying===!0&&e.stop(),e.play(),this.mixer){const t=this.animations.get("reload");t.stop(),t.play()}return this.endTimeReload=this.currentTime+this.reloadTime,this}shoot(e){this.status=Es;const t=this.audios.get("shot");if(t.isPlaying===!0&&t.stop(),t.play(),this.mixer){const i=this.animations.get("shot");i.stop(),i.play()}this.muzzle.visible=!0,this.muzzle.material.rotation=Math.random()*Math.PI,this.endTimeMuzzleFire=this.currentTime+this.muzzleFireTime;const s=new Fe;this.getWorldPosition(s.origin),s.direction.subVectors(e,s.origin).normalize();for(let i=0;i<this.bulletsPerShot;i++){const n=s.clone();xt.x=(1-Math.random()*2)*this.spread,xt.y=(1-Math.random()*2)*this.spread,xt.z=(1-Math.random()*2)*this.spread,n.direction.add(xt).normalize(),this.owner.world.addBullet(this.owner,n)}return this.roundsLeft--,this.endTimeShotReload=this.currentTime+this.shotReloadTime,this.endTimeShot=this.currentTime+this.shotTime,this}getDesirability(e){return this.fuzzyModule.fuzzify("distanceToTarget",e),this.fuzzyModule.fuzzify("ammoStatus",this.roundsLeft),this.fuzzyModule.defuzzify("desirability")/100}initAnimations(){const e=this.owner.world.assetManager,t=new ft(this),s=new Map,i=e.animations.get("shotgun_shot"),n=e.animations.get("shotgun_reload"),o=e.animations.get("shotgun_hide"),a=e.animations.get("shotgun_equip"),l=t.clipAction(i);l.loop=ne;const c=t.clipAction(n);c.loop=ne;const h=t.clipAction(o);h.loop=ne,h.clampWhenFinished=!0;const d=t.clipAction(a);return d.loop=ne,s.set("shot",l),s.set("reload",c),s.set("hide",h),s.set("equip",d),this.animations=s,this.mixer=t,this}}const At=new b;class Wa extends Cs{constructor(e){super(e),this.type=Q,this.roundsLeft=w.ASSAULT_RIFLE.ROUNDS_LEFT,this.roundsPerClip=w.ASSAULT_RIFLE.ROUNDS_PER_CLIP,this.ammo=w.ASSAULT_RIFLE.AMMO,this.maxAmmo=w.ASSAULT_RIFLE.MAX_AMMO,this.shotTime=w.ASSAULT_RIFLE.SHOT_TIME,this.reloadTime=w.ASSAULT_RIFLE.RELOAD_TIME,this.equipTime=w.ASSAULT_RIFLE.EQUIP_TIME,this.hideTime=w.ASSAULT_RIFLE.HIDE_TIME,this.muzzleFireTime=w.ASSAULT_RIFLE.MUZZLE_TIME}update(e){if(super.update(e),this.currentTime>=this.endTimeReload){const t=this.roundsPerClip-this.roundsLeft;this.ammo>=t?(this.roundsLeft=this.roundsPerClip,this.ammo-=t):(this.roundsLeft+=this.ammo,this.ammo=0),this.owner.isPlayer&&this.owner.world.uiManager.updateAmmoStatus(),this.status=ce,this.endTimeReload=1/0}return this.currentTime>=this.endTimeMuzzleFire&&(this.muzzle.visible=!1,this.endTimeMuzzleFire=1/0),this.currentTime>=this.endTimeShot&&(this.roundsLeft===0?this.ammo===0?this.status=Vt:this.status=Ve:this.status=ce,this.endTimeShot=1/0),this}reload(){this.status=xs;const e=this.audios.get("reload");if(e.isPlaying===!0&&e.stop(),e.play(),this.mixer){const t=this.animations.get("reload");t.stop(),t.play()}return this.endTimeReload=this.currentTime+this.reloadTime,this}shoot(e){this.status=Es;const t=this.audios.get("shot");if(t.isPlaying===!0&&t.stop(),t.play(),this.mixer){const i=this.animations.get("shot");i.stop(),i.play()}this.muzzle.visible=!0,this.muzzle.material.rotation=Math.random()*Math.PI,this.endTimeMuzzleFire=this.currentTime+this.muzzleFireTime;const s=new Fe;return this.getWorldPosition(s.origin),s.direction.subVectors(e,s.origin).normalize(),At.x=(1-Math.random()*2)*.01,At.y=(1-Math.random()*2)*.01,At.z=(1-Math.random()*2)*.01,s.direction.add(At).normalize(),this.owner.world.addBullet(this.owner,s),this.roundsLeft--,this.endTimeShot=this.currentTime+this.shotTime,this}getDesirability(e){return this.fuzzyModule.fuzzify("distanceToTarget",e),this.fuzzyModule.fuzzify("ammoStatus",this.roundsLeft),this.fuzzyModule.defuzzify("desirability")/100}initAnimations(){const e=this.owner.world.assetManager,t=new ft(this),s=new Map,i=e.animations.get("assaultRifle_shot"),n=e.animations.get("assaultRifle_reload"),o=e.animations.get("assaultRifle_hide"),a=e.animations.get("assaultRifle_equip"),l=t.clipAction(i);l.loop=ne;const c=t.clipAction(n);c.loop=ne;const h=t.clipAction(o);h.loop=ne,h.clampWhenFinished=!0;const d=t.clipAction(a);return d.loop=ne,s.set("shot",l),s.set("reload",c),s.set("hide",h),s.set("equip",d),this.animations=s,this.mixer=t,this}}const ai=new b,we=new b,It=new b;let Ki=class{constructor(e){this.owner=e,this.reactionTime=w.BOT.WEAPON.REACTION_TIME,this.aimAccuracy=w.BOT.WEAPON.AIM_ACCURACY,this.weapons=new Array,this.weaponsMap=new Map,this.weaponsMap.set(ee,null),this.weaponsMap.set(q,null),this.weaponsMap.set(Q,null),this.currentWeapon=null,this.nextWeaponType=null,this.renderComponents={blaster:{mesh:null,audios:new Map,muzzle:null},shotgun:{mesh:null,audios:new Map,muzzle:null},assaultRifle:{mesh:null,audios:new Map,muzzle:null}},this.fuzzyModules={blaster:null,shotGun:null,assaultRifle:null}}init(){return this._initRenderComponents(),this.owner.isPlayer===!1&&this._initFuzzyModules(),this.reset(),this}reset(){for(let e=this.weapons.length-1;e>=0;e--){const t=this.weapons[e];t.type!==null&&this.removeWeapon(t.type)}return this.addWeapon(ee),this.changeWeapon(ee),this.nextWeaponType=null,this.currentWeapon.status=ce,this}selectBestWeapon(){const t=this.owner.targetSystem.getTarget();if(t){let s=0,i=ee;const n=this.owner.position.distanceTo(t.position);for(let o=0,a=this.weapons.length;o<a;o++){const l=this.weapons[o];let c=l.roundsLeft===0?0:l.getDesirability(n);this.currentWeapon!==l&&(c-=w.BOT.WEAPON.CHANGE_COST),c>s&&l.type!==null&&(s=c,i=l.type)}this.setNextWeapon(i)}return this}changeWeapon(e){var s,i,n,o,a,l,c,h,d,u,p,y,m,f,_,M,E,T,I,G,B,$,Y,Ee;const t=this.weaponsMap.get(e);if(t)switch(this.currentWeapon=t,t.type){case ee:(i=(s=this.renderComponents)==null?void 0:s.blaster)!=null&&i.mesh&&(this.renderComponents.blaster.mesh.visible=!1),(o=(n=this.renderComponents)==null?void 0:n.shotgun)!=null&&o.mesh&&(this.renderComponents.shotgun.mesh.visible=!1),(l=(a=this.renderComponents)==null?void 0:a.assaultRifle)!=null&&l.mesh&&(this.renderComponents.assaultRifle.mesh.visible=!1),this.owner.isPlayer&&((h=(c=this.renderComponents)==null?void 0:c.blaster)!=null&&h.mesh)&&t.setRenderComponent(this.renderComponents.blaster.mesh,ns);break;case q:(u=(d=this.renderComponents)==null?void 0:d.blaster)!=null&&u.mesh&&(this.renderComponents.blaster.mesh.visible=!1),(y=(p=this.renderComponents)==null?void 0:p.shotgun)!=null&&y.mesh&&(this.renderComponents.shotgun.mesh.visible=!1),(f=(m=this.renderComponents)==null?void 0:m.assaultRifle)!=null&&f.mesh&&(this.renderComponents.assaultRifle.mesh.visible=!1),this.owner.isPlayer&&((M=(_=this.renderComponents)==null?void 0:_.shotgun)!=null&&M.mesh)&&t.setRenderComponent(this.renderComponents.shotgun.mesh,ns);break;case Q:(T=(E=this.renderComponents)==null?void 0:E.blaster)!=null&&T.mesh&&(this.renderComponents.blaster.mesh.visible=!1),(G=(I=this.renderComponents)==null?void 0:I.shotgun)!=null&&G.mesh&&(this.renderComponents.shotgun.mesh.visible=!1),($=(B=this.renderComponents)==null?void 0:B.assaultRifle)!=null&&$.mesh&&(this.renderComponents.assaultRifle.mesh.visible=!1),this.owner.isPlayer&&((Ee=(Y=this.renderComponents)==null?void 0:Y.assaultRifle)!=null&&Ee.mesh)&&t.setRenderComponent(this.renderComponents.assaultRifle.mesh,ns);break;default:console.error("DIVE.WeaponSystem: Invalid weapon type:",e);break}return this}addWeapon(e){const t=this.owner;let s;switch(e){case ee:s=new Ua(t),s.fuzzyModule=this.fuzzyModules.blaster,s.muzzle=this.renderComponents.blaster.muzzle,s.audios=this.renderComponents.blaster.audios;break;case q:s=new Ga(t),s.fuzzyModule=this.fuzzyModules.shotGun,s.muzzle=this.renderComponents.shotgun.muzzle,s.audios=this.renderComponents.shotgun.audios;break;case Q:s=new Wa(t),s.fuzzyModule=this.fuzzyModules.assaultRifle,s.muzzle=this.renderComponents.assaultRifle.muzzle,s.audios=this.renderComponents.assaultRifle.audios;break;default:console.error("DIVE.WeaponSystem: Invalid weapon type:",e);break}const i=this.weaponsMap.get(e);if(i!=null&&s)i.addRounds(s.getRemainingRounds());else{if(!s)return this;this.weaponsMap.set(e,s),this.weapons.push(s),t.weaponContainer.add(s),t.isPlayer?(s.scale.set(2,2,2),s.position.set(.3,-.3,-1),s.rotation.fromEuler(0,Math.PI,0),s.initAnimations()):s.position.set(-.1,-.2,.5)}return this}removeWeapon(e){const t=this.weaponsMap.get(e);if(t){this.weaponsMap.set(e,null);const s=this.weapons.indexOf(t);this.weapons.splice(s,1),this.owner.weaponContainer.remove(t)}}setNextWeapon(e){return this.currentWeapon.type!==e&&(this.nextWeaponType=e),this}getWeapon(e){return this.weaponsMap.get(e)}showCurrentWeapon(){const e=this.currentWeapon.type;switch(e){case ee:this.renderComponents.blaster.mesh.visible=!0;break;case q:this.renderComponents.shotgun.mesh.visible=!0;break;case Q:this.renderComponents.assaultRifle.mesh.visible=!0;break;default:console.error("DIVE.WeaponSystem: Invalid weapon type:",e);break}return this}hideCurrentWeapon(){var t,s,i;if(!this.currentWeapon)return this;const e=this.currentWeapon.type;switch(e){case ee:(t=this.renderComponents.blaster)!=null&&t.mesh&&(this.renderComponents.blaster.mesh.visible=!1);break;case q:(s=this.renderComponents.shotgun)!=null&&s.mesh&&(this.renderComponents.shotgun.mesh.visible=!1);break;case Q:(i=this.renderComponents.assaultRifle)!=null&&i.mesh&&(this.renderComponents.assaultRifle.mesh.visible=!1);break;default:console.error("DIVE.WeaponSystem: Invalid weapon type:",e);break}return this}getRemainingAmmoForWeapon(e){const t=this.weaponsMap.get(e);return t?t.getRemainingRounds():0}update(e){return this.updateWeaponChange(),this.updateAimAndShot(e),this}updateWeaponChange(){return this.nextWeaponType!==null&&((this.currentWeapon.status===ce||this.currentWeapon.status===Ve||this.currentWeapon.status===Vt)&&this.currentWeapon.hide(),this.currentWeapon.status===us&&(this.changeWeapon(this.nextWeaponType),this.currentWeapon.equip(),this.nextWeaponType=null)),this}updateAimAndShot(e){const t=this.owner,s=t.targetSystem,i=s.getTarget();if(i)if(s.isTargetShootable()){t.resetSearch();const n=t.rotateTo(i.position,e,.05),o=s.getTimeBecameVisible(),a=t.world.time.getElapsed();n===!0&&a-o>=this.reactionTime&&(i.bounds.getCenter(we),this.addNoiseToAim(we),this.shoot(we))}else t.searchAttacker?(we.copy(t.position).add(t.attackDirection),t.rotateTo(we,e)):t.rotateTo(s.getLastSensedPosition(),e);else t.searchAttacker?(we.copy(t.position).add(t.attackDirection),t.rotateTo(we,e)):(ai.copy(t.velocity).normalize(),we.copy(t.position).add(ai),t.rotateTo(we,e));return this}addNoiseToAim(e){const t=this.owner.position.distanceTo(e);It.x=Te.randFloat(-this.aimAccuracy,this.aimAccuracy),It.y=Te.randFloat(-this.aimAccuracy,this.aimAccuracy),It.z=Te.randFloat(-this.aimAccuracy,this.aimAccuracy);const s=w.BOT.WEAPON.NOISE_MAX_DISTANCE,i=Math.min(t,s)/s;return e.add(It.multiplyScalar(i)),e}shoot(e){if(this.owner.isPlayer===!1&&this.owner.riftWeaponSystem)return this.owner._shootRIFT(e),this;const t=this.currentWeapon;switch(t.status){case Ve:t.reload();break;case ce:t.shoot(e);break}return this}reload(){const e=this.currentWeapon;return(e.status===ce||e.status===Ve)&&e.reload(),this}_initRenderComponents(){return this._initBlasterRenderComponent(),this._initShotgunRenderComponent(),this._initAssaultRifleRenderComponent(),this}_initBlasterRenderComponent(){const e=this.owner.world.assetManager;let t;this.owner.isPlayer===!1?(t=e.models.get("blaster_low").clone(),t.scale.set(100,100,100),t.rotation.set(Math.PI*.5,Math.PI,0),t.position.set(0,15,5),t.updateMatrix(),this.owner._renderComponent.getObjectByName("Armature_mixamorigRightHand").add(t)):(t=e.models.get("blaster_high"),this.owner.world.scene.add(t));const s=e.models.get("muzzle").clone();s.material=s.material.clone(),s.position.set(0,.05,.2),s.scale.set(.3,.3,.3),s.updateMatrix(),t.add(s);const i=e.cloneAudio(e.audios.get("blaster_shot"));i.setRolloffFactor(.5),i.setVolume(.4),t.add(i);const n=e.cloneAudio(e.audios.get("reload"));return n.setVolume(.1),t.add(n),this.renderComponents.blaster.mesh=t,this.renderComponents.blaster.audios.set("shot",i),this.renderComponents.blaster.audios.set("reload",n),this.renderComponents.blaster.muzzle=s,this.owner.isPlayer&&(t.visible=!1),this}_initShotgunRenderComponent(){const e=this.owner.world.assetManager;let t;this.owner.isPlayer===!1?(t=e.models.get("shotgun_low").clone(),t.scale.set(100,100,100),t.rotation.set(Math.PI*.5,Math.PI*1.05,0),t.position.set(-5,30,2),t.updateMatrix(),this.owner._renderComponent.getObjectByName("Armature_mixamorigRightHand").add(t)):(t=e.models.get("shotgun_high"),this.owner.world.scene.add(t));const s=e.models.get("muzzle").clone();s.material=s.material.clone(),s.position.set(0,.05,.3),s.scale.set(.4,.4,.4),s.updateMatrix(),t.add(s);const i=e.cloneAudio(e.audios.get("shotgun_shot"));i.setRolloffFactor(.5),i.setVolume(.4),t.add(i);const n=e.cloneAudio(e.audios.get("reload"));n.setVolume(.1),t.add(n);const o=e.cloneAudio(e.audios.get("shotgun_shot_reload"));return o.setVolume(.1),t.add(o),this.renderComponents.shotgun.mesh=t,this.renderComponents.shotgun.audios.set("shot",i),this.renderComponents.shotgun.audios.set("reload",n),this.renderComponents.shotgun.audios.set("shot_reload",o),this.renderComponents.shotgun.muzzle=s,this.owner.isPlayer&&(t.visible=!1),this}_initAssaultRifleRenderComponent(){const e=this.owner.world.assetManager;let t;this.owner.isPlayer===!1?(t=e.models.get("assaultRifle_low").clone(),t.scale.set(100,100,100),t.rotation.set(Math.PI*.5,Math.PI*1,0),t.position.set(-5,20,7),t.updateMatrix(),this.owner._renderComponent.getObjectByName("Armature_mixamorigRightHand").add(t)):(t=e.models.get("assaultRifle_high"),this.owner.world.scene.add(t));const s=e.models.get("muzzle").clone();s.material=s.material.clone(),s.position.set(0,0,.5),s.scale.set(.4,.4,.4),s.updateMatrix(),t.add(s);const i=e.cloneAudio(e.audios.get("assault_rifle_shot"));i.setRolloffFactor(.5),i.setVolume(.8),t.add(i);const n=e.cloneAudio(e.audios.get("reload"));return n.setVolume(.1),t.add(n),this.renderComponents.assaultRifle.mesh=t,this.renderComponents.assaultRifle.audios.set("shot",i),this.renderComponents.assaultRifle.audios.set("reload",n),this.renderComponents.assaultRifle.muzzle=s,this.owner.isPlayer&&(t.visible=!1),this}_initFuzzyModules(){this.fuzzyModules.assaultRifle=new $t,this.fuzzyModules.blaster=new $t,this.fuzzyModules.shotGun=new $t;const e=this.fuzzyModules.assaultRifle,t=this.fuzzyModules.blaster,s=this.fuzzyModules.shotGun,i=new qe,n=new Qe(0,10,20),o=new Ze(10,20,40),a=new Je(20,40,1e3);i.add(n),i.add(o),i.add(a);const l=new qe,c=new Qe(0,25,50),h=new Ze(25,50,75),d=new Je(50,75,100);l.add(c),l.add(h),l.add(d),e.addFLV("desirability",l),e.addFLV("distanceToTarget",i),t.addFLV("desirability",l),t.addFLV("distanceToTarget",i),s.addFLV("desirability",l),s.addFLV("distanceToTarget",i);const u={targetClose:n,targetMedium:o,targetFar:a,undesirable:c,desirable:h,veryDesirable:d};return this._initAssaultRifleFuzzyModule(u),this._initBlasterFuzzyModule(u),this._initShotgunFuzzyModule(u),this}_initBlasterFuzzyModule(e){const t=this.fuzzyModules.blaster,s=new qe,i=new Qe(0,8,15),n=new Ze(8,20,30),o=new Je(20,30,48);return s.add(i),s.add(n),s.add(o),t.addFLV("ammoStatus",s),t.addRule(new P(new L(e.targetClose,i),e.undesirable)),t.addRule(new P(new L(e.targetClose,n),e.desirable)),t.addRule(new P(new L(e.targetClose,o),e.desirable)),t.addRule(new P(new L(e.targetMedium,i),e.desirable)),t.addRule(new P(new L(e.targetMedium,n),e.desirable)),t.addRule(new P(new L(e.targetMedium,o),e.desirable)),t.addRule(new P(new L(e.targetFar,i),e.desirable)),t.addRule(new P(new L(e.targetFar,n),e.desirable)),t.addRule(new P(new L(e.targetFar,o),e.desirable)),this}_initShotgunFuzzyModule(e){const t=this.fuzzyModules.shotGun,s=new qe,i=new Qe(0,2,4),n=new Ze(2,7,10),o=new Je(7,10,12);return s.add(i),s.add(n),s.add(o),t.addFLV("ammoStatus",s),t.addRule(new P(new L(e.targetClose,i),e.desirable)),t.addRule(new P(new L(e.targetClose,n),e.veryDesirable)),t.addRule(new P(new L(e.targetClose,o),e.veryDesirable)),t.addRule(new P(new L(e.targetMedium,i),e.undesirable)),t.addRule(new P(new L(e.targetMedium,n),e.undesirable)),t.addRule(new P(new L(e.targetMedium,o),e.desirable)),t.addRule(new P(new L(e.targetFar,i),e.undesirable)),t.addRule(new P(new L(e.targetFar,n),e.undesirable)),t.addRule(new P(new L(e.targetFar,o),e.undesirable)),this}_initAssaultRifleFuzzyModule(e){const t=this.fuzzyModules.assaultRifle,s=new qe,i=new Qe(0,2,8),n=new Ze(2,10,20),o=new Je(10,20,30);return s.add(i),s.add(n),s.add(o),t.addFLV("ammoStatus",s),t.addRule(new P(new L(e.targetClose,i),e.undesirable)),t.addRule(new P(new L(e.targetClose,n),e.desirable)),t.addRule(new P(new L(e.targetClose,o),e.desirable)),t.addRule(new P(new L(e.targetMedium,i),e.desirable)),t.addRule(new P(new L(e.targetMedium,n),e.veryDesirable)),t.addRule(new P(new L(e.targetMedium,o),e.veryDesirable)),t.addRule(new P(new L(e.targetMedium,i),e.desirable)),t.addRule(new P(new L(e.targetFar,n),e.veryDesirable)),t.addRule(new P(new L(e.targetFar,o),e.veryDesirable)),this}};function ns(r,e){e.matrix.copy(r.worldMatrix)}const nt=new Array,ot=new Array;class Va{constructor(e){this.owner=e,this._currentRecord=null}update(){const e=this.owner.memoryRecords;this._currentRecord=null,nt.length=0,ot.length=0;for(let t=0,s=e.length;t<s;t++){const i=e[t];i.visible?nt.push(i):ot.push(i)}if(nt.length>0){let t=1/0;for(let s=0,i=nt.length;s<i;s++){const n=nt[s],o=this.owner.position.squaredDistanceTo(n.lastSensedPosition);o<t&&(t=o,this._currentRecord=n)}}else if(ot.length>0){let t=-1/0;for(let s=0,i=ot.length;s<i;s++){const n=ot[s];n.timeLastSensed>t&&(t=n.timeLastSensed,this._currentRecord=n)}}return this}reset(){return this._currentRecord=null,this}isTargetShootable(){return this._currentRecord!==null?this._currentRecord.visible:!1}getLastSensedPosition(){return this._currentRecord!==null?this._currentRecord.lastSensedPosition:null}getTimeLastSensed(){return this._currentRecord!==null?this._currentRecord.timeLastSensed:-1}getTimeBecameVisible(){return this._currentRecord!==null?this._currentRecord.timeBecameVisible:-1}getTarget(){return this._currentRecord!==null?this._currentRecord.entity:null}hasTarget(){return this._currentRecord!==null}}const ri={distance:1/0,item:null};class Ut extends Ke{constructor(e,t,s=null){super(e),this.itemType=t,this.item=s,this.regulator=new lt(w.BOT.GOAL.ITEM_VISIBILITY_UPDATE_FREQUENCY)}activate(){const e=this.owner;if(this.clearSubgoals(),e.world.getClosestItem(e,this.itemType,ri),this.item=ri.item,this.item){const t=new b().copy(e.position),s=new b().copy(this.item.position);this.addSubgoal(new Kt(e,t,s)),this.addSubgoal(new jt(e))}else this.status=j.STATUS.FAILED,e.ignoreItem(this.itemType)}execute(){this.active()&&(this.regulator.ready()&&this.owner.vision.visible(this.item.position)?this.item.active===!1?this.status=j.STATUS.FAILED:this.status=this.executeSubgoals():this.status=this.executeSubgoals(),this.replanIfFailed())}terminate(){this.clearSubgoals()}}class ja extends Gt{constructor(e=1,t=gt){super(e),this.itemType=t,this.tweaker=.2}calculateDesirability(e){let t=0;if(e.isItemIgnored(this.itemType)===!1&&e.health<e.maxHealth){const s=De.distanceToItem(e,this.itemType),i=De.health(e);t=this.tweaker*(1-i)/s,t=Te.clamp(t,0,1)}return t}setGoal(e){e.brain.currentSubgoal()instanceof Ut||(e.brain.clearSubgoals(),e.brain.addSubgoal(new Ut(e,this.itemType)))}}class Ka extends Gt{constructor(e=1,t=q){super(e),this.itemType=t,this.tweaker=.15}calculateDesirability(e){let t=0;if(e.isItemIgnored(this.itemType)===!1){const s=De.distanceToItem(e,this.itemType),i=De.individualWeaponStrength(e,this.itemType),n=De.health(e);t=this.tweaker*(1-i)*n/s,t=Te.clamp(t,0,1)}return t}setGoal(e){e.brain.currentSubgoal()instanceof Ut||(e.brain.clearSubgoals(),e.brain.addSubgoal(new Ut(e,this.itemType)))}}var C=(r=>(r.AK47="AK47",r.AWP="AWP",r.LMG="LMG",r.M4="M4",r.Pistol="Pistol",r.Scar="Scar",r.Shotgun="Shotgun",r.Sniper="Sniper",r.Tec9="Tec9",r))(C||{});const D="assets/audio/weapons/",_e={enabled:!0,resetTime:300,scale:.002,vertical:[1,2,3,4,5,6,7,8,8,8,7,6,5],horizontal:[0,0,1,-1,2,-2,3,-3,2,-2,1,-1]},ve={maxFovPunch:5,fovPunch:.5,shakeIntensity:.1,maxChroma:.02,chromaIntensity:.005,shakeDecay:.9,fovPunchRecovery:10,chromaDecay:.8},be={swayAmount:.05,swayRecovery:5,sprintLerpSpeed:10,reloadLerpSpeed:10,baseX:.25,baseY:-.2,baseZ:-.5,bobInfluence:1,sprintOffsetX:-.1,sprintOffsetY:-.1,reloadDipY:.15,reloadRotX:.4,sprintRotZ:.5},oe={[C.AK47]:{name:"AK-47",damage:30,fireRate:10,magSize:30,reserveAmmo:90,reloadTime:2,automatic:!0,falloff:{startDistance:20,endDistance:50,minDamage:15},audio:{fire:D+"AK47-Fire.mp3",reload:D+"LMG-Reload.mp3"},recoil:{pitchAmount:.05,pitchRandom:.02,yawAmount:.02,yawRandom:.03,recoveryRate:5,kickZ:.1,kickRotX:.1},spread:{base:.0015,max:.008,increasePerShot:8e-4,recoveryRate:3},muzzle:{lightColor:16755200,lightRange:5,flashScale:{min:.7,max:1.2},flashDuration:.06,lightIntensity:2.5,smokeParticles:4,smokeSpeed:.6,position:{x:0,y:.04,z:-.8}},sprayPattern:_e,screen:ve,animation:be},[C.AWP]:{name:"AWP",damage:100,fireRate:.8,magSize:10,reserveAmmo:30,reloadTime:2.8,automatic:!1,falloff:{startDistance:100,endDistance:200,minDamage:95},audio:{fire:D+"AWP-Fire.mp3",reload:D+"Sniper-Reload.mp3",zoom:D+"Sniper-Zoom.mp3"},recoil:{pitchAmount:.2,pitchRandom:.05,yawAmount:.05,yawRandom:.05,recoveryRate:2,kickZ:.3,kickRotX:.3},spread:{base:5e-4,max:.006,increasePerShot:.005,recoveryRate:1},muzzle:{lightColor:16763904,lightRange:10,flashScale:{min:1.5,max:2.5},flashDuration:.08,lightIntensity:4,smokeParticles:6,smokeSpeed:.8,position:{x:0,y:.05,z:-1.3}},sprayPattern:_e,screen:{...ve,fovPunch:2,shakeIntensity:.3},animation:be},[C.LMG]:{name:"LMG",damage:25,fireRate:12,magSize:100,reserveAmmo:200,reloadTime:3.5,automatic:!0,audio:{fire:D+"LMG-Fire.mp3",reload:D+"LMG-Reload.mp3"},recoil:{pitchAmount:.04,pitchRandom:.03,yawAmount:.03,yawRandom:.04,recoveryRate:4,kickZ:.15,kickRotX:.15},spread:{base:.0025,max:.012,increasePerShot:4e-4,recoveryRate:2},muzzle:{lightColor:16755200,lightRange:6,flashScale:{min:.8,max:1.4},flashDuration:.07,lightIntensity:2.8,smokeParticles:5,smokeSpeed:.7,position:{x:0,y:0,z:-.95}},sprayPattern:_e,screen:ve,animation:be},[C.M4]:{name:"M4",damage:28,fireRate:11,magSize:30,reserveAmmo:90,reloadTime:1.8,automatic:!0,audio:{fire:D+"M4-Fire.mp3",reload:D+"LMG-Reload.mp3"},recoil:{pitchAmount:.04,pitchRandom:.01,yawAmount:.01,yawRandom:.02,recoveryRate:6,kickZ:.08,kickRotX:.08},spread:{base:.0012,max:.007,increasePerShot:7e-4,recoveryRate:4},muzzle:{lightColor:16777130,lightRange:4.5,flashScale:{min:.6,max:1},flashDuration:.05,lightIntensity:2.2,smokeParticles:3,smokeSpeed:.5,position:{x:0,y:.02,z:-.6}},sprayPattern:_e,screen:ve,animation:be},[C.Pistol]:{name:"Pistol",damage:20,fireRate:6,magSize:12,reserveAmmo:48,reloadTime:1.2,automatic:!1,audio:{fire:D+"Pistol-Fire.mp3",reload:D+"Pistol-Reload.mp3"},recoil:{pitchAmount:.08,pitchRandom:.02,yawAmount:.01,yawRandom:.01,recoveryRate:8,kickZ:.05,kickRotX:.05},spread:{base:.001,max:.005,increasePerShot:.0015,recoveryRate:5},muzzle:{lightColor:16777164,lightRange:3,flashScale:{min:.3,max:.6},flashDuration:.04,lightIntensity:1.5,smokeParticles:2,smokeSpeed:.4,position:{x:0,y:.05,z:-.15}},sprayPattern:_e,screen:ve,animation:be},[C.Scar]:{name:"SCAR",damage:35,fireRate:9,magSize:20,reserveAmmo:60,reloadTime:2.4,automatic:!0,audio:{fire:D+"Scar-Fire-1.mp3",reload:D+"Scar-Reload.mp3",tail:D+"Scar-Tail-Fire.mp3"},recoil:{pitchAmount:.06,pitchRandom:.02,yawAmount:.02,yawRandom:.02,recoveryRate:4,kickZ:.12,kickRotX:.12},spread:{base:.0018,max:.009,increasePerShot:.001,recoveryRate:3},muzzle:{lightColor:16759552,lightRange:5.5,flashScale:{min:.9,max:1.5},flashDuration:.065,lightIntensity:2.7,smokeParticles:4,smokeSpeed:.65,position:{x:0,y:.08,z:-.5}},sprayPattern:_e,screen:ve,animation:be},[C.Shotgun]:{name:"Shotgun",damage:15,fireRate:1.5,magSize:8,reserveAmmo:32,reloadTime:2.5,automatic:!1,pelletCount:8,falloff:{startDistance:5,endDistance:20,minDamage:3},audio:{fire:D+"Shotgun-Fire.mp3",reload:D+"Shotgun-Load.mp3",cock:D+"Shotgun-Cock.mp3"},recoil:{pitchAmount:.3,pitchRandom:.1,yawAmount:.1,yawRandom:.1,recoveryRate:2,kickZ:.4,kickRotX:.4},spread:{base:.035,max:.055,increasePerShot:.012,recoveryRate:2},muzzle:{lightColor:16755251,lightRange:7,flashScale:{min:1.2,max:2},flashDuration:.075,lightIntensity:3.5,smokeParticles:7,smokeSpeed:.9,position:{x:0,y:.02,z:-1}},sprayPattern:_e,screen:{...ve,fovPunch:1.5,shakeIntensity:.2},animation:be},[C.Sniper]:{name:"Sniper Rifle",damage:90,fireRate:1,magSize:5,reserveAmmo:20,reloadTime:2.8,automatic:!1,audio:{fire:D+"Sniper-Fire.mp3",reload:D+"Sniper-Reload.mp3",load:D+"Sniper-Load.mp3",zoom:D+"Sniper-Zoom.mp3"},recoil:{pitchAmount:.25,pitchRandom:.05,yawAmount:.05,yawRandom:.05,recoveryRate:2,kickZ:.35,kickRotX:.35},spread:{base:3e-4,max:.005,increasePerShot:.004,recoveryRate:1},muzzle:{lightColor:16777181,lightRange:8,flashScale:{min:1.3,max:2.2},flashDuration:.08,lightIntensity:3.8,smokeParticles:5,smokeSpeed:.75,position:{x:0,y:.05,z:-1.25}},sprayPattern:_e,screen:{...ve,fovPunch:2,shakeIntensity:.3},animation:be},[C.Tec9]:{name:"Tec-9",damage:22,fireRate:14,magSize:24,reserveAmmo:72,reloadTime:1.6,automatic:!0,audio:{fire:D+"Tec-9-Fire.mp3",reload:D+"Tec-9-Reload.mp3",load:D+"Tec-9-Load.mp3",tail:D+"Tec-9-Tail-Fire.mp3"},recoil:{pitchAmount:.06,pitchRandom:.03,yawAmount:.04,yawRandom:.04,recoveryRate:6,kickZ:.07,kickRotX:.07},spread:{base:.003,max:.011,increasePerShot:6e-4,recoveryRate:4},muzzle:{lightColor:16768392,lightRange:4,flashScale:{min:.5,max:.9},flashDuration:.045,lightIntensity:2,smokeParticles:3,smokeSpeed:.55,position:{x:0,y:.05,z:-.35}},sprayPattern:_e,screen:ve,animation:be}};class $i{constructor(e,t,s,i){this.muzzleFlashTimer=0,this.muzzleFlashDuration=.05,this.currentWeapon=C.AK47,this.weaponStates=new Map,this.isZoomed=!1,this.currentRecoil={x:0,y:0},this.targetRecoil={x:0,y:0},this.currentSpread=0,this.weaponSwayX=0,this.weaponSwayY=0,this.weaponKickZ=0,this.weaponKickRotX=0,this.sprintBlend=0,this.reloadBlend=0,this.zoomBlend=0,this.isThirdPerson=!1,this.thirdPersonParent=null,this.camera=t,this.audioManager=i,this.initializeWeaponStates(),this.loadAllAudio(),this.initializeMuzzleFlash(),this.resetWeaponState()}setShellEjectCallback(e){this.shellEjectCallback=e}setZoomCallback(e){this.zoomCallback=e}setZoom(e){return this.currentWeapon!==C.Sniper&&this.currentWeapon!==C.AWP||this.isZoomed===e?!1:(this.isZoomed=e,this.zoomCallback&&this.zoomCallback(e),!0)}setThirdPersonMode(e){this.isThirdPerson=!0,this.thirdPersonParent=e,this.weaponMesh&&(this.weaponMesh.parent&&this.weaponMesh.parent.remove(this.weaponMesh),this.weaponMesh.scale.set(.7,.7,.7),this.weaponMesh.position.set(0,0,0),this.weaponMesh.rotation.set(0,Math.PI,0),e.add(this.weaponMesh))}initializeWeaponStates(){Object.values(oe).forEach(e=>{const t=Object.keys(oe).find(s=>oe[s]===e);t&&this.weaponStates.set(t,{currentMag:e.magSize,reserveAmmo:e.reserveAmmo,lastShotTime:0,isReloading:!1,reloadStartTime:0})})}initializeMuzzleFlash(){const e=oe[this.currentWeapon],t=e.muzzle.position,s=new le({color:16777130,transparent:!0,opacity:0,blending:Ft});this.muzzleFlash=new te(s),this.muzzleFlash.scale.set(.3,.3,1),this.muzzleFlash.position.set(t.x,t.y,t.z);const i=new le({color:16755200,transparent:!0,opacity:0,blending:Ft});this.muzzleFlash2=new te(i),this.muzzleFlash2.scale.set(.2,.2,1),this.muzzleFlash2.position.set(t.x,t.y,t.z-.02),this.muzzleLight=new Si(e.muzzle.lightColor,0,e.muzzle.lightRange),this.muzzleLight.position.copy(this.muzzleFlash.position)}loadAllAudio(){const e=new Set;Object.values(oe).forEach(t=>{Object.values(t.audio).forEach(s=>{s&&typeof s=="string"&&!e.has(s)&&(this.audioManager.loadAudio(s),e.add(s))})})}get currentConfig(){return oe[this.currentWeapon]}getEquippedWeapons(){return Object.values(C)}switchWeapon(e){if(this.isZoomed&&this.setZoom(!1),typeof e=="number"){const s=this.getEquippedWeapons();e>=0&&e<s.length&&(this.currentWeapon=s[e])}else this.currentWeapon=e;const t=this.weaponStates.get(this.currentWeapon);t&&(t.isReloading=!1),this.resetWeaponState()}scrollWeapon(e){const t=this.getEquippedWeapons();let s=t.indexOf(this.currentWeapon);e>0?s=(s+1)%t.length:s=(s-1+t.length)%t.length,this.switchWeapon(t[s])}get isReloading(){var e;return((e=this.weaponStates.get(this.currentWeapon))==null?void 0:e.isReloading)||!1}get currentMag(){var e;return((e=this.weaponStates.get(this.currentWeapon))==null?void 0:e.currentMag)||0}get reserveAmmo(){var e;return((e=this.weaponStates.get(this.currentWeapon))==null?void 0:e.reserveAmmo)||0}getCurrentSpread(){return this.currentSpread}getMuzzleWorldPosition(){const t=oe[this.currentWeapon].muzzle.position,i=new S(.25,-.25,-.4).clone();return i.x+=t.x,i.y+=t.y,i.z+=t.z,i.applyMatrix4(this.camera.matrixWorld),i}getEjectionPortPosition(){const e=new S(.25,-.25,-.4);return e.x+=.08,e.y+=.05,e.z+=-.1,e.applyMatrix4(this.camera.matrixWorld),e}getEjectionDirection(){const e=new S(.8+Math.random()*.4,.5+Math.random()*.3,.1+Math.random()*.2);return e.applyQuaternion(this.camera.quaternion),e.normalize()}shoot(e,t,s,i){const n=oe[this.currentWeapon],o=this.weaponStates.get(this.currentWeapon);if(!n||!o)return{shotFired:!1,direction:new S};const a=performance.now(),l=1e3/n.fireRate;if(o.isReloading||o.currentMag<=0||a-o.lastShotTime<l)return o.currentMag<=0&&!o.isReloading&&o.reserveAmmo>0&&this.reload(),{shotFired:!1,direction:new S};if(s)return{shotFired:!1,direction:new S};if(o.lastShotTime=a,o.currentMag--,n.audio.fire&&this.audioManager.playSound(n.audio.fire,"sfx",{volume:.5}),this.applyRecoil(n.recoil),this.currentSpread=Math.min(this.currentSpread+n.spread.increasePerShot,n.spread.max),this.triggerMuzzleFlash(),this.shellEjectCallback){const d=this.getEjectionPortPosition(),u=this.getEjectionDirection();this.shellEjectCallback(d,u)}const c=e.getWorldDirection(new S),h=new ki(this.currentRecoil.y,this.currentRecoil.x,0,"YXZ");if(c.applyEuler(h),n.pelletCount&&n.pelletCount>1){const d=[];for(let u=0;u<n.pelletCount;u++){const p=c.clone();this.applySpread(p,this.currentSpread*2),d.push(p)}return{shotFired:!0,direction:c,directions:d}}else return this.applySpread(c,this.currentSpread),{shotFired:!0,direction:c}}applySpread(e,t){const s=Math.random()*2-1,i=Math.random()*2-1,n=new S().crossVectors(e,new S(0,1,0)).normalize(),o=new S().crossVectors(n,e).normalize();e.addScaledVector(n,s*t),e.addScaledVector(o,i*t),e.normalize()}applyRecoil(e){this.targetRecoil.x+=(Math.random()-.5)*e.yawAmount,this.targetRecoil.y+=e.pitchAmount,this.weaponKickZ=e.kickZ,this.weaponKickRotX=e.kickRotX*Math.PI/180,console.log("Recoil applied - kickZ:",this.weaponKickZ,"kickRotX:",this.weaponKickRotX,"config:",e)}triggerMuzzleFlash(){const e=oe[this.currentWeapon];this.muzzleFlashTimer=e.muzzle.flashDuration,this.muzzleFlashDuration=e.muzzle.flashDuration,this.muzzleFlash.material.opacity=1.2,this.muzzleFlash2.material.opacity=.9,this.muzzleLight.intensity=e.muzzle.lightIntensity,this.muzzleFlash.material.rotation=Math.random()*Math.PI*2,this.muzzleFlash2.material.rotation=Math.random()*Math.PI*2}reload(){const e=this.weaponStates.get(this.currentWeapon),t=oe[this.currentWeapon];!e||!t||e.isReloading||e.currentMag===t.magSize||e.reserveAmmo<=0||(this.isZoomed&&this.setZoom(!1),e.isReloading=!0,e.reloadStartTime=performance.now(),t.audio.reload&&this.audioManager.playSound(t.audio.reload,"sfx",{volume:.5}))}update(e,t,s,i=0){const n=oe[this.currentWeapon],o=this.weaponStates.get(this.currentWeapon);if(!n||!o)return;if(o.isReloading&&performance.now()-o.reloadStartTime>=n.reloadTime*1e3){const p=n.magSize-o.currentMag,y=Math.min(p,o.reserveAmmo);o.currentMag+=y,o.reserveAmmo-=y,o.isReloading=!1}this.currentRecoil.x=J.lerp(this.currentRecoil.x,this.targetRecoil.x,e*10),this.currentRecoil.y=J.lerp(this.currentRecoil.y,this.targetRecoil.y,e*10),this.targetRecoil.x=J.lerp(this.targetRecoil.x,0,e*n.recoil.recoveryRate),this.targetRecoil.y=J.lerp(this.targetRecoil.y,0,e*n.recoil.recoveryRate);const a=s?n.spread.base*2:n.spread.base;this.currentSpread=J.lerp(this.currentSpread,a,e*n.spread.recoveryRate),this.weaponKickZ*=1-5*e,this.weaponKickRotX*=1-5*e;const l=.01,c=8;this.weaponSwayX+=(t.x*l-this.weaponSwayX)*c*e,this.weaponSwayY+=(t.y*l-this.weaponSwayY)*c*e;const h=s?1:0;this.sprintBlend+=(h-this.sprintBlend)*8*e;const d=o.isReloading?1:0;this.reloadBlend+=(d-this.reloadBlend)*8*e;const u=this.isZoomed?1:0;if(this.zoomBlend+=(u-this.zoomBlend)*10*e,this.muzzleFlashTimer>0)if(this.muzzleFlashTimer-=e,this.muzzleFlashTimer<=0)this.muzzleFlashTimer=0,this.muzzleFlash.material.opacity=0,this.muzzleFlash2.material.opacity=0,this.muzzleLight.intensity=0;else{const p=this.muzzleFlashTimer/this.muzzleFlashDuration;this.muzzleFlash.material.opacity=p*1.2,this.muzzleFlash2.material.opacity=p*.9,this.muzzleLight.intensity=p*n.muzzle.lightIntensity,this.muzzleFlash.material.rotation+=e*10,this.muzzleFlash2.material.rotation-=e*10}this.updateWeaponTransform(e,i)}updateWeaponTransform(e,t){if(!this.weaponMesh)return;if(this.isThirdPerson){const p=this.weaponKickZ*.5;this.weaponMesh.position.z=p;return}const s=.7;if(this.zoomBlend>s){const p=(this.zoomBlend-s)/(1-s);this.weaponMesh.visible=p<.99}else this.weaponMesh.visible=!0;let i=.25-this.weaponSwayX,n=-.25-this.weaponSwayY,o=-.4;const a=1-this.zoomBlend*.8,l=Math.cos(t*.5)*.015*a,c=Math.sin(t)*.035*a;i+=l,n+=c,o+=this.weaponKickZ,i+=.1*this.sprintBlend,n-=.2*this.sprintBlend,n-=.15*this.reloadBlend,n+=.15*this.zoomBlend,o-=.2*this.zoomBlend,i-=.15*this.zoomBlend;let h=-this.weaponKickRotX+.3*this.reloadBlend,d=.2*this.sprintBlend;h+=.1*this.zoomBlend;const u=15;this.weaponMesh.position.x+=(i-this.weaponMesh.position.x)*u*e,this.weaponMesh.position.y+=(n-this.weaponMesh.position.y)*u*e,this.weaponMesh.position.z+=(o-this.weaponMesh.position.z)*u*e,this.weaponMesh.rotation.x+=(h-this.weaponMesh.rotation.x)*u*e,this.weaponMesh.rotation.z+=(d-this.weaponMesh.rotation.z)*u*e}resetWeaponState(){console.log("DEBUG: resetWeaponState START"),this.weaponMesh&&this.weaponMesh.parent&&this.weaponMesh.parent.remove(this.weaponMesh);const e=this.createWeaponModel();this.weaponMesh=e;const t=oe[this.currentWeapon],s=t.muzzle.position;this.muzzleFlash.position.set(s.x,s.y,s.z),this.muzzleFlash2.position.set(s.x,s.y,s.z-.02),this.muzzleLight.position.copy(this.muzzleFlash.position),this.muzzleLight.color.setHex(t.muzzle.lightColor),this.muzzleLight.distance=t.muzzle.lightRange,this.weaponMesh.add(this.muzzleFlash),this.weaponMesh.add(this.muzzleFlash2),this.weaponMesh.add(this.muzzleLight),this.isThirdPerson&&this.thirdPersonParent?(this.weaponMesh.scale.set(.7,.7,.7),this.weaponMesh.position.set(0,0,0),this.weaponMesh.rotation.set(0,Math.PI,0),this.thirdPersonParent.add(this.weaponMesh),console.log("DEBUG: Weapon added to third-person parent")):(this.weaponMesh.scale.set(1,1,1),this.weaponMesh.position.set(.25,-.25,-.4),this.camera.add(this.weaponMesh),console.log("DEBUG: Weapon added to camera. Weapon UUID:",this.weaponMesh.uuid),console.log("DEBUG: Camera UUID:",this.camera.uuid))}createWeaponModel(){switch(this.currentWeapon){case C.AK47:return this.createAK47Model();case C.AWP:return this.createAWPModel();case C.LMG:return this.createLMGModel();case C.M4:return this.createM4Model();case C.Pistol:return this.createPistolModel();case C.Scar:return this.createScarModel();case C.Shotgun:return this.createShotgunModel();case C.Sniper:return this.createSniperModel();case C.Tec9:return this.createTec9Model();default:return this.createAK47Model()}}createAK47Model(){const e=new X,t=new x(new N(.08,.12,.6),new R({color:6111287,metalness:.1,roughness:.8}));t.position.set(0,0,-.1),e.add(t);const s=new x(new N(.09,.13,.3),new R({color:2236962,metalness:.8,roughness:.4}));s.position.set(0,.01,-.1),e.add(s);const i=new x(new me(.02,.02,.6),new R({color:1118481,metalness:.9,roughness:.3}));i.rotation.x=Math.PI/2,i.position.set(0,.04,-.5),e.add(i);const n=new x(new N(.04,.25,.08),new R({color:3355443}));return n.position.set(0,-.15,-.05),n.rotation.x=.3,e.add(n),e}createAWPModel(){const e=new X,t=new x(new N(.1,.15,.8),new R({color:3046706,metalness:.2,roughness:.7}));t.position.set(0,0,-.2),e.add(t);const s=new x(new me(.025,.025,1),new R({color:1118481}));s.rotation.x=Math.PI/2,s.position.set(0,.05,-.8),e.add(s);const i=new x(new me(.04,.05,.3),new R({color:1118481}));return i.rotation.x=Math.PI/2,i.position.set(0,.12,-.1),e.add(i),e}createLMGModel(){const e=new X,t=new x(new N(.15,.2,.7),new R({color:4342338}));t.position.set(0,0,-.1),e.add(t);const s=new x(new N(.12,.2,.15),new R({color:3046706}));s.position.set(0,-.15,0),e.add(s);const i=new x(new me(.03,.03,.7),new R({color:1118481}));return i.rotation.x=Math.PI/2,i.position.set(0,0,-.6),e.add(i),e}createM4Model(){const e=new X,t=new x(new N(.08,.12,.5),new R({color:1710618}));t.position.set(0,0,-.1),e.add(t);const s=new x(new N(.09,.09,.35),new R({color:2236962}));s.position.set(0,.02,-.4),e.add(s);const i=new x(new N(.02,.06,.15),new R({color:1118481}));return i.position.set(0,.1,-.1),e.add(i),e}createPistolModel(){const e=new X,t=new x(new N(.06,.08,.25),new R({color:12436423,metalness:.8}));t.position.set(0,.05,0),e.add(t);const s=new x(new N(.05,.15,.07),new R({color:2899536}));return s.position.set(0,-.05,.05),s.rotation.x=-.2,e.add(s),e}createScarModel(){const e=new X,t=new x(new N(.1,.15,.6),new R({color:13808780}));t.position.set(0,0,-.1),e.add(t);const s=new x(new N(.1,.08,.7),new R({color:12756092}));s.position.set(0,.08,-.15),e.add(s);const i=new x(new N(.04,.2,.08),new R({color:2236962}));return i.position.set(0,-.15,-.05),e.add(i),e}createShotgunModel(){const e=new X,t=new x(new N(.1,.12,.5),new R({color:3355443}));t.position.set(0,0,-.1),e.add(t);const s=new x(new me(.03,.03,.8),new R({color:1118481}));s.rotation.x=Math.PI/2,s.position.set(0,.02,-.6),e.add(s);const i=new x(new N(.08,.06,.2),new R({color:6111287}));return i.position.set(0,-.05,-.5),e.add(i),e}createSniperModel(){const e=new X,t=new x(new N(.08,.1,.7),new R({color:2236962}));t.position.set(0,0,-.2),e.add(t);const s=new x(new me(.02,.02,.9),new R({color:1118481}));s.rotation.x=Math.PI/2,s.position.set(0,.05,-.8),e.add(s);const i=new x(new me(.035,.04,.25),new R({color:1118481}));return i.rotation.x=Math.PI/2,i.position.set(0,.1,-.1),e.add(i),e}createTec9Model(){const e=new X,t=new x(new N(.06,.08,.3),new R({color:2236962}));t.position.set(0,.05,0),e.add(t);const s=new x(new me(.03,.03,.2),new R({color:1118481,wireframe:!1}));s.rotation.x=Math.PI/2,s.position.set(0,.05,-.25),e.add(s);const i=new x(new N(.03,.2,.05),new R({color:1118481}));return i.position.set(0,-.1,-.1),e.add(i),e}}const Rt=new Array,Ct=[0,0,0,0],Pt=[{direction:new b(0,0,1),name:"soldier_forward"},{direction:new b(0,0,-1),name:"soldier_backward"},{direction:new b(-1,0,0),name:"soldier_left"},{direction:new b(1,0,0),name:"soldier_right"}],li=new b,ci=new b,hi=new gn,di=new b,ui=new b,os=new b;class mi extends cn{constructor(e){super(),this.riftWeaponSystem=null,this.enemyCamera=null,this.world=e,this.currentTime=0,this.boundingRadius=w.BOT.BOUNDING_RADIUS,this.maxSpeed=w.BOT.MOVEMENT.MAX_SPEED,this.updateOrientation=!1,this.health=w.BOT.MAX_HEALTH,this.maxHealth=w.BOT.MAX_HEALTH,this.status=V,this.isPlayer=!1,this.currentRegion=null,this.currentPosition=new b,this.previousPosition=new b,this.searchAttacker=!1,this.attackDirection=new b,this.endTimeSearch=1/0,this.searchTime=w.BOT.SEARCH_FOR_ATTACKER_TIME,this.ignoreHealth=!1,this.ignoreWeapons=!1,this.ignoreShotgun=!1,this.ignoreAssaultRifle=!1,this.endTimeIgnoreHealth=1/0,this.endTimeIgnoreShotgun=1/0,this.endTimeIgnoreAssaultRifle=1/0,this.ignoreItemsTimeout=w.BOT.IGNORE_ITEMS_TIMEOUT,this.endTimeDying=1/0,this.dyingTime=w.BOT.DYING_TIME,this.head=new Oe,this.head.position.y=w.BOT.HEAD_HEIGHT,this.add(this.head),this.weaponContainer=new Oe,this.head.add(this.weaponContainer),this.bounds=new za(this),this.mixer=null,this.animations=new Map,this.brain=new hn(this),this.brain.addEvaluator(new Ba),this.brain.addEvaluator(new ja),this.brain.addEvaluator(new Ka),this.brain.addEvaluator(new Ha),this.goalArbitrationRegulator=new lt(w.BOT.GOAL_ARBITRATION_FREQUENCY),this.memorySystem=new dn(this),this.memorySystem.memorySpan=w.BOT.MEMORY.SPAN,this.memoryRecords=new Array;const t=new un;t.active=!1,t.nextWaypointDistance=w.BOT.NAVIGATION.NEXT_WAYPOINT_DISTANCE,t._arrive.deceleration=w.BOT.NAVIGATION.ARRIVE_DECELERATION,this.steering.add(t);const s=new mn;s.active=!1,s.path=t.path,s.radius=w.BOT.NAVIGATION.PATH_RADIUS,s.weight=w.BOT.NAVIGATION.ONPATH_WEIGHT,this.steering.add(s);const i=new pn;i.active=!1,this.steering.add(i),this.vision=new fn(this.head),this.vision.fieldOfView=w.BOT.VISION.FOV,this.vision.range=w.BOT.VISION.RANGE,this.visionRegulator=new lt(w.BOT.VISION.UPDATE_FREQUENCY),this.targetSystem=new Va(this),this.targetSystemRegulator=new lt(w.BOT.TARGET_SYSTEM.UPDATE_FREQUENCY),this.weaponSystem=new Ki(this),this.weaponSelectionRegulator=new lt(w.BOT.WEAPON.UPDATE_FREQUENCY),this.pathHelper=null,this.hitboxHelper=null}get renderComponent(){return this._renderComponent||null}start(){const e=this.animations.get("soldier_forward");e.enabled=!0;const t=this.manager.getEntityByName("level");return t&&this.vision.addObstacle(t),this.bounds.init(),this.weaponSystem.init(),this._initRIFTWeaponSystem(),this}update(e){return super.update(e),this.currentTime+=e,this.stayInLevel(),this.status===V&&(this.bounds.update(),this.visionRegulator.ready()&&this.updateVision(),this.memorySystem.getValidMemoryRecords(this.currentTime,this.memoryRecords),this.targetSystemRegulator.ready()&&this.targetSystem.update(),this.brain.execute(),this.goalArbitrationRegulator.ready()&&this.brain.arbitrate(),this.weaponSelectionRegulator.ready()&&this.weaponSystem.selectBestWeapon(),this.currentTime>=this.endTimeSearch&&this.resetSearch(),this.currentTime>=this.endTimeIgnoreHealth&&(this.ignoreHealth=!1),this.currentTime>=this.endTimeIgnoreShotgun&&(this.ignoreShotgun=!1),this.currentTime>=this.endTimeIgnoreAssaultRifle&&(this.ignoreAssaultRifle=!1),this.weaponSystem.update(e),this.riftWeaponSystem&&this.enemyCamera&&this.riftWeaponSystem.update(e,{x:0,y:0},!1,this.currentTime)),this.status===Nt&&this.currentTime>=this.endTimeDying&&(this.status=Bt,this.endTimeDying=1/0),this.status===Bt&&(this.world.debug&&console.log("DIVE.Enemy: Enemy with ID %s died.",this.uuid),this.reset(),this.world.spawningManager.respawnCompetitor(this)),this.updateAnimations(e),this}stayInLevel(){this.currentPosition.copy(this.position),this.currentRegion=this.world.navMesh.clampMovement(this.currentRegion,this.previousPosition,this.currentPosition,this.position),this.previousPosition.copy(this.position);const e=this.currentRegion.plane.distanceToPoint(this.position);return this.position.y-=e*w.NAVMESH.HEIGHT_CHANGE_FACTOR,this}updateVision(){const e=this.memorySystem,t=this.vision,s=this.world.competitors;for(let i=0,n=s.length;i<n;i++){const o=s[i];if(o===this||o.status!==V)continue;e.hasRecord(o)===!1&&e.createRecord(o);const a=e.getRecord(o);o.head.getWorldPosition(ui),a&&t.visible(ui)===!0&&o.active?(a.timeLastSensed=this.currentTime,a.lastSensedPosition.copy(o.position),a.visible===!1&&(a.timeBecameVisible=this.currentTime),a.visible=!0):a&&(a.visible=!1)}return this}updateAnimations(e){if(this.status===V){this.getDirection(li),ci.copy(this.velocity).normalize(),hi.lookAt(this.forward,ci,this.up),Rt.length=0;let t=0;for(let s=0,i=Pt.length;s<i;s++){di.copy(Pt[s].direction).applyRotation(hi);const n=di.dot(li);Ct[s]=n<0?0:n;const o=this.animations.get(Pt[s].name);Ct[s]>.001?(o.enabled=!0,Rt.push(s),t+=Ct[s]):(o.enabled=!1,o.weight=0)}for(let s=0,i=Rt.length;s<i;s++){const n=Rt[s],o=this.animations.get(Pt[n].name);o.weight=Ct[n]/t,o.timeScale=this.getSpeed()/this.maxSpeed}}return this.mixer.update(e),this}addHealth(e){return this.health+=e,this.health=Math.min(this.health,this.maxHealth),this.world.debug&&console.log("DIVE.Enemy: Entity with ID %s receives %i health points.",this.uuid,e),this}addWeapon(e){return this.weaponSystem.addWeapon(e),this.world.uiManager.updateAmmoStatus(),this.targetSystem.hasTarget()===!1&&this.weaponSystem.setNextWeapon(e),this}setAnimations(e,t){this.mixer=e;for(const s of t){const i=e.clipAction(s);i.play(),i.enabled=!1,i.name=s.name,this.animations.set(i.name,i)}return this}reset(){this.health=this.maxHealth,this.status=V,this.resetSearch(),this.ignoreHealth=!1,this.ignoreWeapons=!1,this.brain.clearSubgoals(),this.memoryRecords.length=0,this.memorySystem.clear(),this.targetSystem.reset(),this.weaponSystem.reset(),this.resetAnimations();const e=this.animations.get("soldier_forward");return e.enabled=!0,this}resetAnimations(){for(let e of this.animations.values())e.enabled=!1,e.time=0,e.timeScale=1;return this}resetSearch(){return this.searchAttacker=!1,this.attackDirection.set(0,0,0),this.endTimeSearch=1/0,this}initDeath(){this.status=Nt,this.endTimeDying=this.currentTime+this.dyingTime,this.velocity.set(0,0,0);for(let s of this.steering.behaviors)s.active=!1;this.resetAnimations();const e=Te.randInt(1,2),t=this.animations.get("soldier_death"+e);return t.enabled=!0,this}checkProjectileIntersection(e,t){return this.bounds.intersectRay(e,t)}atPosition(e){const t=w.BOT.NAVIGATION.ARRIVE_TOLERANCE*w.BOT.NAVIGATION.ARRIVE_TOLERANCE;return this.position.squaredDistanceTo(e)<=t}ignoreItem(e){switch(e){case gt:this.ignoreHealth=!0,this.endTimeIgnoreHealth=this.currentTime+this.ignoreItemsTimeout;break;case q:this.ignoreShotgun=!0,this.endTimeIgnoreShotgun=this.currentTime+this.ignoreItemsTimeout;break;case Q:this.ignoreAssaultRifle=!0,this.endTimeIgnoreAssaultRifle=this.currentTime+this.ignoreItemsTimeout;break;default:console.error("DIVE.Enemy: Invalid item type:",e);break}return this}isItemIgnored(e){let t=!1;switch(e){case gt:t=this.ignoreHealth;break;case q:t=this.ignoreShotgun;break;case Q:t=this.ignoreAssaultRifle;break;default:console.error("DIVE.Enemy: Invalid item type:",e);break}return t}removeEntityFromMemory(e){return this.memorySystem.deleteRecord(e),this.memorySystem.getValidMemoryRecords(this.currentTime,this.memoryRecords),this}canMoveInDirection(e,t){return t.copy(e).applyRotation(this.rotation).normalize(),t.multiplyScalar(w.BOT.MOVEMENT.DODGE_SIZE).add(this.position),this.world.navMesh.getRegionForPoint(t,1)!==null}rotateTo(e,t,s){return os.copy(e),os.y=this.position.y,super.rotateTo(os,t,s)}_initRIFTWeaponSystem(){this.enemyCamera=new bs(75,1,.1,1e3);let e=null,t=null;if(this.renderComponent&&(this.renderComponent.traverse(a=>{if(a.isBone){const l=a.name.toLowerCase();l.includes("head")&&(t=a),(l.includes("hand")&&l.includes("right")||l.includes("r_hand")||l.includes("hand_r")||l.includes("rhand"))&&(e=a),!e&&(l.includes("arm")&&l.includes("right")||l.includes("r_arm")||l.includes("arm_r"))&&(e=a)}}),(t||this.renderComponent).add(this.enemyCamera),t||this.enemyCamera.position.set(0,w.BOT.HEAD_HEIGHT,.5)),this.riftWeaponSystem=new $i(this.world.scene,this.enemyCamera,this.world.assetManager,this.world.rift.audioManager),this.riftWeaponSystem.setShellEjectCallback((o,a)=>{const l=this.position.y;this.world.rift.particleSystem.spawnShellCasing(o,a,l)}),e)this.riftWeaponSystem.setThirdPersonMode(e),console.log(`Enemy ${this.name}: Weapon attached to hand bone: ${e.name}`);else if(this.renderComponent){const o=new fe;o.name="weapon_mount",o.position.set(.3,w.BOT.HEAD_HEIGHT*.6,.2),this.renderComponent.add(o),this.riftWeaponSystem.setThirdPersonMode(o),console.log(`Enemy ${this.name}: Weapon attached to fallback mount point`)}const s=[C.AK47,C.M4,C.Scar,C.Shotgun,C.LMG,C.Pistol],i=s[Math.floor(Math.random()*s.length)],n=Object.values(C).indexOf(i);if(this.riftWeaponSystem.switchWeapon(n),this.weaponSystem&&this.weaponSystem.renderComponents){const o=[this.weaponSystem.renderComponents.blaster,this.weaponSystem.renderComponents.shotgun,this.weaponSystem.renderComponents.assaultRifle];for(const a of o)a&&a.mesh&&(a.mesh.visible=!1)}return console.log(`Enemy ${this.name} initialized with RIFT weapon system, weapon: ${i}`),this}_shootRIFT(e){if(!this.riftWeaponSystem||!this.enemyCamera)return this;if(this.renderComponent){this.renderComponent.updateMatrixWorld(!0),this.enemyCamera.updateMatrixWorld(!0);const s=new S(e.x,e.y,e.z);this.enemyCamera.lookAt(s)}const t=this.riftWeaponSystem.shoot(this.enemyCamera,!0,!1,new S(this.velocity.x,this.velocity.y,this.velocity.z));if(t.shotFired){const s=[];this.world.level&&this.world.level.renderComponent&&s.push(this.world.level.renderComponent),this.world.player&&this.world.player.renderComponent&&s.push(this.world.player.renderComponent);for(const a of this.world.competitors)a!==this&&a.renderComponent&&a.status===V&&s.push(a.renderComponent);const i=this.riftWeaponSystem.getMuzzleWorldPosition(),o=this.riftWeaponSystem.currentConfig.damage;if(t.directions)for(const a of t.directions)this.world.rift.processEnemyShot(this.enemyCamera,a,i,s,this,o);else this.world.rift.processEnemyShot(this.enemyCamera,t.direction,i,s,this,o)}return this}handleMessage(e){switch(e.message){case yt:if(this.status!==V)return!0;if(this.health=Math.max(0,this.health-e.data.damage),this.world.debug&&console.log("DIVE.Enemy: Enemy with ID %s hit by Game Entity with ID %s receiving %i damage.",this.uuid,e.sender.uuid,e.data.damage),e.sender.isPlayer&&this.status===V&&this.world.uiManager.showHitIndication(),this.health<=0&&this.status===V){this.initDeath();const i=this.world.competitors;for(let n=0,o=i.length;n<o;n++){const a=i[n];this!==a&&this.sendMessage(a,ms)}this.world.uiManager.addFragMessage(e.sender,this)}else e.sender.status===V&&(this.searchAttacker=!0,this.endTimeSearch=this.currentTime+this.searchTime,this.attackDirection.copy(e.data.direction).multiplyScalar(-1));break;case ms:const t=e.sender,s=this.memorySystem.getRecord(t);s&&s.visible&&(this.removeEntityFromMemory(t),this.targetSystem.update());break}return!0}}const H={maxStamina:100,walkSpeed:8,sprintSpeed:13,jumpForce:12,gravity:35,groundAccel:50,airAccel:20,groundDecel:30,airDecel:5,coyoteTime:.15,jumpCutMultiplier:.5,staminaDrain:20,staminaRegen:30,slideSpeed:18,slideDuration:1,slideFriction:2.5,slideCooldown:1},pi=new b,Lt=new Fe;class Yi extends _i{constructor(e=null,t=new Fe){return super(),this.canActivateTrigger=!1,this.owner=e,this.ray=t,this.lifetime=0,this.currentTime=0,this.damage=0,this}update(e){const t=this.owner.world;if(this.currentTime+=e,this.currentTime>this.lifetime)t.remove(this);else{Lt.copy(this.ray),Lt.origin.copy(this.position),super.update(e);const s=t.checkProjectileIntersection(this,pi);if(s!==null){const i=Lt.origin.squaredDistanceTo(pi),n=Lt.origin.squaredDistanceTo(this.position);i<=n&&(this.owner.sendMessage(s,yt,0,{damage:this.damage,direction:this.ray.direction}),t.remove(this))}}return this}}const fi=new b,gi=new b,as=new Yi,at=new b,rt=new b,$a=new b;class Ya extends _i{constructor(e){super(),this.onGround=!0,this.isSprinting=!1,this.isSliding=!1,this.slideTimer=0,this.slideCooldownTimer=0,this.slideDirection=new b,this.coyoteTimer=0,this.jumpBufferTimer=0,this.isJumping=!1,this.canCutJump=!1,this.prevVelocity=new b,this.groundNormal=new b(0,1,0),this.slopeAngle=0,this.maxSlopeAngle=Math.PI/4,this.stamina=100,this.landingImpact=0,this.headBobTime=0,this.lastFootstepTime=0,this.world=e,this.currentTime=0,this.boundingRadius=w.PLAYER.BOUNDING_RADIUS,this.height=w.PLAYER.HEAD_HEIGHT,this.updateOrientation=!1,this.maxSpeed=w.PLAYER.MAX_SPEED,this.health=w.PLAYER.MAX_HEALTH,this.maxHealth=w.PLAYER.MAX_HEALTH,this.isPlayer=!0,this.velocity=new b,this.status=V,this.head=new Oe,this.head.forward.set(0,0,-1),this.add(this.head),this.endTimeDying=1/0,this.dyingTime=w.PLAYER.DYING_TIME,this.weaponContainer=new Oe,this.head.add(this.weaponContainer),this.weaponSystem=new Ki(this),this.isPlayer||this.weaponSystem.init(),this.bounds=new Z,this.boundsDefinition=new Z(new b(-.25,0,-.25),new b(.25,1.8,.25)),this.currentRegion=null,this.currentPosition=new b,this.previousPosition=new b,this.audios=new Map,this.mixer=null,this.animations=new Map,this.ui={health:document.getElementById("health")},this.name="Player"}get renderComponent(){return this._renderComponent||null}update(e){if(this.status===V){const t=this.world.fpsControls.input,s=new b;t.forward&&(s.z-=1),t.backward&&(s.z+=1),t.left&&(s.x-=1),t.right&&(s.x+=1),this.updatePhysics(e,s,t.sprint,t.jump,t.crouch,this.world.arenaObjects)}return super.update(e),this.currentTime+=e,this.status===V&&(this.isPlayer||this.weaponSystem.updateWeaponChange(),this.bounds.copy(this.boundsDefinition).applyMatrix4(this.worldMatrix)),this.status===Nt&&this.currentTime>=this.endTimeDying&&(this.status=Bt,this.endTimeDying=1/0),this.status===Bt&&(this.world.debug&&console.log("DIVE.Player: Player died."),this.reset(),this.world.spawningManager.respawnCompetitor(this),this.world.fpsControls.sync(),this.world.uiManager.updateHealthStatus()),this.mixer.update(e),this}updatePhysics(e,t,s,i,n,o){this.prevVelocity.copy(this.velocity);const a=t.squaredLength()>0;if(a&&(t.normalize(),t.applyRotation(this.rotation),this.onGround&&this.slopeAngle>0)){const m=t.dot(this.groundNormal),f=this.groundNormal.clone().multiplyScalar(m);t.sub(f).normalize()}this.slideCooldownTimer>0&&(this.slideCooldownTimer-=e),n&&this.isSprinting&&this.onGround&&this.slideCooldownTimer<=0&&!this.isSliding&&(this.isSliding=!0,this.slideTimer=H.slideDuration,this.slideDirection.copy(this.velocity).normalize(),this.velocity.add(this.slideDirection.clone().multiplyScalar(2))),this.isSliding&&(this.slideTimer-=e,(this.slideTimer<=0||this.velocity.length()<H.walkSpeed*.5)&&(this.isSliding=!1,this.slideCooldownTimer=H.slideCooldown)),this.isSprinting=s&&this.onGround&&this.stamina>0&&!this.isSliding,this.isSprinting?(this.stamina-=H.staminaDrain*e,this.stamina<0&&(this.stamina=0,this.isSprinting=!1)):this.stamina=Math.min(H.maxStamina,this.stamina+H.staminaRegen*e);let l=H.walkSpeed;this.isSprinting&&(l=H.sprintSpeed);const c=this.onGround,h=new b(this.velocity.x,0,this.velocity.z);if(this.isSliding){const m=H.slideSpeed*(this.slideTimer/H.slideDuration),f=new b(this.slideDirection.x,0,this.slideDirection.z).multiplyScalar(m),_=H.slideFriction*e;h.x+=(f.x-h.x)*_,h.z+=(f.z-h.z)*_}else{const m=c?H.groundAccel:H.airAccel,f=c?H.groundDecel:H.airDecel;if(a){const _=new b(t.x,0,t.z).multiplyScalar(l),M=m*e,E=new b().copy(_).sub(h);E.length()>M&&E.normalize().multiplyScalar(M),h.add(E)}else{const _=Math.exp(-f*e);h.multiplyScalar(_)}}this.velocity.x=h.x,this.velocity.z=h.z;const d=Math.sqrt(this.velocity.x*this.velocity.x+this.velocity.z*this.velocity.z);if(this.headBobTime+=e*d*2,this.head){const m=Math.sin(this.headBobTime);this.head.position.y=this.height+Math.abs(m)*.06,this.head.position.x=m*.08}if(this.onGround?(this.coyoteTimer=H.coyoteTime,this.isJumping=!1):this.coyoteTimer=Math.max(0,this.coyoteTimer-e),this.jumpBufferTimer=Math.max(0,this.jumpBufferTimer-e),i&&(this.jumpBufferTimer=.1),(this.coyoteTimer>0||this.onGround)&&this.jumpBufferTimer>0){this.velocity.y=H.jumpForce,this.isJumping=!0,this.canCutJump=!0,this.coyoteTimer=0,this.jumpBufferTimer=0,this.isSliding&&(this.isSliding=!1,this.slideCooldownTimer=H.slideCooldown);const m=this.audios.get("jump");m&&!m.isPlaying&&m.play()}this.canCutJump&&!i&&this.velocity.y>0&&(this.velocity.y*=H.jumpCutMultiplier,this.canCutJump=!1),this.velocity.y-=H.gravity*e;const p=this.velocity.clone().multiplyScalar(e),y=this.position.clone().add(p);if(this.onGround=!1,this.world.navMesh&&this.currentRegion){if(this.currentPosition.copy(y),this.currentRegion=this.world.navMesh.clampMovement(this.currentRegion,this.previousPosition,this.currentPosition,y),this.previousPosition.copy(y),this.currentRegion){const m=this.currentRegion.plane.distanceToPoint(y);this.velocity.y<=0&&(y.y-=m*w.NAVMESH.HEIGHT_CHANGE_FACTOR,Math.abs(m)<.5&&(this.velocity.y=0,this.onGround=!0))}}else y.y<=0&&(y.y=0,this.velocity.y=0,this.onGround=!0);this.position.copy(y)}checkSlope(e){this.slopeAngle=0,this.groundNormal.set(0,1,0)}reset(){this.health=this.maxHealth,this.status=V,this.velocity.set(0,0,0),this.prevVelocity.set(0,0,0),this.onGround=!0,this.isSprinting=!1,this.isSliding=!1,this.slideTimer=0,this.slideCooldownTimer=0,this.slideDirection.set(0,0,0),this.coyoteTimer=0,this.jumpBufferTimer=0,this.isJumping=!1,this.canCutJump=!1,this.groundNormal.set(0,1,0),this.slopeAngle=0,this.stamina=100,this.landingImpact=0,this.headBobTime=0,this.weaponSystem.reset(),this.world.fpsControls.reset(),this.world.fpsControls.active=!0,this.world.uiManager.showFPSInterface();const e=this.animations.get("player_death");return e&&(e.stop(),e.reset()),this.endTimeDying=1/0,this}respawn(){this.reset()}initDeath(){this.status=Nt,this.endTimeDying=this.currentTime+this.dyingTime,this.velocity.set(0,0,0);const e=this.animations.get("player_death");return e&&(e.reset(),e.play()),this.weaponSystem.hideCurrentWeapon(),this.world.fpsControls.active=!1,this.world.uiManager.hideFPSInterface(),this}shoot(){if(this.status!==V)return this;const e=this.head,t=this.world;if(t.rift&&t.rift.weaponSystem){const o=this.velocity.y===0,a=Math.sqrt(this.velocity.x**2+this.velocity.z**2)>10,l=new S(this.velocity.x,this.velocity.y,this.velocity.z),c=[];return t.level&&t.level.renderComponent&&(c.push(t.level.renderComponent),console.log("Added level to obstacles:",t.level.renderComponent.name)),t.competitors.forEach(h=>{h!==this&&h.active&&h.renderComponent&&(c.push(h.renderComponent),console.log("Added competitor to obstacles:",h.name,"Active:",h.active))}),console.log("Total obstacles for raycast:",c.length),t.rift.handleShooting(o,a,l,c),this}const s=as.ray;e.getWorldPosition(s.origin),e.getWorldDirection(s.direction),as.owner=this;const n=t.checkProjectileIntersection(as,fi)===null?1e3:s.origin.distanceTo(fi);return gi.copy(s.origin).add(s.direction.multiplyScalar(n)),this.weaponSystem.shoot(gi),t.uiManager.updateAmmoStatus(),this}reload(){return this.world.rift&&this.world.rift.weaponSystem?this.world.rift.weaponSystem.reload():this.weaponSystem.reload(),this}changeWeapon(e){if(this.world.rift&&this.world.rift.weaponSystem){const t={[ee]:4,[q]:6,[Q]:0},s=t[e]!==void 0?t[e]:0;this.world.rift.weaponSystem.switchWeapon(s)}else this.weaponSystem.setNextWeapon(e);return this}hasWeapon(e){return this.weaponSystem.getWeapon(e)!==null}isAutomaticWeaponUsed(){return this.weaponSystem.currentWeapon.type===Q}activate(){return this.active=!0,this.weaponSystem.currentWeapon&&(this.weaponSystem.currentWeapon._renderComponent.visible=!0),this}deactivate(){return this.active=!1,this.weaponSystem.currentWeapon&&(this.weaponSystem.currentWeapon._renderComponent.visible=!1),this}checkProjectileIntersection(e,t){return e.intersectAABB(this.bounds,t)}stayInLevel(){this.currentPosition.copy(this.position),this.currentRegion=this.world.navMesh.clampMovement(this.currentRegion,this.previousPosition,this.currentPosition,this.position),this.previousPosition.copy(this.position);const e=this.currentRegion.plane.distanceToPoint(this.position);return this.position.y-=e*w.NAVMESH.HEIGHT_CHANGE_FACTOR,this}addHealth(e){return this.health+=e,this.health=Math.min(this.health,this.maxHealth),this.world.uiManager.updateHealthStatus(),this.world.debug&&console.log("DIVE.Player: Entity with ID %s receives %i health points.",this.uuid,e),this}addWeapon(e){return this.weaponSystem.addWeapon(e),this.world.uiManager.updateAmmoStatus(),this}setAnimations(e,t){this.mixer=e;for(const s of t){const i=e.clipAction(s);i.loop=ne,i.clampWhenFinished=!0,i.name=s.name,this.animations.set(i.name,i)}return this}handleMessage(e){switch(e.message){case yt:if(this.status!==V)return!0;const t=this.audios.get("impact"+Te.randInt(1,7));if(t&&t.isPlaying===!0&&t.stop(),t&&t.play(),this.health=Math.max(0,this.health-e.data.damage),this.world.uiManager.updateHealthStatus(),this.world.rift){const i=this.computeAngleToAttacker(e.data.direction)*180/Math.PI;this.world.rift.applyDamageEffects(e.data.damage,this.maxHealth,i)}if(this.world.debug&&console.log("DIVE.Player: Player hit by Game Entity with ID %s receiving %i damage.",e.sender.uuid,e.data.damage),this.health<=0&&this.status===V){this.initDeath();const s=this.world.competitors;for(let i=0,n=s.length;i<n;i++){const o=s[i];this!==o&&this.sendMessage(o,ms)}this.world.uiManager.addFragMessage(e.sender,this)}else{const s=this.computeAngleToAttacker(e.data.direction);this.world.uiManager.showDamageIndication(s)}break}return!0}computeAngleToAttacker(e){at.copy(e).multiplyScalar(-1),at.y=0,at.normalize(),this.head.getWorldDirection(rt),rt.y=0,rt.normalize();const t=at.dot(rt),s=this.up.dot($a.crossVectors(at,rt));return Math.atan2(s,t)}}class Xa extends Yi{constructor(e=null,t=new Fe){super(e,t),this.maxSpeed=w.BULLET.MAX_SPEED,this.position.copy(t.origin),this.velocity.copy(t.direction).multiplyScalar(this.maxSpeed);const s=1+Math.random()*1.5;this.scale.set(s,s,s),this.lifetime=w.BULLET.LIFETIME,this.damage=w.BULLET.DAMAGE}}class qa extends yn{constructor(e,t,s,i,n){super(),this.callback=n,this.planner=e,this.vehicle=t,this.from=s,this.to=i}execute(){const e=this.planner.navMesh.findPath(this.from,this.to);this.callback(this.vehicle,e)}}class Qa{constructor(e){this.navMesh=e,this.taskQueue=new wn}findPath(e,t,s,i){const n=new qa(this,e,t,s,i);this.taskQueue.enqueue(n)}update(){this.taskQueue.update()}}class Za extends x{constructor(){const e=Ja,t=new Zn({fragmentShader:e.fragmentShader,vertexShader:e.vertexShader,uniforms:eo.clone(e.uniforms),side:Jn,depthWrite:!1});super(new N(1,1,1),t)}}const Ja={uniforms:{skyLuminance:{value:1},turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new S}},vertexShader:`
		uniform vec3 sunPosition;
		uniform float rayleigh;
		uniform float turbidity;
		uniform float mieCoefficient;

		varying vec3 vWorldPosition;
		varying vec3 vSunDirection;
		varying float vSunfade;
		varying vec3 vBetaR;
		varying vec3 vBetaM;
		varying float vSunE;

		const vec3 up = vec3( 0.0, 1.0, 0.0 );

		// constants for atmospheric scattering
		const float e = 2.71828182845904523536028747135266249775724709369995957;
		const float pi = 3.141592653589793238462643383279502884197169;

		// wavelength of used primaries, according to preetham
		const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );
		// this pre-calcuation replaces older TotalRayleigh(vec3 lambda) function:
		// (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn))
		const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );

		// mie stuff
		// K coefficient for the primaries
		const float v = 4.0;
		const vec3 K = vec3( 0.686, 0.678, 0.666 );
		// MieConst = pi * pow( ( 2.0 * pi ) / lambda, vec3( v - 2.0 ) ) * K
		const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );

		// earth shadow hack
		// cutoffAngle = pi / 1.95;
		const float cutoffAngle = 1.6110731556870734;
		const float steepness = 1.5;
		const float EE = 1000.0;

		float sunIntensity( float zenithAngleCos ) {
			zenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );
			return EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );
		}

		vec3 totalMie( float T ) {
			float c = ( 0.2 * T ) * 10E-18;
			return 0.434 * c * MieConst;
		}

		void main() {

			vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
			vWorldPosition = worldPosition.xyz;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			gl_Position.z = gl_Position.w; // set z to camera.far

			vSunDirection = normalize( sunPosition );

			vSunE = sunIntensity( dot( vSunDirection, up ) );

			vSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );

			float rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );

			// extinction (absorbtion + out scattering)
			// rayleigh coefficients
			vBetaR = totalRayleigh * rayleighCoefficient;

			// mie coefficients
			vBetaM = totalMie( turbidity ) * mieCoefficient;

		}
	`,fragmentShader:`
		varying vec3 vWorldPosition;
		varying vec3 vSunDirection;
		varying float vSunfade;
		varying vec3 vBetaR;
		varying vec3 vBetaM;
		varying float vSunE;

		uniform float skyLuminance;
		uniform float mieDirectionalG;

		const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );

		// constants for atmospheric scattering
		const float pi = 3.141592653589793238462643383279502884197169;

		const float n = 1.0003; // refractive index of air
		const float N = 2.545E25; // number of molecules per unit volume for air at 288.15K and 1013mb (sea level -45 celsius)

		// optical length at zenith for molecules
		const float rayleighZenithLength = 8.4E3;
		const float mieZenithLength = 1.25E3;
		const vec3 up = vec3( 0.0, 1.0, 0.0 );
		// 66 arc seconds -> degrees, and the cosine of that
		const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;

		// 3.0 / ( 16.0 * pi )
		const float THREE_OVER_SIXTEENPI = 0.05968310365946075;
		// 1.0 / ( 4.0 * pi )
		const float ONE_OVER_FOURPI = 0.07957747154594767;

		float rayleighPhase( float cosTheta ) {
			return THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );
		}

		float hgPhase( float cosTheta, float g ) {
			float g2 = pow( g, 2.0 );
			float inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );
			return ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );
		}

		// Filmic ToneMapping http://filmicgames.com/archives/75
		const float A = 0.15;
		const float B = 0.50;
		const float C = 0.10;
		const float D = 0.20;
		const float E = 0.02;
		const float F = 0.30;

		const float whiteScale = 1.0748724675633854; // 1.0 / Uncharted2Tonemap(1000.0)

		vec3 Uncharted2Tonemap( vec3 x ) {
			return ( ( x * ( A * x + C * B ) + D * E ) / ( x * ( A * x + B ) + D * F ) ) - E / F;
		}


		void main() {
			// optical length
			// cutoff angle at 90 to avoid singularity in next formula.
			float zenithAngle = acos( max( 0.0, dot( up, normalize( vWorldPosition - cameraPos ) ) ) );
			float inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );
			float sR = rayleighZenithLength * inverse;
			float sM = mieZenithLength * inverse;

			// combined extinction factor
			vec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );

			// in scattering
			float cosTheta = dot( normalize( vWorldPosition - cameraPos ), vSunDirection );

			float rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );
			vec3 betaRTheta = vBetaR * rPhase;

			float mPhase = hgPhase( cosTheta, mieDirectionalG );
			vec3 betaMTheta = vBetaM * mPhase;

			vec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );
			Lin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );

			// nightsky
			vec3 direction = normalize( vWorldPosition - cameraPos );
			float theta = acos( direction.y ); // elevation --> y-axis, [-pi/2, pi/2]
			float phi = atan( direction.z, direction.x ); // azimuth --> x-axis [-pi/2, pi/2]
			vec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );
			vec3 L0 = vec3( 0.1 ) * Fex;

			// composition + solar disc
			float sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );
			L0 += ( vSunE * 19000.0 * Fex ) * sundisk;

			vec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );

			vec3 curr = Uncharted2Tonemap( ( log2( 2.0 / pow( skyLuminance, 4.0 ) ) ) * texColor );
			vec3 color = curr * whiteScale;

			vec3 retColor = pow( color, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );

			gl_FragColor = vec4( retColor, 1.0 );

		}
	`};class Be{constructor(e,t,s=20){this.pool=[],this.scene=e,this.createFn=t;for(let i=0;i<s;i++){const n=t();n.visible=!1,this.scene.add(n),this.pool.push(n)}}get(){let e;return this.pool.length>0?e=this.pool.pop():(e=this.createFn(),this.scene.add(e)),e.visible=!0,e}release(e){e.visible=!1,this.pool.push(e)}}class er{constructor(e){this.particles=[],this.shells=[],this.scene=e,this.spherePool=new Be(e,()=>new x(new Ms(.05,4,4),new K({color:16777215})),100),this.cubePool=new Be(e,()=>new x(new N(.03,.03,.03),new K({color:16777215})),50),this.shellPool=new Be(e,()=>{const t=new x(new me(.008,.006,.04,8),new R({color:13938487,metalness:.85,roughness:.15,emissive:13938487,emissiveIntensity:.15}));return t.castShadow=!0,t},50),this.smokePool=new Be(e,()=>{const t=new le({color:11184810,transparent:!0,opacity:.5,blending:Ns,depthWrite:!1});return new te(t)},50),this.sparkPool=new Be(e,()=>new x(new N(.05,.05,.2),new K({color:16776960})),50),this.shockwavePool=new Be(e,()=>new x(new to(1,.1,8,32),new K({color:16755200,transparent:!0,opacity:.5})),10),this.loadTextures()}loadTextures(){const e=new _t;e.load("textures/effects/hit-impact.png",t=>{this.hitImpactTexture=t},void 0,()=>{}),e.load("textures/effects/hit-sprite.png",t=>{this.hitSpriteLowTexture=t},void 0,()=>{}),e.load("textures/effects/smoke.png",t=>{this.fireSmokeTexture=t},void 0,()=>{})}spawn(e,t,s){for(let i=0;i<s;i++){const n=this.spherePool.get();n.material.color.setHex(t),n.material.opacity=1,n.material.transparent=!1,n.position.copy(e),n.scale.set(1,1,1);const o=new S((Math.random()-.5)*5,Math.random()*5,(Math.random()-.5)*5);this.particles.push({mesh:n,velocity:o,lifetime:0,maxLifetime:.5+Math.random()*.5})}}spawnBlood(e){const t=4+Math.floor(Math.random()*3);for(let s=0;s<t;s++){const i=this.cubePool.get();i.material.color.setHex(11141120),i.material.opacity=1,i.position.copy(e),i.scale.set(.7,.7,.7);const n=new S((Math.random()-.5)*2,Math.random()*2,(Math.random()-.5)*2);this.particles.push({mesh:i,velocity:n,lifetime:0,maxLifetime:.4+Math.random()*.4,gravity:9.8})}}spawnImpactEffect(e,t=!1){this.spawnBlood(e);const s=t?this.hitImpactTexture:this.hitSpriteLowTexture;if(!s){this.spawn(e,t?16776960:16746496,t?15:8);return}const i=t?3:2;for(let n=0;n<i;n++){const o=new le({map:s,blending:Ft,transparent:!0,opacity:1,color:t?16776960:16729088}),a=new te(o),c=(t?.8:.5)+n*.2;a.scale.set(c,c,c),a.position.copy(e),this.scene.add(a),this.particles.push({mesh:a,velocity:new S(0,0,0),lifetime:0,maxLifetime:t?.3:.2,initialScale:c})}}spawnMaterialImpact(e,t,s){switch(s){case"metal":this.spawnSparks(e,t),this.spawnDebris(e,t,13421772,3);break;case"wood":this.spawnDebris(e,t,9127187,6),this.spawnDust(e,t,6111287,.5);break;case"concrete":case"stone":this.spawnDebris(e,t,8947848,5),this.spawnDust(e,t,11184810,.8);break;case"dirt":case"grass":this.spawnDebris(e,t,6111287,4),this.spawnDust(e,t,7951688,.6);break;default:this.spawnDebris(e,t,8947848,4),this.spawnDust(e,t,13421772,.4)}}spawnSparks(e,t){const s=5+Math.floor(Math.random()*5);for(let i=0;i<s;i++){const n=this.sparkPool.get();n.material.opacity=1,n.position.copy(e);const o=t.clone().multiplyScalar(5+Math.random()*5);o.x+=(Math.random()-.5)*4,o.y+=(Math.random()-.5)*4,o.z+=(Math.random()-.5)*4,n.lookAt(e.clone().add(o)),this.particles.push({mesh:n,velocity:o,lifetime:0,maxLifetime:.1+Math.random()*.2,gravity:5})}}spawnDust(e,t,s,i){const n=2+Math.floor(Math.random()*2);for(let o=0;o<n;o++){const a=this.smokePool.get(),l=a.material;this.fireSmokeTexture&&!l.map&&(l.map=this.fireSmokeTexture),l.color.setHex(s),l.opacity=i*(.2+Math.random()*.2),l.rotation=Math.random()*Math.PI*2;const c=.3+Math.random()*.3;a.scale.set(c,c,1),a.position.copy(e);const h=t.clone().multiplyScalar(.5+Math.random()*1);h.add(new S((Math.random()-.5)*.5,(Math.random()-.5)*.5,(Math.random()-.5)*.5)),this.particles.push({mesh:a,velocity:h,lifetime:0,maxLifetime:.5+Math.random()*.5,initialScale:c,gravity:-.2})}}spawnDebris(e,t,s,i=5){for(let n=0;n<i;n++){const o=this.cubePool.get();o.material.color.setHex(s),o.material.opacity=1,o.position.copy(e),o.scale.set(1,1,1);const a=t.clone().multiplyScalar(2+Math.random()*3);a.x+=(Math.random()-.5)*2,a.y+=(Math.random()-.5)*2,a.z+=(Math.random()-.5)*2,this.particles.push({mesh:o,velocity:a,lifetime:0,maxLifetime:.4+Math.random()*.3,gravity:9.8})}}spawnShellCasing(e,t,s=0,i){const n=this.shellPool.get(),o=n.material;o.opacity=1,o.transparent=!1,n.position.copy(e),n.rotation.set(Math.random()*Math.PI*2,Math.random()*Math.PI*2,Math.random()*Math.PI*2);const a=2.5+Math.random()*1.5,l=t.clone().multiplyScalar(a);l.y+=1.5+Math.random()*1,console.log("Shell spawned:",{pos:n.position.clone(),groundLevel:s,velocity:l.clone()}),this.shells.push({mesh:n,velocity:l,rotationalVelocity:new S((Math.random()-.5)*20,(Math.random()-.5)*20,(Math.random()-.5)*20),lifetime:15,onHit:i,hasHit:!1,groundLevel:s,bounceCount:0,settled:!1})}spawnMuzzleSmoke(e,t){if(Math.random()>.3)return;const s=this.smokePool.get(),i=s.material;this.fireSmokeTexture&&!i.map&&(i.map=this.fireSmokeTexture),i.color.setHex(15658734),i.opacity=.02+Math.random()*.05,i.rotation=Math.random()*Math.PI*2;const n=.1+Math.random()*.15;s.scale.set(n,n,1),s.position.copy(e),s.position.add(new S((Math.random()-.5)*.05,(Math.random()-.5)*.05,(Math.random()-.5)*.05));const o=.2+Math.random()*.3,a=t.clone().multiplyScalar(o);a.add(new S((Math.random()-.5)*.1,.2+Math.random()*.2,(Math.random()-.5)*.1)),this.particles.push({mesh:s,velocity:a,lifetime:0,maxLifetime:.3+Math.random()*.3,initialScale:n,gravity:-.3})}spawnExplosion(e){const t=this.spherePool.get();t.material.color.setHex(16777198),t.material.opacity=1,t.material.transparent=!0,t.position.copy(e),t.scale.set(2,2,2),this.particles.push({mesh:t,velocity:new S(0,0,0),lifetime:0,maxLifetime:.1,initialScale:2});const s=12;for(let a=0;a<s;a++){const l=this.spherePool.get(),c=Math.random()>.5?16729088:16746496;l.material.color.setHex(c),l.material.opacity=.8,l.material.transparent=!0,l.position.copy(e),l.position.add(new S((Math.random()-.5)*.5,(Math.random()-.5)*.5,(Math.random()-.5)*.5));const h=1.5+Math.random();l.scale.set(h,h,h);const d=new S((Math.random()-.5)*8,(Math.random()-.5)*8+2,(Math.random()-.5)*8);this.particles.push({mesh:l,velocity:d,lifetime:0,maxLifetime:.4+Math.random()*.3,initialScale:h})}const i=15;for(let a=0;a<i;a++){const l=this.cubePool.get();l.material.color.setHex(3355443),l.position.copy(e);const c=.2+Math.random()*.3;l.scale.set(c,c,c);const h=new S((Math.random()-.5)*15,Math.random()*10+5,(Math.random()-.5)*15);this.particles.push({mesh:l,velocity:h,lifetime:0,maxLifetime:1.5+Math.random(),gravity:15})}const n=8;for(let a=0;a<n;a++){const l=this.spherePool.get();l.material.color.setHex(2236962),l.material.opacity=.6,l.material.transparent=!0,l.position.copy(e);const c=2+Math.random();l.scale.set(c,c,c);const h=new S((Math.random()-.5)*3,Math.random()*3+1,(Math.random()-.5)*3);this.particles.push({mesh:l,velocity:h,lifetime:0,maxLifetime:1.5+Math.random(),initialScale:c})}const o=this.shockwavePool.get();o.material.opacity=.5,o.position.copy(e),o.rotation.x=-Math.PI/2,o.scale.set(.1,.1,.1),this.particles.push({mesh:o,velocity:new S(0,0,0),lifetime:0,maxLifetime:.5,initialScale:.1})}spawnTrail(e,t,s){const i=this.smokePool.get(),n=i.material;this.fireSmokeTexture&&!n.map&&(n.map=this.fireSmokeTexture),n.color.setHex(t),n.opacity=.3,n.rotation=Math.random()*Math.PI*2,i.scale.set(s,s,1),i.position.copy(e),this.particles.push({mesh:i,velocity:new S(0,0,0),lifetime:0,maxLifetime:.5,initialScale:s,gravity:-.5})}update(e){for(let t=this.particles.length-1;t>=0;t--){const s=this.particles[t];if(s.lifetime+=e,s.lifetime>=s.maxLifetime){s.mesh instanceof x?s.mesh.geometry.type==="SphereGeometry"?this.spherePool.release(s.mesh):s.mesh.geometry.type==="BoxGeometry"?this.cubePool.release(s.mesh):s.mesh.geometry.type==="TorusGeometry"?this.shockwavePool.release(s.mesh):this.scene.remove(s.mesh):s.mesh instanceof te?s.mesh.material.depthWrite===!1&&s.mesh.material.blending===Ns?this.smokePool.release(s.mesh):this.scene.remove(s.mesh):this.scene.remove(s.mesh),this.particles.splice(t,1);continue}s.mesh.position.add(s.velocity.clone().multiplyScalar(e));const i=s.gravity!==void 0?s.gravity:5;s.velocity.y-=i*e;const n=s.lifetime/s.maxLifetime;if(s.mesh instanceof te){if(s.mesh.material.opacity=1-n,s.initialScale){const o=s.initialScale*(1+n*.5);s.mesh.scale.set(o,o,1)}}else if(s.mesh.material.opacity=1-n,s.mesh.material.transparent=!0,s.mesh.geometry.type==="TorusGeometry"){const o=1+n*20;s.mesh.scale.set(o,o,o)}}for(let t=this.shells.length-1;t>=0;t--){const s=this.shells[t];if(s.lifetime-=e,s.lifetime<=0){this.shellPool.release(s.mesh),this.shells.splice(t,1);continue}if(s.settled){if(s.lifetime<2){const o=s.mesh.material;o.transparent=!0,o.opacity=s.lifetime/2}continue}s.velocity.y-=9.8*e,s.mesh.position.add(s.velocity.clone().multiplyScalar(e)),s.mesh.rotation.x+=s.rotationalVelocity.x*e,s.mesh.rotation.y+=s.rotationalVelocity.y*e,s.mesh.rotation.z+=s.rotationalVelocity.z*e;const n=s.groundLevel+.02;if(s.mesh.position.y<=n&&s.velocity.y<0){s.mesh.position.y=n,s.bounceCount++;const o=Math.abs(s.velocity.y);this.onShellBounce&&o>.3&&this.onShellBounce(s.mesh.position.clone(),s.bounceCount);const a=Math.max(.15,.45-s.bounceCount*.1),l=Math.max(.4,.75-s.bounceCount*.1);o>.4?(s.velocity.y=o*a,s.velocity.x*=l,s.velocity.z*=l,s.rotationalVelocity.multiplyScalar(l)):(s.velocity.y=0,s.velocity.x*=.7,s.velocity.z*=.7,s.rotationalVelocity.multiplyScalar(.5)),Math.sqrt(s.velocity.x*s.velocity.x+s.velocity.y*s.velocity.y+s.velocity.z*s.velocity.z)<.1&&s.bounceCount>=2&&(s.velocity.set(0,0,0),s.rotationalVelocity.set(0,0,0),s.settled=!0,s.mesh.rotation.x=Math.PI/2,s.mesh.rotation.z=Math.random()*Math.PI*2,s.mesh.position.y=n)}}}setShellBounceCallback(e){this.onShellBounce=e}clear(){this.particles.forEach(e=>this.scene.remove(e.mesh)),this.particles.length=0}}var re=(r=>(r.BRICK="brick",r.WOOD="wood",r.METAL="metal",r.ROCK="rock",r.GRAVEL="gravel",r.DEFAULT="default",r))(re||{});class tr{constructor(e,t){this.audioBuffers={bodyImpacts:[],surfaceImpacts:{}},this.scene=e,this.audioListener=t,this.loadAudio()}loadAudio(){const e=new Ts;["assets/audio/sfx/impacts/Body-Impact-1.mp3","assets/audio/sfx/impacts/Body-Impact-2.mp3","assets/audio/sfx/impacts/Body-Impact-3.mp3"].forEach(i=>{e.load(i,n=>{this.audioBuffers.bodyImpacts.push(n)},void 0,n=>console.warn(`Failed to load ${i}:`,n))}),e.load("assets/audio/sfx/impacts/Death-Impact.mp3",i=>{this.audioBuffers.deathImpact=i},void 0,i=>console.warn("Failed to load death impact:",i)),e.load("assets/audio/sfx/impacts/Hit-Impact.mp3",i=>{this.audioBuffers.hitImpact=i},void 0,i=>console.warn("Failed to load hit impact:",i)),e.load("assets/audio/sfx/weapons/Shotgun-Fire.mp3",i=>{this.audioBuffers.explosion=i},void 0,i=>console.warn("Failed to load explosion sound:",i)),e.load("assets/audio/sfx/weapons/Tec-9-Tail.mp3",i=>{this.audioBuffers.bulletWhiz=i},void 0,i=>console.warn("Failed to load bullet whiz:",i)),e.load("assets/audio/sfx/impacts/Impact-Iron-Light.mp3",i=>{this.audioBuffers.shellDrop=i},void 0,i=>console.warn("Failed to load shell drop:",i)),Object.entries({brick:["assets/audio/sfx/impacts/Impact-Brick-1.mp3","assets/audio/sfx/impacts/Impact-Brick-2.mp3"],gravel:["assets/audio/sfx/impacts/Impact-Gravel-1.mp3","assets/audio/sfx/impacts/Impact-Gravel-2.mp3"],wood:["assets/audio/sfx/impacts/Impact-Wood-1.mp3","assets/audio/sfx/impacts/Impact-Wood-2.mp3"],rock:["assets/audio/sfx/impacts/Impact-Rock-1.mp3","assets/audio/sfx/impacts/Impact-Rock-2.mp3"],metal:["assets/audio/sfx/impacts/Impact-Metal.mp3","assets/audio/sfx/impacts/Impact-Iron.mp3","assets/audio/sfx/impacts/Impact-Iron-Light.mp3"]}).forEach(([i,n])=>{this.audioBuffers.surfaceImpacts[i]=[],n.forEach(o=>{e.load(o,a=>{this.audioBuffers.surfaceImpacts[i].push(a)},void 0,a=>console.warn(`Failed to load ${o}:`,a))})})}playBodyImpact(e,t=1){if(this.audioBuffers.bodyImpacts.length===0)return;const s=new F(this.audioListener),i=this.audioBuffers.bodyImpacts[Math.floor(Math.random()*this.audioBuffers.bodyImpacts.length)];s.setBuffer(i),s.setRefDistance(5),s.setVolume(t*1.5),s.setLoop(!1);const n=new fe;n.position.copy(e),this.scene.add(n),n.add(s),s.play(),s.onEnded=()=>{this.scene.remove(n)}}playDeathImpact(e){if(!this.audioBuffers.deathImpact)return;const t=new F(this.audioListener);t.setBuffer(this.audioBuffers.deathImpact),t.setRefDistance(8),t.setVolume(2),t.setLoop(!1);const s=new fe;s.position.copy(e),this.scene.add(s),s.add(t),t.play(),t.onEnded=()=>{this.scene.remove(s)}}playHitConfirmation(e=.8){if(!this.audioBuffers.hitImpact)return;const t=new Di(this.audioListener);t.setBuffer(this.audioBuffers.hitImpact),t.setVolume(e*1.2),t.play()}playBulletWhiz(e){if(!this.audioBuffers.bulletWhiz)return;const t=new F(this.audioListener);t.setBuffer(this.audioBuffers.bulletWhiz),t.setRefDistance(5),t.setVolume(.4),t.setPlaybackRate(1.5+Math.random()*.5),t.setLoop(!1);const s=new fe;s.position.copy(e),this.scene.add(s),s.add(t),t.play(),t.onEnded=()=>{this.scene.remove(s)}}playShellDrop(e,t=1){if(!this.audioBuffers.shellDrop)return;const s=new F(this.audioListener);s.setBuffer(this.audioBuffers.shellDrop),s.setRefDistance(2),s.setVolume(.25*Math.max(.2,Math.min(1,t))),s.setPlaybackRate(1.8+Math.random()*.8),s.setLoop(!1);const i=new fe;i.position.copy(e),this.scene.add(i),i.add(s),s.play(),s.onEnded=()=>{this.scene.remove(i)}}playExplosion(e){if(!this.audioBuffers.explosion)return;const t=new F(this.audioListener);t.setBuffer(this.audioBuffers.explosion),t.setRefDistance(20),t.setVolume(2),t.setPlaybackRate(.5),t.setLoop(!1);const s=new fe;s.position.copy(e),this.scene.add(s),s.add(t),t.play(),t.onEnded=()=>{this.scene.remove(s)}}playSurfaceImpact(e,t,s=.8){const i=this.audioBuffers.surfaceImpacts[t];if(!i||i.length===0){const n=this.audioBuffers.surfaceImpacts.metal;if(!n||n.length===0)return;this.playSurfaceImpactWithBuffer(e,n,s);return}this.playSurfaceImpactWithBuffer(e,i,s)}playSurfaceImpactWithBuffer(e,t,s){const i=new F(this.audioListener),n=t[Math.floor(Math.random()*t.length)];i.setBuffer(n),i.setRefDistance(10),i.setVolume(s*1.3),i.setLoop(!1);const o=new fe;o.position.copy(e),this.scene.add(o),o.add(i),i.play(),i.onEnded=()=>{this.scene.remove(o)}}}class sr{constructor(e){this.decals=[],this.maxDecals=50,this.scene=e,this.loadTextures()}loadTextures(){const e=new _t;e.load("assets/images/Bullet-Hole.png_6e4be8ce.png",t=>{this.bulletHoleTexture=t},void 0,t=>console.warn("Failed to load bullet hole texture:",t)),e.load("assets/images/Crack-Hole.png_ee41c0b1.png",t=>{this.crackHoleTexture=t},void 0,t=>console.warn("Failed to load crack hole texture:",t))}createBulletHole(e,t,s){if(!this.bulletHoleTexture)return;const n=(s===re.BRICK||s===re.ROCK)&&this.crackHoleTexture&&Math.random()<.3?this.crackHoleTexture:this.bulletHoleTexture,o=.15+Math.random()*.1,a=new Ss(o,o),l=new K({map:n,transparent:!0,opacity:.9,depthWrite:!1,depthTest:!0,side:Wt}),c=new x(a,l);if(c.position.copy(e).add(t.clone().multiplyScalar(.002)),c.lookAt(e.clone().add(t)),c.rotateZ(Math.random()*Math.PI*2),this.scene.add(c),this.decals.push({mesh:c,lifetime:0,maxLifetime:12,material:l}),this.decals.length>this.maxDecals){const h=this.decals.shift();h&&(this.scene.remove(h.mesh),h.material.dispose(),h.mesh.geometry.dispose())}}createDecal(e,t,s){this.createBulletHole(e,t,s)}update(e){for(let t=this.decals.length-1;t>=0;t--){const s=this.decals[t];if(s.lifetime+=e,s.lifetime>8){const i=(s.lifetime-8)/(s.maxLifetime-8);s.material.opacity=.9*(1-i)}s.lifetime>=s.maxLifetime&&(this.scene.remove(s.mesh),s.material.dispose(),s.mesh.geometry.dispose(),this.decals.splice(t,1))}}clear(){this.decals.forEach(e=>{this.scene.remove(e.mesh),e.material.dispose(),e.mesh.geometry.dispose()}),this.decals.length=0}}class ir{constructor(e,t){this.activeTracers=[],this.pool=[],this.scene=e,this.sharedGeometry=new Ss(1,1),this.loadTextures()}loadTextures(){const e=new _t;e.load("assets/images/ui/Bullet-Trace.png_1b6132fc.png",t=>{this.tracerTexture=t,this.tracerTexture.wrapS=ke,this.tracerTexture.wrapT=ke},void 0,t=>console.warn("Failed to load bullet trace texture:",t)),e.load("assets/images/ui/Bullet-Fire-Trace.jpg_d795b3f8.jpg",t=>{this.fireTracerTexture=t,this.fireTracerTexture.wrapS=ke,this.fireTracerTexture.wrapT=ke},void 0,t=>console.warn("Failed to load fire trace texture:",t))}getFromPool(){if(this.pool.length>0){const s=this.pool.pop();return s.active=!0,s.mesh.visible=!0,this.scene.add(s.mesh),s}const e=new K({transparent:!0,opacity:1,blending:Ft,side:Wt,depthWrite:!1,depthTest:!1,fog:!1}),t=new x(this.sharedGeometry,e);return this.scene.add(t),{mesh:t,material:e,lifetime:0,maxLifetime:.2,active:!0}}returnToPool(e){e.active=!1,e.mesh.visible=!1,this.scene.remove(e.mesh),this.pool.push(e)}createTracer(e,t,s=65535,i=!1){const n=new S().subVectors(t,e),o=n.length();if(o<.1)return;const a=this.getFromPool(),l=i&&this.fireTracerTexture?this.fireTracerTexture:this.tracerTexture;a.material.map=l||null,a.material.color.setHex(s),a.material.opacity=1,a.material.needsUpdate=!0,a.mesh.position.copy(e).addScaledVector(n,.5);const c=new vs;c.setFromUnitVectors(new S(1,0,0),n.clone().normalize()),a.mesh.quaternion.copy(c),a.mesh.scale.set(o,.03,1),a.lifetime=0,a.maxLifetime=.15,this.activeTracers.push(a)}createMultipleTracers(e,t,s=65535,i=!1){t.forEach(n=>{this.createTracer(e,n,s,i)})}update(e){for(let t=this.activeTracers.length-1;t>=0;t--){const s=this.activeTracers[t];if(s.lifetime+=e,s.lifetime>=s.maxLifetime)this.returnToPool(s),this.activeTracers.splice(t,1);else{const i=s.lifetime/s.maxLifetime;s.material.opacity=1-i}}}clear(){this.activeTracers.forEach(e=>this.returnToPool(e)),this.activeTracers=[],this.pool.forEach(e=>{this.scene.remove(e.mesh),e.material.dispose()}),this.pool=[],this.sharedGeometry.dispose()}}class nr{constructor(e){this.shakeInstances=[],this.shakeOffset=new S,this.fovPunch=null,this.recoilPitch=0,this.recoilYaw=0,this.targetRecoilPitch=0,this.targetRecoilYaw=0,this.recoilRecoveryRate=5,this.chromaticAberration=0,this.targetChromaticAberration=0,this.vignetteIntensity=0,this.targetVignetteIntensity=0,this.originalPosition=new S,this.baseFOV=75,this.camera=e,this.baseFOV=e.fov,this.originalPosition.copy(e.position)}addShake(e=.05,t=.15,s=25,i=.5){this.shakeInstances.push({intensity:e,duration:t,elapsed:0,frequency:s,decay:i})}addFireShake(e=1){const t=.02*e;this.addShake(t,.08,30,.7)}addExplosionShake(e=10){const s=.15*Math.max(.1,1-e/50);this.addShake(s,.5,15,.3)}addDamageShake(e=.1){const t=.05+e*.1,s=.2+e*.1;this.addShake(t,s,20,.4)}addFOVPunch(e=2,t=.1){this.fovPunch={amount:e,duration:t,elapsed:0,baseFOV:this.baseFOV}}applyRecoil(e,t){this.targetRecoilPitch+=e,this.targetRecoilYaw+=t}getRecoil(){return{pitch:this.recoilPitch,yaw:this.recoilYaw}}setRecoilRecoveryRate(e){this.recoilRecoveryRate=e}addChromaticAberration(e=.5){this.targetChromaticAberration=e}addVignette(e=.5){this.targetVignetteIntensity=e}update(e){this.updateShake(e),this.updateFOVPunch(e),this.updateRecoil(e),this.updateChromaticAberration(e),this.updateVignette(e)}updateShake(e){this.shakeOffset.set(0,0,0);for(let t=this.shakeInstances.length-1;t>=0;t--){const s=this.shakeInstances[t];if(s.elapsed+=e,s.elapsed>=s.duration){this.shakeInstances.splice(t,1);continue}const i=s.elapsed/s.duration,n=Math.pow(1-i,s.decay*2),o=s.elapsed*s.frequency,a=s.intensity*n;this.shakeOffset.x+=Math.sin(o*6.28)*a,this.shakeOffset.y+=Math.cos(o*5.13)*a,this.shakeOffset.z+=Math.sin(o*4.27)*a*.5}}updateFOVPunch(e){if(!this.fovPunch)return;if(this.fovPunch.elapsed+=e,this.fovPunch.elapsed>=this.fovPunch.duration){this.camera.fov=this.baseFOV,this.camera.updateProjectionMatrix(),this.fovPunch=null;return}const t=this.fovPunch.elapsed/this.fovPunch.duration,s=1-Math.pow(t,2),i=this.fovPunch.amount*s;this.camera.fov=this.baseFOV+i,this.camera.updateProjectionMatrix()}updateRecoil(e){this.recoilPitch=J.lerp(this.recoilPitch,this.targetRecoilPitch,e*15),this.recoilYaw=J.lerp(this.recoilYaw,this.targetRecoilYaw,e*15),this.targetRecoilPitch=J.lerp(this.targetRecoilPitch,0,e*this.recoilRecoveryRate),this.targetRecoilYaw=J.lerp(this.targetRecoilYaw,0,e*this.recoilRecoveryRate)}updateChromaticAberration(e){this.chromaticAberration=J.lerp(this.chromaticAberration,this.targetChromaticAberration,e*10),this.targetChromaticAberration=J.lerp(this.targetChromaticAberration,0,e*8)}updateVignette(e){this.vignetteIntensity=J.lerp(this.vignetteIntensity,this.targetVignetteIntensity,e*10),this.targetVignetteIntensity=J.lerp(this.targetVignetteIntensity,0,e*5)}getShakeOffset(){return this.shakeOffset.clone()}getChromaticAberration(){return this.chromaticAberration}getVignetteIntensity(){return this.vignetteIntensity}reset(){this.shakeInstances=[],this.shakeOffset.set(0,0,0),this.fovPunch=null,this.recoilPitch=0,this.recoilYaw=0,this.targetRecoilPitch=0,this.targetRecoilYaw=0,this.chromaticAberration=0,this.targetChromaticAberration=0,this.vignetteIntensity=0,this.targetVignetteIntensity=0,this.camera.fov=this.baseFOV,this.camera.updateProjectionMatrix()}setBaseFOV(e){this.baseFOV=e,this.camera.fov=e,this.camera.updateProjectionMatrix()}}class Xi{constructor(){this.maxItems=5,this.itemDuration=4e3,this.container=document.getElementById("killfeed"),this.container||console.error("Killfeed container not found!")}addKill(e,t,s,i,n=!1,o="",a=""){this.container&&requestAnimationFrame(()=>{const l=document.createElement("div");l.className="killfeed-item",i&&l.classList.add("headshot"),n&&l.classList.add("multikill");let c="killfeed-killer";o==="red"?c+=" team-red":o==="blue"?c+=" team-blue":e==="Enemy"&&(c+=" enemy");let h="killfeed-victim";a==="red"?h+=" team-red":a==="blue"?h+=" team-blue":t==="Player"&&(h+=" player");const d=i?'<img src="assets/images/ui/Headshot-Icon.png_ca1ab804.png" class="killfeed-icon">':"";for(l.innerHTML=`
                <span class="${c}">${e}</span>
                <span class="killfeed-weapon">[${s}]</span>
                ${d}
                <span class="${h}">${t}</span>
            `,this.container.appendChild(l);this.container.children.length>this.maxItems;)this.container.firstChild&&this.container.removeChild(this.container.firstChild);setTimeout(()=>{l.style.animation="fadeOut 0.5s ease-out forwards",setTimeout(()=>{l.parentNode===this.container&&this.container.removeChild(l)},500)},this.itemDuration)})}}class or{constructor(){this.multiKillTimeout=null,this.streakTimeout=null,this.impactFlashTimeout=null,this.damagePulseTimeout=null,this.damageOverlayTimeout=null,this.currentWave=0,this.killfeed=new Xi,this.healthBarMask=document.getElementById("health-bar-mask"),this.healthText=document.getElementById("health-text-value"),this.healthWrapper=document.getElementById("health-wrapper"),this.armorBarMask=document.getElementById("armor-bar-mask"),this.armorText=document.getElementById("armor-text-value"),this.staminaBarMask=document.getElementById("stamina-bar-mask"),this.staminaText=document.getElementById("stamina-text-value"),this.weaponName=document.getElementById("weapon-name"),this.ammoDisplay=document.getElementById("ammo-display"),this.waveDisplay=document.getElementById("wave-display"),this.scoreDisplay=document.getElementById("score-display"),this.enemiesDisplay=document.getElementById("enemies-remaining"),this.reloadIndicator=document.getElementById("reload-indicator"),this.powerupIndicator=document.getElementById("powerup-indicator"),this.damageOverlay=document.getElementById("damage-overlay"),this.sniperScope=document.getElementById("sniper-scope"),this.crosshair=document.getElementById("crosshair"),this.crosshairTop=document.getElementById("cross-top"),this.crosshairBottom=document.getElementById("cross-bottom"),this.crosshairLeft=document.getElementById("cross-left"),this.crosshairRight=document.getElementById("cross-right"),this.killIcon=document.getElementById("kill-icon"),this.headshotIcon=document.getElementById("headshot-icon"),this.multiKillDisplay=document.getElementById("multikill-display"),this.streakDisplay=document.getElementById("streak-display"),this.vignetteImpactFlash=document.getElementById("vignette-impact-flash"),this.vignetteDamagePulse=document.getElementById("vignette-damage-pulse"),this.vignetteCritical=document.getElementById("vignette-critical"),this.waveDisplay&&(this.waveDisplay.style.display="none")}updateHealth(e,t){if(!this.healthBarMask)return;const s=Math.max(0,e/t*100);this.healthBarMask.style.width=`${s}%`,this.healthText.textContent=Math.ceil(e).toString(),this.updateCriticalVignette(s),s<25?this.healthWrapper.classList.add("critical"):this.healthWrapper.classList.remove("critical")}updateCriticalVignette(e){this.vignetteCritical&&(e<15?(this.vignetteCritical.style.opacity="1",this.vignetteCritical.classList.add("pulsing")):e<30?(this.vignetteCritical.style.opacity="0.85",this.vignetteCritical.classList.add("pulsing")):e<50?(this.vignetteCritical.style.opacity="0.55",this.vignetteCritical.classList.remove("pulsing")):e<75?(this.vignetteCritical.style.opacity="0.25",this.vignetteCritical.classList.remove("pulsing")):(this.vignetteCritical.style.opacity="0",this.vignetteCritical.classList.remove("pulsing")))}updateArmor(e,t){if(!this.armorBarMask)return;const s=Math.max(0,e/t*100);this.armorBarMask.style.width=`${s}%`,this.armorText.textContent=Math.ceil(e).toString()}updateStamina(e,t){if(!this.staminaBarMask)return;const s=Math.max(0,e/t*100);this.staminaBarMask.style.width=`${s}%`,this.staminaText.textContent=Math.ceil(e).toString()}updateWeaponName(e){this.weaponName&&(this.weaponName.textContent=e)}updateAmmo(e,t){this.ammoDisplay&&(this.ammoDisplay.textContent=`${e} / ${t}`,this.ammoDisplay.className=e===0?"empty":e<=5?"low":"")}updateWave(e){this.waveDisplay&&e!==this.currentWave&&(this.currentWave=e,this.waveDisplay.textContent=`WAVE ${e}`,this.waveDisplay.classList.remove("active","wave-start"),requestAnimationFrame(()=>{this.waveDisplay.classList.add("wave-start")}),setTimeout(()=>{this.waveDisplay.classList.remove("wave-start"),this.waveDisplay.classList.add("active")},1500))}updateScore(e){if(!this.scoreDisplay)return;const t=parseInt(this.scoreDisplay.textContent||"0");e>t&&(this.scoreDisplay.classList.remove("pop"),requestAnimationFrame(()=>{this.scoreDisplay.classList.add("pop")})),this.scoreDisplay.textContent=e.toString()}updateEnemiesRemaining(e){this.enemiesDisplay&&(this.enemiesDisplay.textContent=`Enemies: ${e}`)}showReloading(e){this.reloadIndicator&&(e?(this.reloadIndicator.style.opacity="1",this.reloadIndicator.classList.add("active")):(this.reloadIndicator.style.opacity="0",this.reloadIndicator.classList.remove("active")))}showPowerup(e,t){this.powerupIndicator&&(this.powerupIndicator.textContent=e,this.powerupIndicator.style.opacity=t?"1":"0")}flashDamage(e){this.damageOverlay&&this.damageOverlayTimeout===null&&(this.damageOverlay.style.opacity="1",this.damageOverlay.style.filter="drop-shadow(0 0 8px red) drop-shadow(0 0 15px red)",e!==void 0?this.damageOverlay.style.transform=`translate(-50%, -50%) rotate(${(e+180)%360}deg)`:this.damageOverlay.style.transform="translate(-50%, -50%)",this.damageOverlayTimeout=setTimeout(()=>{this.damageOverlay.style.opacity="0",this.damageOverlay.style.filter="none",this.damageOverlayTimeout=null},300))}showNearMissIndicator(e){this.damageOverlay&&(this.damageOverlayTimeout!==null&&clearTimeout(this.damageOverlayTimeout),this.damageOverlay.style.opacity="0.5",this.damageOverlay.style.filter="drop-shadow(0 0 8px white) drop-shadow(0 0 15px white)",this.damageOverlay.style.transform=`translate(-50%, -50%) rotate(${(e+180)%360}deg)`,this.damageOverlayTimeout=setTimeout(()=>{this.damageOverlay.style.opacity="0",this.damageOverlay.style.filter="none",this.damageOverlayTimeout=null},150))}showDamageVignette(e,t,s){if(!this.vignetteImpactFlash||!this.vignetteDamagePulse)return;const i=e/t*100,n=Math.min(i/50,1);if(this.impactFlashTimeout&&clearTimeout(this.impactFlashTimeout),this.vignetteImpactFlash.style.opacity=Math.min(.9,.5+n*.7).toString(),s!==void 0){const l=s*Math.PI/180,c=Math.sin(l)*10,h=-Math.cos(l)*10;this.vignetteImpactFlash.style.transform=`translate(${c}%, ${h}%)`}else this.vignetteImpactFlash.style.transform="translate(0, 0)";this.impactFlashTimeout=window.setTimeout(()=>{this.vignetteImpactFlash.style.opacity="0",this.vignetteImpactFlash.style.transform="translate(0, 0)"},120),this.damagePulseTimeout&&clearTimeout(this.damagePulseTimeout);const o=i>30?"rgba(255, 0, 51, INTENSITY)":"rgba(255, 165, 0, INTENSITY)",a=Math.max(.6,n*1.2);this.vignetteDamagePulse.style.background=`
      radial-gradient(
        ellipse at center,
        transparent 30%,
        ${o.replace("INTENSITY",(a*.3).toString())} 45%,
        ${o.replace("INTENSITY",(a*.7).toString())} 60%,
        ${o.replace("INTENSITY",(a*.95).toString())} 75%,
        ${o.replace("INTENSITY",(a*.8).toString())} 90%
      )
    `,this.vignetteDamagePulse.style.opacity=Math.min(a,.95).toString(),this.vignetteDamagePulse.classList.add("pulsing"),setTimeout(()=>{this.vignetteDamagePulse.classList.remove("pulsing")},100),this.damagePulseTimeout=window.setTimeout(()=>{this.vignetteDamagePulse.style.opacity="0"},400),s!==void 0&&this.flashDamage(s)}showHitmarker(e){const t=document.getElementById("hitmarker");if(!t)return;const s=t.querySelector("img");t.style.opacity="1",t.style.transform=e?"translate(-50%, -50%) scale(1.5)":"translate(-50%, -50%) scale(1.2)",s&&(s.style.filter=e?"drop-shadow(0 0 5px #ef4444) sepia(1) saturate(1000%) hue-rotate(-50deg)":"drop-shadow(0 0 2px #ffffff)"),setTimeout(()=>{t.style.opacity="0",t.style.transform="translate(-50%, -50%) scale(1)"},100)}toggleScope(e){this.sniperScope&&(this.sniperScope.style.opacity=e?"1":"0"),this.crosshair&&(this.crosshair.style.opacity=e?"0":"1")}showMessage(e,t=2e3){const s=document.getElementById("message-display");s&&(s.textContent=e,s.style.opacity="1",setTimeout(()=>{s.style.opacity="0"},t))}showGameOver(e){const t=document.getElementById("game-over");if(t){t.style.display="flex";const s=document.getElementById("final-score"),i=document.getElementById("final-waves"),n=document.getElementById("final-kills"),o=document.getElementById("final-accuracy"),a=document.getElementById("final-time");s&&(s.textContent=e.score.toString()),i&&(i.textContent=e.wave.toString()),n&&(n.textContent=e.kills.toString()),o&&(o.textContent=e.accuracy.toString()),a&&(a.textContent=e.time)}}hideGameOver(){const e=document.getElementById("game-over");e&&(e.style.display="none")}updateCrosshair(e,t=!1,s=!1,i=!1){if(!this.crosshairTop)return;let n=8+e*1e4;i?n*=1.8:s?n*=1.4:t&&(n*=1.15),n=Math.min(n,55),this.crosshairTop.style.transform=`translateX(-50%) translateY(-${n}px)`,this.crosshairBottom.style.transform=`translateX(-50%) translateY(${n}px)`,this.crosshairLeft.style.transform=`translateY(-50%) translateX(-${n}px)`,this.crosshairRight.style.transform=`translateY(-50%) translateX(${n}px)`}showHitFeedback(e,t){this.crosshair&&(this.crosshair.classList.remove("hit","headshot","kill"),e?this.crosshair.classList.add("kill"):t?this.crosshair.classList.add("headshot"):this.crosshair.classList.add("hit"),setTimeout(()=>{this.crosshair.classList.remove("hit","headshot","kill")},100))}showPauseMenu(e){const t=document.getElementById("pause-menu");t&&(t.style.display=e?"flex":"none")}hideWaveDisplay(){this.waveDisplay&&(this.waveDisplay.style.display="none")}showWaveDisplay(){this.waveDisplay&&(this.waveDisplay.style.display="block")}hideStartScreen(){const e=document.getElementById("start-screen");e&&(e.style.display="none")}showKillIcon(){this.killIcon&&(this.killIcon.style.opacity="1",this.killIcon.style.transform="translate(-50%, -50%) scale(1.2)",setTimeout(()=>{this.killIcon.style.transform="translate(-50%, -50%) scale(1.0)"},50),setTimeout(()=>{this.killIcon.style.opacity="0"},500))}showHeadshotIcon(){this.headshotIcon&&(this.headshotIcon.style.opacity="1",this.headshotIcon.style.transform="translate(-50%, -50%) scale(1.2)",setTimeout(()=>{this.headshotIcon.style.transform="translate(-50%, -50%) scale(1.0)"},50),setTimeout(()=>{this.headshotIcon.style.opacity="0"},500))}showMultiKill(e){if(!this.multiKillDisplay)return;let t="",s="";switch(e){case 2:t="DOUBLE KILL",s="impact-tier-1";break;case 3:t="TRIPLE KILL",s="impact-tier-2";break;case 4:t="QUAD KILL",s="impact-tier-3";break;case 5:t="PENTA KILL",s="impact-tier-3";break;default:t="GODLIKE",s="impact-tier-4";break}this.multiKillDisplay.textContent=t,this.multiKillDisplay.className="",this.multiKillDisplay.style.opacity="1",requestAnimationFrame(()=>{this.multiKillDisplay.classList.add("impact-text",s,"shake")}),this.multiKillTimeout&&clearTimeout(this.multiKillTimeout),this.multiKillTimeout=window.setTimeout(()=>{this.multiKillDisplay.style.opacity="0",this.multiKillDisplay.className=""},3e3)}showHitStreak(e){if(!this.streakDisplay||e<3)return;this.streakDisplay.textContent=`${e} HIT STREAK`,this.streakDisplay.className="",this.streakDisplay.style.opacity="1";let t="impact-tier-1";e>=10?t="impact-tier-4":e>=7?t="impact-tier-3":e>=5&&(t="impact-tier-2"),requestAnimationFrame(()=>{this.streakDisplay.classList.add("impact-text",t),e>=5&&this.streakDisplay.classList.add("shake")}),this.streakTimeout&&clearTimeout(this.streakTimeout),this.streakTimeout=window.setTimeout(()=>{this.streakDisplay.style.opacity="0",this.streakDisplay.className=""},2e3)}addKillFeed(e,t,s,i,n=!1){this.killfeed.addKill(e,t,s,i,n)}hideHUD(){const e=document.getElementById("hud");e&&(e.style.display="none")}showHUD(){const e=document.getElementById("hud");e&&(e.style.display="block")}reset(){this.currentWave=0}updateScoreboard(e,t){const s=document.getElementById("scoreboard-body");if(!s)return;s.innerHTML="",Object.entries(e.players).map(([n,o])=>({id:n,...o})).sort((n,o)=>o.kills-n.kills).forEach(n=>{const o=document.createElement("tr");n.id===t&&o.classList.add("local-player");const a=n.id===t?"YOU":`Player ${n.id.substr(0,4)}`;o.innerHTML=`
                <td>${a}</td>
                <td>${n.kills}</td>
                <td>${n.deaths}</td>
                <td>${n.ping||0}ms</td>
            `,s.appendChild(o)})}toggleScoreboard(e){const t=document.getElementById("scoreboard");t&&(t.style.display=e?"block":"none")}showWaitingForPlayers(e){let t=document.getElementById("waiting-message");t||(t=document.createElement("div"),t.id="waiting-message",t.style.position="absolute",t.style.top="20%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.color="#ffffff",t.style.fontFamily="'Orbitron', sans-serif",t.style.fontSize="24px",t.style.fontWeight="bold",t.style.textShadow="0 0 10px rgba(0, 255, 255, 0.5)",t.style.zIndex="100",t.textContent="WAITING FOR PLAYERS...",document.body.appendChild(t)),t.style.display=e?"block":"none"}showTeamScoreboard(e){let t=document.getElementById("team-scores");t||(t=document.createElement("div"),t.id="team-scores",t.style.position="absolute",t.style.top="20px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.display="flex",t.style.gap="20px",t.style.fontFamily="'Orbitron', sans-serif",t.style.fontSize="32px",t.style.fontWeight="bold",t.style.zIndex="90",t.innerHTML=`
        <div id="score-blue" style="color: #3b82f6; text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);">0</div>
        <div style="color: #fff;">-</div>
        <div id="score-red" style="color: #ef4444; text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);">0</div>
      `,document.body.appendChild(t)),t.style.display=e?"flex":"none"}updateTeamScores(e,t){const s=document.getElementById("score-red"),i=document.getElementById("score-blue");s&&(s.textContent=e.toString()),i&&(i.textContent=t.toString())}showFlagStatus(e,t){let s=document.getElementById("flag-status");s||(s=document.createElement("div"),s.id="flag-status",s.style.position="absolute",s.style.top="60px",s.style.left="50%",s.style.transform="translateX(-50%)",s.style.display="flex",s.style.gap="40px",s.style.fontFamily="'Orbitron', sans-serif",s.style.fontSize="18px",s.style.fontWeight="bold",s.style.zIndex="90",s.style.textShadow="0 0 5px rgba(0,0,0,0.8)",document.body.appendChild(s));const i=n=>n==="TAKEN"?"#ffaa00":n==="DROPPED"?"#ffff00":"#ffffff";s.innerHTML=`
      <div style="color: #ef4444; display: flex; align-items: center; gap: 10px;">
        <span>RED FLAG:</span>
        <span style="color: ${i(e)}">${e}</span>
      </div>
      <div style="color: #3b82f6; display: flex; align-items: center; gap: 10px;">
        <span>BLUE FLAG:</span>
        <span style="color: ${i(t)}">${t}</span>
      </div>
    `,s.style.display="flex"}hideFlagStatus(){const e=document.getElementById("flag-status");e&&(e.style.display="none")}updateZoneInfo(e,t){let s=document.getElementById("zone-info");s||(s=document.createElement("div"),s.id="zone-info",s.style.position="absolute",s.style.top="100px",s.style.right="20px",s.style.textAlign="right",s.style.fontFamily="'Orbitron', sans-serif",s.style.color="#fff",s.style.textShadow="0 0 5px rgba(0,0,0,0.8)",document.body.appendChild(s));const i=t>0?`SHRINKING IN: ${Math.ceil(t)}s`:"ZONE SHRINKING!",n=t>0?"#fff":"#ef4444";s.innerHTML=`
          <div style="font-size: 18px; font-weight: bold; color: ${n}">${i}</div>
          <div style="font-size: 14px; color: #aaa">ZONE RADIUS: ${Math.round(e)}m</div>
      `,s.style.display="block"}updateAliveCount(e){let t=document.getElementById("alive-count");t||(t=document.createElement("div"),t.id="alive-count",t.style.position="absolute",t.style.top="20px",t.style.right="20px",t.style.fontFamily="'Orbitron', sans-serif",t.style.fontSize="24px",t.style.fontWeight="bold",t.style.color="#fff",t.style.textShadow="0 0 5px rgba(0,0,0,0.8)",document.body.appendChild(t)),t.textContent=`ALIVE: ${e}`,t.style.display="block"}showSpectatorUI(e){let t=document.getElementById("spectator-ui");t||(t=document.createElement("div"),t.id="spectator-ui",t.style.position="absolute",t.style.bottom="100px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.fontFamily="'Orbitron', sans-serif",t.style.fontSize="20px",t.style.fontWeight="bold",t.style.color="#fbbf24",t.style.textShadow="0 0 5px rgba(0,0,0,0.8)",document.body.appendChild(t)),t.textContent=`SPECTATING: ${e}`,t.style.display="block",this.hideHUD()}updateMinimap(e,t,s,i,n){let o=document.getElementById("minimap-canvas");if(!o){const d=document.createElement("div");d.id="minimap-container",d.style.position="absolute",d.style.bottom="20px",d.style.right="20px",d.style.width="200px",d.style.height="200px",d.style.border="2px solid #fff",d.style.borderRadius="50%",d.style.overflow="hidden",d.style.backgroundColor="rgba(0, 0, 0, 0.5)",document.body.appendChild(d),o=document.createElement("canvas"),o.id="minimap-canvas",o.width=200,o.height=200,d.appendChild(o)}const a=o.getContext("2d");if(!a)return;const l=200,c=l/2,h=l/t;a.clearRect(0,0,l,l),a.beginPath(),a.arc(c+i.x*h,c+i.z*h,s*h,0,Math.PI*2),a.fillStyle="rgba(0, 100, 255, 0.2)",a.fill(),a.strokeStyle="#0066ff",a.lineWidth=2,a.stroke(),n.forEach(d=>{a.beginPath(),a.arc(c+d.x*h,c+d.z*h,3,0,Math.PI*2),a.fillStyle=d.team==="blue"?"#3b82f6":"#ef4444",a.fill()}),a.beginPath(),a.arc(c+e.x*h,c+e.z*h,4,0,Math.PI*2),a.fillStyle="#00ff00",a.fill(),a.strokeStyle="#fff",a.lineWidth=1,a.stroke()}setupSettingsMenu(e,t,s){const i=document.getElementById("settings-btn"),n=document.getElementById("settings-menu"),o=document.getElementById("settings-back-btn"),a=document.getElementById("pause-menu"),l=document.getElementById("sensitivity-slider"),c=document.getElementById("sensitivity-value"),h=document.getElementById("volume-slider"),d=document.getElementById("volume-value"),u=document.getElementById("fov-slider"),p=document.getElementById("fov-value");i&&n&&o&&a&&(i.addEventListener("click",()=>{a.style.display="none",n.style.display="flex";const y=e.getSettings();l&&c&&(l.value=y.sensitivity.toString(),c.textContent=y.sensitivity.toFixed(4)),h&&d&&(h.value=y.volume.toString(),d.textContent=`${Math.round(y.volume*100)}%`),u&&p&&(u.value=y.fov.toString(),p.textContent=y.fov.toString())}),o.addEventListener("click",()=>{n.style.display="none",a.style.display="flex",t()})),l&&c&&l.addEventListener("input",y=>{const m=parseFloat(y.target.value);e.setSensitivity(m),c.textContent=m.toFixed(4),s&&s()}),h&&d&&h.addEventListener("input",y=>{const m=parseFloat(y.target.value);e.setVolume(m),d.textContent=`${Math.round(m*100)}%`,s&&s()}),u&&p&&u.addEventListener("input",y=>{const m=parseInt(y.target.value);e.setFOV(m),p.textContent=m.toString(),s&&s()})}show(){this.showHUD()}hide(){this.hideHUD()}updateKillfeed(e){}}class ar{constructor(e){this.bufferCache=new Map,this.activeAudio=[],this.volumes={master:1,music:.5,sfx:.8,ambient:.6,voice:1},this.sfxPool=[],this.positionalPool=[],this.poolSize=20,this.listener=new Ci,e.add(this.listener),this.audioLoader=new Ts;for(let t=0;t<this.poolSize;t++)this.sfxPool.push(new Di(this.listener)),this.positionalPool.push(new F(this.listener))}getListener(){return this.listener}async loadAudio(e){return this.bufferCache.has(e)?this.bufferCache.get(e):new Promise((t,s)=>{this.audioLoader.load(e,i=>{this.bufferCache.set(e,i),t(i)},void 0,i=>{console.warn(`Failed to load audio: ${e}`,i),s(i)})})}async preloadAudios(e){await Promise.all(e.map(t=>this.loadAudio(t).catch(()=>null)))}playSound(e,t="sfx",s={}){const i=this.getFromPool(this.sfxPool);if(!i)return null;const n=o=>{i.isPlaying&&i.stop(),i.setBuffer(o),i.setVolume(this.getEffectiveVolume(t)*(s.volume??1)),i.setLoop(s.loop??!1),i.play()};return typeof e=="string"?this.bufferCache.has(e)?n(this.bufferCache.get(e)):this.loadAudio(e).then(n).catch(()=>{}):n(e),i}playPositionalSound(e,t,s="sfx",i={}){const n=this.getPositionalFromPool();if(!n)return null;n.position.copy(t),n.setRefDistance(i.refDistance??5),n.setRolloffFactor(i.rolloffFactor??1),n.setMaxDistance(i.maxDistance??50);const o=a=>{n.isPlaying&&n.stop(),n.setBuffer(a),n.setVolume(this.getEffectiveVolume(s)*(i.volume??1)),n.setLoop(i.loop??!1),n.play()};return typeof e=="string"?this.bufferCache.has(e)?o(this.bufferCache.get(e)):this.loadAudio(e).then(o).catch(()=>{}):o(e),n}playWeaponSound(e,t,s=.5){this.bufferCache.has(e)?this.playSound(this.bufferCache.get(e),"sfx",{volume:s}):this.playSound(e,"sfx",{volume:s}),t&&this.playSound(t,"sfx",{volume:s*.6})}setMasterVolume(e){this.volumes.master=Math.max(0,Math.min(1,e)),this.listener.setMasterVolume(this.volumes.master)}setCategoryVolume(e,t){this.volumes[e]=Math.max(0,Math.min(1,t))}getEffectiveVolume(e){return this.volumes.master*this.volumes[e]}getMasterVolume(){return this.volumes.master}getFromPool(e){for(const t of e)if(!t.isPlaying)return t;return e[0]||null}getPositionalFromPool(){for(const e of this.positionalPool)if(!e.isPlaying)return e;return this.positionalPool[0]||null}playAmbient(e,t=.6){return this.playSound(e,"ambient",{volume:t,loop:!0})}playMusic(e,t=.5){return this.stopCategory("music"),this.playSound(e,"ambient",{volume:t,loop:!0})}stopCategory(e){this.activeAudio.filter(t=>t.category===e).forEach(t=>{t.audio.isPlaying&&t.audio.stop()})}stopAll(){[...this.sfxPool,...this.positionalPool].forEach(e=>{e.isPlaying&&e.stop()})}mute(){this.listener.setMasterVolume(0)}unmute(){this.listener.setMasterVolume(this.volumes.master)}dispose(){this.stopAll(),this.bufferCache.clear(),this.sfxPool=[],this.positionalPool=[]}}class rr{constructor(e,t,s,i){this.isInitialized=!1,this.camera=t,this.raycaster=new so,this.raycaster.camera=t,this.audioManager=new ar(t),this.particleSystem=new er(e),this.decalSystem=new sr(e),this.tracerSystem=new ir(e,t),this.impactSystem=new tr(e,s),this.screenEffects=new nr(t),this.weaponSystem=new $i(e,t,i,this.audioManager),this.hudManager=new or,this.killfeedManager=new Xi,this.isInitialized=!0,console.log("RIFT Integration Initialized")}handleShooting(e,t,s,i){const n=this.weaponSystem.shoot(this.camera,e,t,s);if(n.shotFired){const o=this.weaponSystem.currentConfig,a=o.damage/30;this.screenEffects.addFireShake(a),this.screenEffects.addFOVPunch(1.5*a,.08);const l=o.recoil.pitchAmount*.5,c=(Math.random()-.5)*o.recoil.yawAmount*.5;this.screenEffects.applyRecoil(l,c),this.screenEffects.setRecoilRecoveryRate(o.recoil.recoveryRate);const h=this.weaponSystem.getMuzzleWorldPosition(),d=this.camera.getWorldDirection(new S);this.particleSystem.spawnMuzzleSmoke(h,d),(n.directions||[n.direction]).forEach(p=>{this.processShot(p,i)}),this.updateHUD()}}processEnemyShot(e,t,s,i,n,o){var d,u;const a=new S;e.getWorldPosition(a),this.raycaster.set(a,t);const l=this.raycaster.intersectObjects(i,!0);let c,h=null;if(l.length>0){const p=l[0];c=p.point,h=p.object;let y=re.ROCK;h.name.includes("wood")||h.userData.material==="wood"?y=re.WOOD:(h.name.includes("metal")||h.userData.material==="metal")&&(y=re.METAL),this.decalSystem.createDecal(p.point,((d=p.face)==null?void 0:d.normal)||new S(0,1,0),y),this.particleSystem.spawnMaterialImpact(p.point,((u=p.face)==null?void 0:u.normal)||new S(0,1,0),y),this.impactSystem.playSurfaceImpact(p.point,y);let m=h.userData.entity;if(m||h.traverseAncestors(f=>{!m&&f.userData.entity&&(m=f.userData.entity)}),m&&m!==n){if(console.log("Enemy hit entity:",m.name,"Health:",m.health,"Damage:",o),m.handleMessage){const f={message:yt,data:{damage:o,direction:t},sender:n};m.handleMessage(f)}this.impactSystem.playBodyImpact(p.point),this.particleSystem.spawnImpactEffect(p.point,!1)}}else c=e.position.clone().add(t.multiplyScalar(100));this.tracerSystem.createTracer(s,c)}processShot(e,t){var l,c,h;const s=this.weaponSystem.getMuzzleWorldPosition(),i=new S;this.camera.getWorldPosition(i),this.raycaster.set(i,e),console.log("=== RAYCAST START ==="),console.log("Origin:",i),console.log("Direction:",e),console.log("Obstacles:",t.length),t.forEach((d,u)=>{console.log(`  [${u}] ${d.name||d.type} - Children: ${d.children.length}`)});const n=this.raycaster.intersectObjects(t,!0);console.log("Intersects found:",n.length),n.length===0?console.log(" MISS - No hits detected"):(console.log(" HIT:",n[0].object.name,"at distance",n[0].distance.toFixed(2)),console.log("  Object type:",n[0].object.type),console.log("  Has userData.entity:",!!n[0].object.userData.entity));let o,a=null;if(n.length>0){const d=n[0];o=d.point,a=d.object,console.log("Raycast hit:",a.name,a.userData);let u=re.ROCK;a.name.includes("wood")||a.userData.material==="wood"?u=re.WOOD:(a.name.includes("metal")||a.userData.material==="metal")&&(u=re.METAL),this.decalSystem.createDecal(d.point,((l=d.face)==null?void 0:l.normal)||new S(0,1,0),u),this.particleSystem.spawnMaterialImpact(d.point,((c=d.face)==null?void 0:c.normal)||new S(0,1,0),u),this.impactSystem.playSurfaceImpact(d.point,u);let p=a.userData.entity;if(p||a.traverseAncestors(y=>{!p&&y.userData.entity&&(p=y.userData.entity)}),p){console.log("HIT ENTITY:",p.name,"Health:",p.health);const y=((h=p.position)==null?void 0:h.y)??0,m=p.height??1.8,f=y+m*.85,_=d.point.y>=f,M=this.weaponSystem.currentConfig.damage,E=_?M*2.5:M;if(console.log(`Hit at Y=${d.point.y.toFixed(2)}, HeadZone=${f.toFixed(2)}, Headshot=${_}`),p.handleMessage){const I={message:yt,data:{damage:E,direction:e,isHeadshot:_},sender:{isPlayer:!0,uuid:"player"}};p.handleMessage(I)}this.impactSystem.playBodyImpact(d.point),this.impactSystem.playHitConfirmation();const T=p.health<=0;this.hudManager.showHitmarker(T),this.hudManager.showHitFeedback(T,_),T&&(this.impactSystem.playDeathImpact(d.point),_?this.hudManager.showHeadshotIcon():this.hudManager.showKillIcon()),this.particleSystem.spawnImpactEffect(d.point,_)}}else o=this.camera.position.clone().add(e.multiplyScalar(100));this.tracerSystem.createTracer(s,o)}update(e,t,s){this.isInitialized&&(this.weaponSystem.update(e,t,s),this.particleSystem.update(e),this.decalSystem.update(e),this.tracerSystem.update(e),this.screenEffects.update(e),this.updateHUD())}updateHUD(){this.hudManager.updateAmmo(this.weaponSystem.currentMag,this.weaponSystem.reserveAmmo);const e=this.weaponSystem.getCurrentSpread();this.hudManager.updateCrosshair(e*100)}resize(e,t){}dispose(){this.decalSystem.clear(),this.tracerSystem.clear(),this.particleSystem.clear(),this.screenEffects.reset()}applyDamageEffects(e,t,s){const i=e/t;this.screenEffects.addDamageShake(i),this.hudManager.showDamageVignette(e,t,s),s!==void 0&&this.hudManager.flashDamage(s)}getCameraRecoil(){return this.screenEffects.getRecoil()}getShakeOffset(){return this.screenEffects.getShakeOffset()}}var se=(r=>(r.FREE_FOR_ALL="FREE_FOR_ALL",r.TEAM_DEATHMATCH="TEAM_DEATHMATCH",r.CAPTURE_THE_FLAG="CAPTURE_THE_FLAG",r.WAVE_SURVIVAL="WAVE_SURVIVAL",r.PRACTICE="PRACTICE",r))(se||{}),ie=(r=>(r.NONE="NONE",r.RED="RED",r.BLUE="BLUE",r))(ie||{});class Ps{constructor(e,t,s){this.isActive=!1,this.world=e,this.hudManager=t,this.config=s,this.state={isRunning:!1,isPaused:!1,timeRemaining:s.timeLimit||0,redScore:0,blueScore:0,wave:1,roundNumber:1,scores:new Map}}init(){console.log(`Initializing ${this.getName()} mode...`),this.resetState(),this.setupHUD()}start(){console.log(`Starting ${this.getName()} mode...`),this.isActive=!0,this.state.isRunning=!0,this.hudManager.showMessage(`${this.getName()} Started!`,3e3)}update(e){!this.isActive||!this.state.isRunning||this.state.isPaused||(this.config.timeLimit&&this.config.timeLimit>0&&(this.state.timeRemaining-=e,this.updateTimer(),this.state.timeRemaining<=0&&this.onTimeUp()),this.config.scoreLimit&&this.config.scoreLimit>0&&this.checkScoreLimit()&&this.onScoreLimitReached())}cleanup(){console.log(`Cleaning up ${this.getName()} mode...`),this.isActive=!1,this.state.isRunning=!1,this.hideHUD()}isGameOver(){return!this.state.isRunning}onPlayerDeath(e){const t=this.state.scores.get(e);t&&(t.deaths++,this.state.scores.set(e,t)),this.config.respawnTime!==void 0&&setTimeout(()=>{this.respawnPlayer(e)},this.config.respawnTime*1e3)}onPlayerKill(e,t,s,i){const n=this.state.scores.get(e);n&&(n.kills++,n.score+=i?150:100,i&&n.headshots++,this.state.scores.set(e,n));const o=this.getPlayerName(e),a=this.getPlayerName(t);this.hudManager.addKillFeed(o,a,s,i),e===this.world.player.uuid&&(this.hudManager.showHitmarker(!0),this.hudManager.showKillIcon())}resetState(){this.state={isRunning:!1,isPaused:!1,timeRemaining:this.config.timeLimit||0,redScore:0,blueScore:0,wave:1,roundNumber:1,scores:new Map},this.initializePlayerScores()}initializePlayerScores(){this.state.scores.set(this.world.player.uuid,this.createEmptyScore(this.world.player.uuid,"Player",ie.NONE));for(const e of this.world.competitors)e.uuid!==this.world.player.uuid&&this.state.scores.set(e.uuid,this.createEmptyScore(e.uuid,e.name||`Bot_${e.uuid.slice(0,4)}`,ie.NONE))}createEmptyScore(e,t,s){return{id:e,name:t,team:s,kills:0,deaths:0,assists:0,score:0,headshots:0,damageDealt:0}}getPlayerName(e){const t=this.state.scores.get(e);return t?t.name:e===this.world.player.uuid?"You":`Player_${e.slice(0,4)}`}setupHUD(){}hideHUD(){}updateTimer(){const e=Math.floor(Math.max(0,this.state.timeRemaining)/60),t=Math.floor(Math.max(0,this.state.timeRemaining)%60),s=document.getElementById("game-timer");s&&(s.textContent=`${e}:${t.toString().padStart(2,"0")}`)}checkScoreLimit(){return!1}onTimeUp(){this.endGame("TIME UP")}onScoreLimitReached(){this.endGame("SCORE LIMIT REACHED")}endGame(e){this.state.isRunning=!1;const t=this.determineWinner();this.hudManager.showMessage(`${e}
${t}`,5e3)}determineWinner(){let e=-1,t="No Winner";return this.state.scores.forEach((s,i)=>{s.score>e&&(e=s.score,t=s.name)}),`Winner: ${t} (${e} points)`}respawnPlayer(e){if(e===this.world.player.uuid)this.world.player.respawn&&this.world.player.respawn();else{const t=this.world.competitors.find(s=>s.uuid===e);t&&this.world.spawningManager.respawnCompetitor(t)}}getState(){return{...this.state}}getConfig(){return{...this.config}}getScores(){return Array.from(this.state.scores.values()).sort((e,t)=>t.score-e.score)}pause(){this.state.isPaused=!0}resume(){this.state.isPaused=!1}}const lr={name:"Free For All",type:se.FREE_FOR_ALL,description:"Every player for themselves. First to reach the score limit wins!",minPlayers:2,maxPlayers:16,timeLimit:600,scoreLimit:30,respawnTime:3,teamBased:!1,friendlyFire:!0};class cr extends Ps{constructor(e,t,s){super(e,t,{...lr,...s}),this.leaderId=null}getName(){return"Free For All"}getType(){return se.FREE_FOR_ALL}init(){super.init(),this.leaderId=null}start(){super.start(),this.state.scores.forEach((t,s)=>{t.team=ie.NONE,this.state.scores.set(s,t)});const e=document.getElementById("game-timer");e&&(e.style.display="block")}update(e){super.update(e),this.state.isRunning&&this.updateLeader()}onPlayerKill(e,t,s,i){super.onPlayerKill(e,t,s,i);const n=this.state.scores.get(e);if(n&&this.leaderId!==e){const o=this.leaderId?this.state.scores.get(this.leaderId):null;if(!o||n.kills>o.kills){const a=this.leaderId;this.leaderId=e,a&&e===this.world.player.uuid&&this.hudManager.showMessage("YOU TOOK THE LEAD!",2e3)}}e===this.world.player.uuid&&n&&this.checkKillStreak(n.kills)}checkScoreLimit(){if(!this.config.scoreLimit)return!1;for(const[e,t]of this.state.scores)if(t.kills>=this.config.scoreLimit)return!0;return!1}determineWinner(){let e=-1,t="No Winner",s="";return this.state.scores.forEach((i,n)=>{i.kills>e&&(e=i.kills,t=i.name,s=n)}),s===this.world.player.uuid?"YOU WIN!":`Winner: ${t} (${e} kills)`}updateLeader(){let e=-1,t=null;this.state.scores.forEach((s,i)=>{s.kills>e&&(e=s.kills,t=i)}),this.leaderId=t}checkKillStreak(e){const t={3:"KILLING SPREE",5:"RAMPAGE",7:"DOMINATING",10:"UNSTOPPABLE",15:"GODLIKE",20:"LEGENDARY"};t[e]&&this.hudManager.showMessage(t[e],2e3)}cleanup(){super.cleanup();const e=document.getElementById("game-timer");e&&(e.style.display="none")}}const hr={name:"Team Deathmatch",type:se.TEAM_DEATHMATCH,description:"Red vs Blue. First team to reach the score limit wins!",minPlayers:4,maxPlayers:16,timeLimit:900,scoreLimit:75,respawnTime:5,teamBased:!0,friendlyFire:!1};class dr extends Ps{constructor(e,t,s){super(e,t,{...hr,...s}),this.playerTeam=ie.BLUE}getName(){return"Team Deathmatch"}getType(){return se.TEAM_DEATHMATCH}init(){super.init(),this.state.redScore=0,this.state.blueScore=0}start(){super.start(),this.assignTeams(),this.showTeamScoreboard(),this.updateTeamHUD()}update(e){super.update(e),this.state.isRunning&&this.updateTeamScores()}onPlayerKill(e,t,s,i){const n=this.state.scores.get(e),o=this.state.scores.get(t);if(!(!n||!o)){if(n.team===o.team){if(!this.config.friendlyFire)return;n.score-=50,this.state.scores.set(e,n),e===this.world.player.uuid&&this.hudManager.showMessage("TEAM KILL! (-50)",2e3);return}n.team===ie.RED?this.state.redScore++:n.team===ie.BLUE&&this.state.blueScore++,super.onPlayerKill(e,t,s,i),this.updateTeamScores()}}checkScoreLimit(){return this.config.scoreLimit?this.state.redScore>=this.config.scoreLimit||this.state.blueScore>=this.config.scoreLimit:!1}determineWinner(){return this.state.redScore>this.state.blueScore?this.playerTeam===ie.RED?"YOUR TEAM WINS!":"RED TEAM WINS!":this.state.blueScore>this.state.redScore?this.playerTeam===ie.BLUE?"YOUR TEAM WINS!":"BLUE TEAM WINS!":"DRAW!"}assignTeams(){const e=Array.from(this.state.scores.keys()),t=Math.ceil(e.length/2);e.forEach((s,i)=>{const n=this.state.scores.get(s);n.team=i<t?ie.RED:ie.BLUE,this.state.scores.set(s,n),s===this.world.player.uuid&&(this.playerTeam=n.team)})}showTeamScoreboard(){const e=document.getElementById("score-container");e&&(e.style.display="flex");const t=document.getElementById("game-timer");t&&(t.style.display="block",t.style.top="60px")}updateTeamScores(){const e=document.getElementById("red-score"),t=document.getElementById("blue-score");e&&(e.textContent=this.state.redScore.toString()),t&&(t.textContent=this.state.blueScore.toString())}updateTeamHUD(){const e=document.getElementById("rift-hud");e&&(e.classList.remove("team-red","team-blue"),e.classList.add(this.playerTeam===ie.RED?"team-red":"team-blue"))}getPlayerTeam(e){const t=this.state.scores.get(e);return(t==null?void 0:t.team)||ie.NONE}getTeamScores(){return{red:this.state.redScore,blue:this.state.blueScore}}cleanup(){super.cleanup();const e=document.getElementById("score-container");e&&(e.style.display="none");const t=document.getElementById("game-timer");t&&(t.style.display="none",t.style.top="20px");const s=document.getElementById("rift-hud");s&&s.classList.remove("team-red","team-blue")}}const ur={name:"Wave Survival",type:se.WAVE_SURVIVAL,description:"Survive endless waves of enemies. How long can you last?",minPlayers:1,maxPlayers:4,timeLimit:0,scoreLimit:0,respawnTime:0,teamBased:!1,friendlyFire:!1};class mr extends Ps{constructor(e,t,s){super(e,t,{...ur,...s}),this.waveInProgress=!1,this.betweenWaves=!1,this.enemiesRemaining=0,this.waveStartTime=0,this.timeBetweenWaves=5e3}getName(){return"Wave Survival"}getType(){return se.WAVE_SURVIVAL}init(){super.init(),this.state.wave=0,this.waveInProgress=!1,this.betweenWaves=!1,this.enemiesRemaining=0}start(){super.start(),this.state.wave=0;const e=this.state.scores.get(this.world.player.uuid);e&&(e.score=0,e.kills=0,this.state.scores.set(this.world.player.uuid,e)),this.showWaveDisplay(),this.startNextWave()}update(e){if(!(!this.isActive||!this.state.isRunning||this.state.isPaused)){if(this.enemiesRemaining=this.countActiveEnemies(),this.updateEnemyCounter(),this.waveInProgress&&this.enemiesRemaining===0&&this.completeWave(),this.betweenWaves){const t=Date.now()-this.waveStartTime;if(t>=this.timeBetweenWaves)this.startNextWave();else{const s=Math.ceil((this.timeBetweenWaves-t)/1e3);this.hudManager.showMessage(`Next wave in ${s}...`,1e3)}}this.world.player.health<=0&&!this.betweenWaves&&this.onPlayerDeath(this.world.player.uuid)}}onPlayerKill(e,t,s,i){if(e!==this.world.player.uuid)return;const n=this.state.scores.get(this.world.player.uuid);if(n){n.kills++;const o=100*this.state.wave,a=i?50:0;n.score+=o+a,i&&n.headshots++,this.state.scores.set(this.world.player.uuid,n)}this.hudManager.showHitmarker(!0),this.updateScoreDisplay()}onPlayerDeath(e){this.endGame("YOU DIED")}startNextWave(){this.state.wave++,this.waveInProgress=!0,this.betweenWaves=!1;const s=Math.min(3+(this.state.wave-1)*2,20);this.spawnWaveEnemies(s),this.hudManager.showMessage(`WAVE ${this.state.wave}`,2e3),this.updateWaveDisplay()}completeWave(){this.waveInProgress=!1,this.betweenWaves=!0,this.waveStartTime=Date.now();const e=this.state.scores.get(this.world.player.uuid);if(e){const t=this.state.wave*500;e.score+=t,this.state.scores.set(this.world.player.uuid,e)}this.hudManager.showMessage(`WAVE ${this.state.wave} COMPLETE!
+${this.state.wave*500} BONUS`,3e3),this.updateScoreDisplay(),Math.min(25,this.world.player.maxHealth-this.world.player.health)}spawnWaveEnemies(e){let t=0;for(const s of this.world.competitors)s.uuid!==this.world.player.uuid&&t<e&&(s.active=!0,this.world.spawningManager.respawnCompetitor(s),t++);this.enemiesRemaining=e}countActiveEnemies(){let e=0;for(const t of this.world.competitors){const s=t;s.uuid!==this.world.player.uuid&&s.active&&s.health>0&&e++}return e}showWaveDisplay(){var t;let e=document.getElementById("wave-display");e||(e=document.createElement("div"),e.id="wave-display",e.style.cssText=`
        position: absolute;
        top: 20px;
        left: 20px;
        font-size: 24px;
        font-weight: bold;
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      `,(t=document.getElementById("rift-hud"))==null||t.appendChild(e)),e.style.display="block"}updateWaveDisplay(){const e=document.getElementById("wave-display");e&&(e.innerHTML=`
        <div>WAVE ${this.state.wave}</div>
        <div id="enemy-counter" style="font-size: 16px; color: #ff6666;">
          Enemies: ${this.enemiesRemaining}
        </div>
      `)}updateEnemyCounter(){const e=document.getElementById("enemy-counter");e&&(e.textContent=`Enemies: ${this.enemiesRemaining}`)}updateScoreDisplay(){const e=this.state.scores.get(this.world.player.uuid);if(e){if(!document.getElementById("wave-score")){const i=document.getElementById("wave-display");if(i){const n=document.createElement("div");n.id="wave-score",n.style.cssText="font-size: 18px; color: #ffdd00;",i.appendChild(n)}}const s=document.getElementById("wave-score");s&&(s.textContent=`Score: ${e.score}`)}}determineWinner(){const e=this.state.scores.get(this.world.player.uuid);return`Survived ${this.state.wave-1} waves
Kills: ${(e==null?void 0:e.kills)||0}
Final Score: ${(e==null?void 0:e.score)||0}`}getWaveInfo(){return{wave:this.state.wave,enemiesRemaining:this.enemiesRemaining,inProgress:this.waveInProgress}}cleanup(){super.cleanup();const e=document.getElementById("wave-display");e&&(e.style.display="none")}}class pr{constructor(e,t){this.currentMode=null,this.world=e,this.hudManager=t,this.modes=new Map,this.initializeModes()}initializeModes(){this.modes.set(se.FREE_FOR_ALL,new cr(this.world,this.hudManager)),this.modes.set(se.TEAM_DEATHMATCH,new dr(this.world,this.hudManager)),this.modes.set(se.WAVE_SURVIVAL,new mr(this.world,this.hudManager))}setMode(e){this.currentMode&&this.currentMode.cleanup();const t=this.modes.get(e);if(!t){console.error(`Game mode ${e} not found!`);return}console.log(`Switching to ${t.getName()} mode`),this.currentMode=t,this.currentMode.init(),this.currentMode.start()}update(e){this.currentMode&&this.currentMode.update(e)}getCurrentMode(){return this.currentMode}getCurrentModeType(){var e;return((e=this.currentMode)==null?void 0:e.getType())||null}getAvailableModes(){return Array.from(this.modes.keys())}getMode(e){return this.modes.get(e)}registerMode(e,t){this.modes.set(e,t)}onPlayerKill(e,t,s,i){this.currentMode&&this.currentMode.onPlayerKill(e,t,s,i)}onPlayerDeath(e){this.currentMode&&this.currentMode.onPlayerDeath(e)}pause(){var e,t;this.currentMode&&((t=(e=this.currentMode).pause)==null||t.call(e))}resume(){var e,t;this.currentMode&&((t=(e=this.currentMode).resume)==null||t.call(e))}restart(){this.currentMode&&(this.currentMode.cleanup(),this.currentMode.init(),this.currentMode.start())}isGameOver(){var e;return((e=this.currentMode)==null?void 0:e.isGameOver())??!0}dispose(){this.currentMode&&(this.currentMode.cleanup(),this.currentMode=null),this.modes.clear()}}const fr={serverUrl:"/",updateRate:50,interpolationDelay:100,maxPredictionTime:200};class gr{constructor(e,t,s){this.team="",this.isDead=!1,this.stateBuffer=[],this.interpolationDelay=100,this.nameLabelSprite=null,this.scene=e,this.id=t,this.username=s||`Player_${t.slice(0,4)}`,this.currentPosition=new S,this.targetPosition=new S,this.targetRotation=new ki,this.mesh=new X,this.mesh.name=`RemotePlayer_${t}`;const i=new io(.3,1.2,8,16),n=new R({color:65280,roughness:.7,metalness:.1});this.bodyMesh=new x(i,n),this.bodyMesh.position.y=.9,this.bodyMesh.castShadow=!0,this.bodyMesh.receiveShadow=!0,this.mesh.add(this.bodyMesh);const o=new Ms(.2,16,16),a=new R({color:16764057,roughness:.6});this.headMesh=new x(o,a),this.headMesh.position.y=1.7,this.headMesh.castShadow=!0,this.mesh.add(this.headMesh),this.createNameLabel(),this.scene.add(this.mesh)}createNameLabel(){const e=document.createElement("canvas"),t=e.getContext("2d");e.width=256,e.height=64,t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,e.width,e.height),t.font="bold 24px Arial",t.fillStyle="white",t.textAlign="center",t.textBaseline="middle",t.fillText(this.username,e.width/2,e.height/2);const s=new Pi(e),i=new le({map:s,transparent:!0,depthTest:!1});this.nameLabelSprite=new te(i),this.nameLabelSprite.position.y=2.2,this.nameLabelSprite.scale.set(1.5,.4,1),this.mesh.add(this.nameLabelSprite)}updateState(e,t,s,i){for(this.stateBuffer.push({userId:this.id,position:e,rotation:t,isSprinting:s,isGrounded:i,timestamp:Date.now()});this.stateBuffer.length>10;)this.stateBuffer.shift()}update(e){if(this.isDead)return;const t=Date.now()-this.interpolationDelay;let s=null,i=null;for(let o=0;o<this.stateBuffer.length-1;o++)if(this.stateBuffer[o].timestamp<=t&&this.stateBuffer[o+1].timestamp>=t){s=this.stateBuffer[o],i=this.stateBuffer[o+1];break}if(s&&i){const o=i.timestamp-s.timestamp,a=o>0?(t-s.timestamp)/o:0;this.targetPosition.set(s.position.x+(i.position.x-s.position.x)*a,s.position.y+(i.position.y-s.position.y)*a,s.position.z+(i.position.z-s.position.z)*a),this.targetRotation.set(s.rotation.x+(i.rotation.x-s.rotation.x)*a,s.rotation.y+(i.rotation.y-s.rotation.y)*a,0)}else if(this.stateBuffer.length>0){const o=this.stateBuffer[this.stateBuffer.length-1];this.targetPosition.set(o.position.x,o.position.y,o.position.z),this.targetRotation.set(o.rotation.x,o.rotation.y,0)}const n=1-Math.pow(.001,e);this.currentPosition.lerp(this.targetPosition,n),this.mesh.position.copy(this.currentPosition),this.mesh.rotation.y=this.targetRotation.y,this.headMesh.rotation.x=this.targetRotation.x,this.nameLabelSprite}setTeam(e){this.team=e;const t=this.bodyMesh.material;e==="red"?t.color.setHex(16729156):e==="blue"?t.color.setHex(4474111):t.color.setHex(65280)}getMesh(){return this.mesh}getPosition(){return this.currentPosition.clone()}die(){this.isDead=!0;const e=500,t=Date.now(),s=()=>{const i=Date.now()-t,n=Math.min(i/e,1);this.mesh.rotation.z=Math.PI/2*n,this.mesh.position.y=.5*(1-n),n<1&&requestAnimationFrame(s)};s()}respawn(e){this.isDead=!1,this.mesh.rotation.z=0,this.stateBuffer=[],e&&(this.currentPosition.copy(e),this.targetPosition.copy(e),this.mesh.position.copy(e))}destroy(){var e;this.scene.remove(this.mesh),this.bodyMesh.geometry.dispose(),this.bodyMesh.material.dispose(),this.headMesh.geometry.dispose(),this.headMesh.material.dispose(),this.nameLabelSprite&&((e=this.nameLabelSprite.material.map)==null||e.dispose(),this.nameLabelSprite.material.dispose())}}const yr="modulepreload",wr=function(r){return"/"+r},yi={},qi=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){let o=function(c){return Promise.all(c.map(h=>Promise.resolve(h).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),l=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));i=o(t.map(c=>{if(c=wr(c),c in yi)return;yi[c]=!0;const h=c.endsWith(".css"),d=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${d}`))return;const u=document.createElement("link");if(u.rel=h?"stylesheet":yr,h||(u.as="script"),u.crossOrigin="",u.href=c,l&&u.setAttribute("nonce",l),document.head.appendChild(u),h)return new Promise((p,y)=>{u.addEventListener("load",p),u.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${c}`)))})}))}function n(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return i.then(o=>{for(const a of o||[])a.status==="rejected"&&n(a.reason);return e().catch(n)})};class _r{constructor(e,t){this.socket=null,this.remotePlayers=new Map,this.deadPlayers=new Set,this.myUserId="",this.myTeam="",this.playerTeams=new Map,this.matchId="",this.matchState=null,this.lastUpdate=0,this.io=null,this.scene=e,this.config={...fr,...t}}async connect(e,t,s="default_match"){var i,n;if((i=this.socket)!=null&&i.connected)return console.log("Already connected"),!0;this.matchId=s,this.myUserId=this.extractUserId(t);try{const o=await qi(()=>import("./network-j843apyr.js"),[]);if(this.io=o.io||((n=o.default)==null?void 0:n.io),!this.io)throw new Error("socket.io-client not properly loaded");return console.log("Connecting to game server..."),this.socket=this.io(e,{auth:{token:t},transports:["websocket"]}),this.setupListeners(),!0}catch(o){return console.warn("Socket.IO not available, multiplayer disabled:",o),!1}}extractUserId(e){const t=e.split("-");return t[t.length-1]||"0"}setupListeners(){this.socket&&(this.socket.on("connect",()=>{var e;console.log("Connected to game server"),(e=this.socket)==null||e.emit("join_match",this.matchId)}),this.socket.on("disconnect",()=>{console.log("Disconnected from game server")}),this.socket.on("player_joined",e=>{const{userId:t,team:s}=e;console.log(`Player ${t} joined (${s||"no team"})`),s&&this.playerTeams.set(t,s),t!==this.myUserId&&!this.remotePlayers.has(t)&&this.addRemotePlayer(t)}),this.socket.on("player_update",e=>{const{userId:t,position:s,rotation:i,isSprinting:n,isGrounded:o}=e,a=String(t);if(this.deadPlayers.has(a)||a===this.myUserId)return;let l=this.remotePlayers.get(a);l||(l=this.addRemotePlayer(a)),l.updateState(s,i,n,o)}),this.socket.on("player_shoot",e=>{const{userId:t}=e;console.log(`Player ${t} shot`)}),this.socket.on("player_damaged",e=>{const{targetId:t,attackerId:s,damage:i}=e;console.log(`Player ${t} took ${i} damage from ${s}`),String(t)===this.myUserId&&this.onDamageCallback&&this.onDamageCallback(t,s,i)}),this.socket.on("player_killed",e=>{const{victimId:t,attackerId:s,weaponType:i}=e;console.log(`Player ${t} killed by ${s} with ${i}`);const n=String(t);this.deadPlayers.add(n);const o=this.remotePlayers.get(n);o&&(o.die(),setTimeout(()=>{o.destroy(),this.remotePlayers.delete(n)},2e3)),this.onKillCallback&&this.onKillCallback(s,t,i)}),this.socket.on("player_respawned",e=>{const{userId:t,team:s}=e,i=String(t);console.log(`Player ${i} respawned (${s||"no team"})`),s&&this.playerTeams.set(i,s),this.deadPlayers.delete(i),i!==this.myUserId&&!this.remotePlayers.has(i)&&this.addRemotePlayer(i)}),this.socket.on("match_state",e=>{console.log("Received match state:",e),this.matchState=e,this.matchState.teams&&Object.entries(this.matchState.teams).forEach(([t,s])=>{if(this.playerTeams.set(t,s),t===this.myUserId)this.myTeam=s;else{const i=this.remotePlayers.get(t);i&&i.setTeam(s)}}),this.onScoreUpdateCallback&&this.onScoreUpdateCallback(this.matchState)}),this.socket.on("score_update",e=>{console.log("Score update:",e),this.matchState=e,this.onScoreUpdateCallback&&this.onScoreUpdateCallback(this.matchState)}),this.socket.on("match_ended",e=>{console.log("Match ended:",e),this.matchState=e,this.onMatchEndCallback&&this.onMatchEndCallback(this.matchState)}))}addRemotePlayer(e){const t=new gr(this.scene,e);this.remotePlayers.set(e,t);const s=this.playerTeams.get(e);return s&&t.setTeam(s),t}update(e,t,s){this.remotePlayers.forEach(n=>n.update(e));const i=Date.now();i-this.lastUpdate>this.config.updateRate&&(this.sendPlayerUpdate(t,s),this.lastUpdate=i)}sendPlayerUpdate(e,t){var s;(s=this.socket)!=null&&s.connected&&this.socket.emit("player_update",{matchId:this.matchId,position:{x:t.position.x,y:t.position.y,z:t.position.z},rotation:{x:t.rotation.x,y:t.rotation.y},velocity:{x:e.velocity.x,y:e.velocity.y,z:e.velocity.z},isSprinting:e.isSprinting,isGrounded:e.isGrounded})}sendShoot(e,t,s){var i;(i=this.socket)!=null&&i.connected&&this.socket.emit("player_shoot",{matchId:this.matchId,origin:{x:e.x,y:e.y,z:e.z},direction:{x:t.x,y:t.y,z:t.z},weaponType:s})}sendPlayerHit(e,t,s){var n;if(!((n=this.socket)!=null&&n.connected))return;const i=this.playerTeams.get(e);if(this.myTeam&&i&&this.myTeam===i){console.log("Friendly fire blocked");return}this.socket.emit("player_hit",{matchId:this.matchId,targetId:e,damage:t,hitLocation:{x:s.x,y:s.y,z:s.z}})}sendPlayerDied(e,t){var s;(s=this.socket)!=null&&s.connected&&this.socket.emit("player_died",{matchId:this.matchId,attackerId:e,weaponType:t})}sendPlayerRespawn(){var e;(e=this.socket)!=null&&e.connected&&this.socket.emit("player_respawn",{matchId:this.matchId})}onKill(e){this.onKillCallback=e}onDamage(e){this.onDamageCallback=e}onMatchEnd(e){this.onMatchEndCallback=e}onScoreUpdate(e){this.onScoreUpdateCallback=e}get otherPlayers(){return this.remotePlayers}getRemotePlayers(){return Array.from(this.remotePlayers.values())}getMatchState(){return this.matchState}isConnected(){var e;return((e=this.socket)==null?void 0:e.connected)??!1}disconnect(){this.socket&&(this.socket.off("connect"),this.socket.off("disconnect"),this.socket.off("player_joined"),this.socket.off("player_update"),this.socket.off("player_shoot"),this.socket.off("player_damaged"),this.socket.off("player_killed"),this.socket.off("player_respawned"),this.socket.off("match_state"),this.socket.off("score_update"),this.socket.off("match_ended"),this.socket.emit("disconnect"),this.socket=null),this.remotePlayers.forEach(e=>e.destroy()),this.remotePlayers.clear(),this.deadPlayers.clear()}}var z=(r=>(r.QUEUE_STARTED="queue_started",r.QUEUE_CANCELLED="queue_cancelled",r.QUEUE_UPDATE="queue_update",r.MATCH_FOUND="match_found",r.MATCH_ACCEPTED="match_accepted",r.MATCH_DECLINED="match_declined",r.MATCH_CANCELLED="match_cancelled",r.MATCH_STARTING="match_starting",r.PARTY_CREATED="party_created",r.PARTY_JOINED="party_joined",r.PARTY_LEFT="party_left",r.PARTY_DISBANDED="party_disbanded",r.FRIEND_ONLINE="friend_online",r.FRIEND_OFFLINE="friend_offline",r.INVITE_RECEIVED="invite_received",r))(z||{});const vr=[{id:"ffa",name:"Free For All",description:"Every player for themselves. First to 30 kills wins.",minPlayers:2,maxPlayers:8,category:"Arena",estimatedWaitTime:15,enabled:!0},{id:"tdm",name:"Team Deathmatch",description:"Red vs Blue. Team with most kills wins.",minPlayers:4,maxPlayers:12,category:"Arena",estimatedWaitTime:20,enabled:!0},{id:"survival",name:"Wave Survival",description:"Survive endless waves of enemies.",minPlayers:1,maxPlayers:4,category:"Casual",estimatedWaitTime:5,enabled:!0},{id:"ranked",name:"Ranked Match",description:"Competitive 5v5 with skill-based matchmaking.",minPlayers:10,maxPlayers:10,category:"Competitive",estimatedWaitTime:60,enabled:!1}];class br{constructor(e="/"){this.socket=null,this.userId="",this.isQueued=!1,this.currentModeId=null,this.queueStartTime=0,this.queueTimer=null,this.pendingMatch=null,this.currentParty=null,this.gameModes=[...vr],this.eventListeners=new Map,this.io=null,this.serverUrl=e}async connect(e){var t,s;if((t=this.socket)!=null&&t.connected)return!0;this.userId=this.extractUserId(e);try{const i=await qi(()=>import("./network-j843apyr.js"),[]);if(this.io=i.io||((s=i.default)==null?void 0:s.io),!this.io)throw new Error("socket.io-client not loaded");return this.socket=this.io(this.serverUrl,{auth:{token:e},transports:["websocket"]}),this.setupListeners(),!0}catch(i){return console.warn("Lobby connection failed:",i),!1}}extractUserId(e){const t=e.split("-");return t[t.length-1]||"0"}setupListeners(){this.socket&&(this.socket.on("connect",()=>{console.log("Connected to lobby server")}),this.socket.on("disconnect",()=>{console.log("Disconnected from lobby server"),this.stopQueueTimer(),this.isQueued=!1}),this.socket.on("match_found",e=>{const t=e;console.log("Match found:",t),this.pendingMatch=t,this.isQueued=!1,this.stopQueueTimer(),this.emit(z.MATCH_FOUND,t)}),this.socket.on("match_start",e=>{console.log("Match starting:",e),this.pendingMatch=null,this.emit(z.MATCH_STARTING,e)}),this.socket.on("match_cancelled",e=>{console.log("Match cancelled:",e),this.pendingMatch=null,this.emit(z.MATCH_CANCELLED,e)}),this.socket.on("party_update",e=>{this.currentParty=e,this.emit(z.PARTY_JOINED,e)}),this.socket.on("party_disbanded",()=>{this.currentParty=null,this.emit(z.PARTY_DISBANDED,null)}),this.socket.on("invite_received",e=>{this.emit(z.INVITE_RECEIVED,e)}))}startQueue(e){var s;if(!((s=this.socket)!=null&&s.connected))return console.warn("Not connected to lobby server"),!1;const t=this.gameModes.find(i=>i.id===e);return!t||!t.enabled?(console.warn("Invalid or disabled game mode:",e),!1):this.currentParty&&this.currentParty.leaderId!==this.userId?(console.warn("Only party leader can start queue"),!1):(this.isQueued=!0,this.currentModeId=e,this.queueStartTime=Date.now(),this.socket.emit("start_queue",{modeId:e}),this.startQueueTimer(),this.emit(z.QUEUE_STARTED,{modeId:e}),!0)}cancelQueue(){var e;(e=this.socket)!=null&&e.connected&&(this.socket.emit("cancel_queue"),this.isQueued=!1,this.currentModeId=null,this.stopQueueTimer(),this.emit(z.QUEUE_CANCELLED,null))}getQueueStatus(){const e=this.currentModeId?this.gameModes.find(t=>t.id===this.currentModeId):null;return{isQueued:this.isQueued,modeId:this.currentModeId,queueTime:this.isQueued?Math.floor((Date.now()-this.queueStartTime)/1e3):0,estimatedWait:(e==null?void 0:e.estimatedWaitTime)||0}}startQueueTimer(){this.stopQueueTimer(),this.queueTimer=window.setInterval(()=>{this.emit(z.QUEUE_UPDATE,this.getQueueStatus())},1e3)}stopQueueTimer(){this.queueTimer!==null&&(clearInterval(this.queueTimer),this.queueTimer=null)}acceptMatch(){var e;!((e=this.socket)!=null&&e.connected)||!this.pendingMatch||(this.socket.emit("accept_match",{matchId:this.pendingMatch.id}),this.emit(z.MATCH_ACCEPTED,this.pendingMatch))}declineMatch(){var e;!((e=this.socket)!=null&&e.connected)||!this.pendingMatch||(this.socket.emit("decline_match",{matchId:this.pendingMatch.id}),this.pendingMatch=null,this.emit(z.MATCH_DECLINED,null))}getPendingMatch(){return this.pendingMatch}createParty(){var e;(e=this.socket)!=null&&e.connected&&this.socket.emit("create_party")}inviteToParty(e){var t;(t=this.socket)!=null&&t.connected&&this.socket.emit("invite_to_party",{playerId:e})}joinParty(e){var t;(t=this.socket)!=null&&t.connected&&this.socket.emit("join_party",{partyId:e})}leaveParty(){var e;!((e=this.socket)!=null&&e.connected)||!this.currentParty||(this.socket.emit("leave_party"),this.currentParty=null,this.emit(z.PARTY_LEFT,null))}getParty(){return this.currentParty}isPartyLeader(){var e;return((e=this.currentParty)==null?void 0:e.leaderId)===this.userId}getGameModes(){return this.gameModes.filter(e=>e.enabled)}getAllGameModes(){return[...this.gameModes]}getGameMode(e){return this.gameModes.find(t=>t.id===e)}getModesByCategory(e){return this.gameModes.filter(t=>t.category===e&&t.enabled)}on(e,t){return this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t),()=>{var s;(s=this.eventListeners.get(e))==null||s.delete(t)}}emit(e,t){const s=this.eventListeners.get(e);s&&s.forEach(i=>i(t))}getUserId(){return this.userId}isConnected(){var e;return((e=this.socket)==null?void 0:e.connected)??!1}isInQueue(){return this.isQueued}disconnect(){this.stopQueueTimer(),this.socket&&(this.socket.emit("disconnect"),this.socket=null),this.isQueued=!1,this.currentModeId=null,this.pendingMatch=null,this.currentParty=null,this.eventListeners.clear()}}class Tr{constructor(e){this.container=null,this.isVisible=!1,this.matchFoundPopup=null,this.lobbyManager=e,this.setupEventListeners()}setupEventListeners(){this.lobbyManager.on(z.QUEUE_UPDATE,e=>{this.updateQueueDisplay(e)}),this.lobbyManager.on(z.MATCH_FOUND,e=>{this.showMatchFoundPopup(e)}),this.lobbyManager.on(z.MATCH_CANCELLED,()=>{this.hideMatchFoundPopup()}),this.lobbyManager.on(z.MATCH_STARTING,()=>{this.hideMatchFoundPopup(),this.hide()})}init(e="lobby-container"){this.container=document.getElementById(e),this.container||(this.container=document.createElement("div"),this.container.id=e,document.body.appendChild(this.container)),this.container.innerHTML=this.getMainTemplate(),this.setupUIEventHandlers()}getMainTemplate(){return`
      <div id="lobby-panel" class="lobby-panel">
        <div class="lobby-header">
          <h1>PLAY</h1>
          <button id="lobby-close-btn" class="close-btn">&times;</button>
        </div>
        
        <div class="lobby-content">
          <!-- Category Tabs -->
          <div class="category-tabs" id="category-tabs">
            <button class="category-tab active" data-category="Arena">Arena</button>
            <button class="category-tab" data-category="Competitive">Competitive</button>
            <button class="category-tab" data-category="Casual">Casual</button>
          </div>
          
          <!-- Game Modes Grid -->
          <div class="modes-grid" id="modes-grid">
            ${this.renderGameModes()}
          </div>
        </div>
        
        <!-- Queue Status -->
        <div id="queue-status" class="queue-status hidden">
          <div class="queue-info">
            <span class="queue-text">SEARCHING...</span>
            <span class="queue-time" id="queue-time">0:00</span>
          </div>
          <button id="cancel-queue-btn" class="cancel-btn">CANCEL</button>
        </div>
      </div>
      
      <!-- Match Found Popup -->
      <div id="match-found-popup" class="match-popup hidden">
        <div class="popup-content">
          <h2>MATCH FOUND</h2>
          <div class="match-info" id="match-info"></div>
          <div class="match-timer" id="match-timer">10</div>
          <div class="match-actions">
            <button id="accept-match-btn" class="accept-btn">ACCEPT</button>
            <button id="decline-match-btn" class="decline-btn">DECLINE</button>
          </div>
        </div>
      </div>
    `}renderGameModes(e="Arena"){const t=this.lobbyManager.getModesByCategory(e);return t.length===0?'<div class="no-modes">No game modes available</div>':t.map(s=>`
      <div class="mode-card ${s.enabled?"":"disabled"}" 
           data-mode-id="${s.id}"
           ${s.enabled?"":'title="Coming Soon"'}>
        <h3>${s.name}</h3>
        <p>${s.description}</p>
        <div class="mode-info">
          <span class="players">${s.minPlayers}-${s.maxPlayers} Players</span>
          <span class="wait-time">~${s.estimatedWaitTime}s wait</span>
        </div>
        ${s.enabled?'<div class="play-icon"></div>':'<div class="locked-icon"></div>'}
      </div>
    `).join("")}setupUIEventHandlers(){if(!this.container)return;const e=this.container.querySelector("#lobby-close-btn");e==null||e.addEventListener("click",()=>this.hide()),this.container.querySelectorAll(".category-tab").forEach(o=>{o.addEventListener("click",a=>{const c=a.target.dataset.category;c&&this.switchCategory(c)})}),this.setupModeCardHandlers();const s=this.container.querySelector("#cancel-queue-btn");s==null||s.addEventListener("click",()=>{this.lobbyManager.cancelQueue(),this.hideQueueStatus()});const i=this.container.querySelector("#accept-match-btn");i==null||i.addEventListener("click",()=>this.lobbyManager.acceptMatch());const n=this.container.querySelector("#decline-match-btn");n==null||n.addEventListener("click",()=>this.lobbyManager.declineMatch())}setupModeCardHandlers(){var t;const e=(t=this.container)==null?void 0:t.querySelectorAll(".mode-card:not(.disabled)");e==null||e.forEach(s=>{s.addEventListener("click",i=>{const o=i.currentTarget.dataset.modeId;o&&(this.lobbyManager.startQueue(o),this.showQueueStatus())})})}switchCategory(e){var i,n;const t=(i=this.container)==null?void 0:i.querySelectorAll(".category-tab");t==null||t.forEach(o=>{o.classList.toggle("active",o.dataset.category===e)});const s=(n=this.container)==null?void 0:n.querySelector("#modes-grid");s&&(s.innerHTML=this.renderGameModes(e),this.setupModeCardHandlers())}showQueueStatus(){var s,i;const e=(s=this.container)==null?void 0:s.querySelector("#queue-status");e==null||e.classList.remove("hidden");const t=(i=this.container)==null?void 0:i.querySelectorAll(".mode-card");t==null||t.forEach(n=>n.classList.add("queued"))}hideQueueStatus(){var s,i;const e=(s=this.container)==null?void 0:s.querySelector("#queue-status");e==null||e.classList.add("hidden");const t=(i=this.container)==null?void 0:i.querySelectorAll(".mode-card");t==null||t.forEach(n=>n.classList.remove("queued"))}updateQueueDisplay(e){var s;const t=(s=this.container)==null?void 0:s.querySelector("#queue-time");if(t){const i=Math.floor(e.queueTime/60),n=e.queueTime%60;t.textContent=`${i}:${n.toString().padStart(2,"0")}`}}showMatchFoundPopup(e){var a;if(this.hideQueueStatus(),this.matchFoundPopup=(a=this.container)==null?void 0:a.querySelector("#match-found-popup"),!this.matchFoundPopup)return;this.matchFoundPopup.classList.remove("hidden");const t=this.matchFoundPopup.querySelector("#match-info"),s=this.lobbyManager.getGameMode(e.modeId);t&&s&&(t.textContent=s.name);let i=10;const n=this.matchFoundPopup.querySelector("#match-timer"),o=setInterval(()=>{i--,n&&(n.textContent=i.toString()),i<=0&&(clearInterval(o),this.lobbyManager.declineMatch())},1e3);this.matchFoundPopup._countdown=o}hideMatchFoundPopup(){if(!this.matchFoundPopup)return;const e=this.matchFoundPopup._countdown;e&&clearInterval(e),this.matchFoundPopup.classList.add("hidden")}show(){var e;this.isVisible=!0,(e=this.container)==null||e.classList.remove("hidden"),document.body.classList.add("lobby-open")}hide(){var e;this.isVisible=!1,(e=this.container)==null||e.classList.add("hidden"),document.body.classList.remove("lobby-open")}toggle(){this.isVisible?this.hide():this.show()}isShown(){return this.isVisible}dispose(){var e;this.hideMatchFoundPopup(),(e=this.container)==null||e.remove(),this.container=null}}const rs=new b;class Sr{constructor(){this.arenaObjects=[],this.mouseMovement={x:0,y:0},this.headBobTime=0,this.targetFOV=75,this.currentFOV=75,this.baseFOV=75,this.zoomedFOV=15,this.fovLerpSpeed=12,this.zoomTransitionProgress=0,this.entityManager=new _n,this.time=new vn,this.tick=0,this.spawningManager=new Xo(this),this.uiManager=new wa(this),this.useFPSControls=!0,this.enemyCount=w.BOT.COUNT,this.competitors=new Array,this._animate=this.animate.bind(this),this._onWindowResize=this.onWindowResize.bind(this),this.debug=!1,this.helpers={convexRegionHelper:null,spatialIndexHelper:null,axesHelper:null,graphHelper:null,pathHelpers:new Array,spawnHelpers:null,uuidHelpers:new Array,skeletonHelpers:new Array,itemHelpers:new Array}}init(){return this.assetManager=new Vo,this.assetManager.init().then(()=>{this._initScene(),this._initLevel(),this._initEnemies(),this._initPlayer(),this._initControls(),this._initUI(),this._animate()}),this}add(e){return this.entityManager.add(e),e._renderComponent!==null&&this.scene.add(e._renderComponent),this}remove(e){return this.entityManager.remove(e),e._renderComponent!==null&&this.scene.remove(e._renderComponent),this}addBullet(e,t){const s=this.assetManager.models.get("bulletLine").clone();s.visible=!1;const i=new Xa(e,t);return i.setRenderComponent(s,kt),this.add(i),this}checkProjectileIntersection(e,t){const s=this.entityManager.entities;let i=1/0,n=null;const o=e.owner,a=e.ray;for(let l=0,c=s.length;l<c;l++){const h=s[l];if(h!==o&&h.active&&h.checkProjectileIntersection&&h.checkProjectileIntersection(a,rs)!==null){const d=rs.squaredDistanceTo(a.origin);d<i&&(i=d,n=h,t.copy(rs))}}return n}getClosestItem(e,t,s){let i=this.spawningManager.getItemList(t),n=null,o=1/0;if(i)for(let a=0,l=i.length;a<l;a++){const c=i[a];if(c.active){const h=e.currentRegion,d=c.currentRegion,u=this.navMesh.getNodeIndex(h),p=this.navMesh.getNodeIndex(d),y=this.costTable.get(u,p);y<o&&(o=y,n=c)}}return s.item=n,s.distance=o,s}_initScene(){this.scene=new Li,this.scene.background=new Se(16777215),this.camera=new bs(75,window.innerWidth/window.innerHeight,.001,1e3),this.camera.position.set(0,7.5,10),this.camera.add(this.assetManager.listener),this.scene.add(this.camera),this.debug&&(this.helpers.axesHelper=new no(5),this.helpers.axesHelper.visible=!1,this.scene.add(this.helpers.axesHelper));const e=new oo(16777215,4473924,.4);e.position.set(0,100,0),this.scene.add(e);const t=new Mi(16777215,.8);t.position.set(-700,1e3,-750),this.scene.add(t);const s=new Za;s.scale.setScalar(1e3);const i=s.material;return i.uniforms.turbidity.value=5,i.uniforms.rayleigh.value=1.5,i.uniforms.sunPosition.value.set(-700,1e3,-750),this.scene.add(s),this.renderer=new ao({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.autoClear=!1,this.renderer.shadowMap.enabled=!0,this.renderer.outputColorSpace=je,document.body.appendChild(this.renderer.domElement),window.addEventListener("resize",this._onWindowResize,!1),this._initRIFT(),this}_initEnemies(){const e=this.enemyCount,t=this.assetManager.navMesh;this.pathPlanner=new Qa(t);for(let s=0;s<e;s++){const i=Ot.cloneWithSkinning(this.assetManager.models.get("soldier")),n=new mi(this);n.name="Bot"+s,n.setRenderComponent(i,kt),i.userData.entity=n,i.traverse(m=>{m.userData.entity=n});const o=new ft(i),a=this.assetManager.animations.get("soldier_idle"),l=this.assetManager.animations.get("soldier_forward"),c=this.assetManager.animations.get("soldier_backward"),h=this.assetManager.animations.get("soldier_left"),d=this.assetManager.animations.get("soldier_right"),u=this.assetManager.animations.get("soldier_death1"),p=this.assetManager.animations.get("soldier_death2"),y=[a,l,c,h,d,u,p];if(n.setAnimations(o,y),this.add(n),this.competitors.push(n),this.spawningManager.respawnCompetitor(n),this.debug){const m=Mt.createPathHelper();n.pathHelper=m,this.scene.add(m),this.helpers.pathHelpers.push(m);const f=Ot.createUUIDLabel(n.uuid);f.position.y=2,f.visible=!1,i.add(f),this.helpers.uuidHelpers.push(f);const _=new ro(i);_.visible=!1,this.scene.add(_),this.helpers.skeletonHelpers.push(_)}}return this}_initLevel(){const e=this.assetManager.models.get("level"),t=e.getObjectByName("level"),s=t.geometry.attributes.position.array,i=t.geometry.index.array,n=new bn(s,i),o=new Ca(n);o.name="level",o.setRenderComponent(e,kt),e.userData.entity=o,e.traverse(y=>{y.userData.entity=o}),this.level=o,this.add(o),this.arenaObjects=[],e.updateMatrixWorld(!0),console.log("Total arenaObjects:",this.arenaObjects.length),this.navMesh=this.assetManager.navMesh,this.costTable=this.assetManager.costTable;const a=this.assetManager.configs.get("level"),l=a.spatialIndex.width,c=a.spatialIndex.height,h=a.spatialIndex.depth,d=a.spatialIndex.cellsX,u=a.spatialIndex.cellsY,p=a.spatialIndex.cellsZ;return this.navMesh.spatialIndex=new Tn(l,c,h,d,u,p),this.navMesh.updateSpatialIndex(),this.helpers.spatialIndexHelper=Mt.createCellSpaceHelper(this.navMesh.spatialIndex),this.scene.add(this.helpers.spatialIndexHelper),this.spawningManager.init(),this.debug&&(this.helpers.convexRegionHelper=Mt.createConvexRegionHelper(this.navMesh),this.scene.add(this.helpers.convexRegionHelper),this.helpers.graphHelper=Mt.createGraphHelper(this.navMesh.graph,.2),this.scene.add(this.helpers.graphHelper),this.helpers.spawnHelpers=Ot.createSpawnPointHelper(this.spawningManager.spawningPoints),this.scene.add(this.helpers.spawnHelpers)),this}_initPlayer(){const e=this.assetManager,t=new Ya(this),s=new fe;s.matrixAutoUpdate=!1;const i=new N(.5,1.8,.5),n=new K({visible:!1}),o=new x(i,n);o.position.y=.9,o.name="playerCollision",o.userData.entity=t,s.add(o),t.setRenderComponent(s,kt);const a=e.cloneAudio(e.audios.get("step1")),l=e.cloneAudio(e.audios.get("step2")),c=e.audios.get("impact1"),h=e.audios.get("impact2"),d=e.audios.get("impact3"),u=e.audios.get("impact4"),p=e.audios.get("impact5"),y=e.audios.get("impact6"),m=e.audios.get("impact7");a.setVolume(.5),l.setVolume(.5),s.add(a,l),s.add(c,h,d,u,p,y,m),t.audios.set("step1",a),t.audios.set("step2",l),t.audios.set("impact1",c),t.audios.set("impact2",h),t.audios.set("impact3",d),t.audios.set("impact4",u),t.audios.set("impact5",p),t.audios.set("impact6",y),t.audios.set("impact7",m);const f=new ft(t.head),M=[this.assetManager.animations.get("player_death")];return t.setAnimations(f,M),this.add(t),this.competitors.push(t),this.spawningManager.respawnCompetitor(t),this.debug&&t.deactivate(),this.player=t,this}_initControls(){return this.fpsControls=new va(this.player),this.fpsControls.sync(),this.camera.matrixAutoUpdate=!1,this.player.activate(),this.player.head.setRenderComponent(this.camera,Mr),this.rift&&(this.rift.hudManager.show(),console.log("RIFT HUD shown")),this.fpsControls.addEventListener("lock",()=>{const e=document.getElementById("hudAmmo"),t=document.getElementById("hudHealth"),s=document.getElementById("hudFragList");e&&(e.style.display="none"),t&&(t.style.display="none"),s&&(s.style.display="none")}),this.fpsControls.addEventListener("unlock",()=>{this.uiManager.hideFPSInterface()}),this.fpsControls.connect(),this}_initUI(){return this.uiManager.init(),this.rift&&this.rift.hudManager.show(),this}_initRIFT(){this.rift=new rr(this.scene,this.camera,this.assetManager.listener,this.assetManager),this.gameModeManager=new pr(this,this.rift.hudManager),this.networkManager=new _r(this.scene),this.lobbyManager=new br,this.lobbyUI=new Tr(this.lobbyManager),this._setupLobbyEvents(),this.rift.weaponSystem.setShellEjectCallback((s,i)=>{const n=this.player.position.y;this.rift.particleSystem.spawnShellCasing(s,i,n)}),this.rift.particleSystem.setShellBounceCallback((s,i)=>{const n=Math.max(.3,1-(i-1)*.25);i<=4&&this.rift.impactSystem.playShellDrop(s,n)}),this.rift.weaponSystem.setZoomCallback(s=>{this.targetFOV=s?this.zoomedFOV:this.baseFOV,this.rift.hudManager.toggleScope(s)}),this.rift.weaponSystem.switchWeapon(0),console.log("RIFT Integration initialized successfully");const e=["blaster_high","shotgun_high","assaultRifle_high"],t=[];return this.scene.traverse(s=>{s.isMesh&&e.some(i=>{var n;return(n=s.name)==null?void 0:n.includes(i)})&&t.push(s),s.isGroup&&s.children.length>0&&s.children.some(n=>n.isMesh&&e.some(o=>{var a;return(a=n.name)==null?void 0:a.includes(o)}))&&t.push(s)}),t.forEach(s=>{this.scene.remove(s),console.log("Removed old Drift weapon from scene:",s.name||s.type)}),console.log(`Removed ${t.length} old weapon meshes from scene`),this}_setupLobbyEvents(){this.lobbyManager.on(z.MATCH_FOUND,e=>{console.log("Match found!",e)}),this.lobbyManager.on(z.MATCH_STARTING,async e=>{const t=e;await this.networkManager.connect(t.serverUrl,t.token,t.matchId)&&(this.lobbyUI.hide(),this._startMultiplayerGame(t.modeId))}),this.lobbyManager.on(z.QUEUE_UPDATE,e=>{console.log("Queue update:",e)})}_startMultiplayerGame(e){const s={ffa:se.FREE_FOR_ALL,tdm:se.TEAM_DEATHMATCH,wave:se.WAVE_SURVIVAL}[e]||se.FREE_FOR_ALL;this.gameModeManager.setMode(s)}handleRiftShot(e,t,s){const i=this.rift.weaponSystem.getMuzzleWorldPosition();if(e){const n=new S(e.x,e.y,e.z);if(this.rift.tracerSystem.createTracer(i,n),t){const o=new S(t.x,t.y,t.z);s instanceof mi?(this.rift.particleSystem.spawnImpactEffect(n,!1),this.rift.hudManager.showHitmarker(s.health<=0)):(this.rift.decalSystem.createDecal(n,o,re.ROCK),this.rift.particleSystem.spawnMaterialImpact(n,o,re.ROCK),this.rift.impactSystem.playSurfaceImpact(n,re.ROCK))}}}onWindowResize(){const e=window.innerWidth,t=window.innerHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.uiManager.setSize(e,t)}animate(){requestAnimationFrame(this._animate),this.time.update(),this.tick++;const e=this.time.getDelta();this.debug?this.useFPSControls&&this.fpsControls.update(e):this.fpsControls.update(e),this.spawningManager.update(e),this.entityManager.update(e);for(const t of this.entityManager.entities)this._syncRenderComponent(t);this.pathPlanner.update(),this._updateRIFT(e),this.renderer.clear(),this.renderer.render(this.scene,this.camera),this.uiManager.update(e)}_updateRIFT(e){var a,l,c;if(!this.rift)return;Math.abs(this.currentFOV-this.targetFOV)>.01&&(this.currentFOV+=(this.targetFOV-this.currentFOV)*Math.min(1,e*this.fovLerpSpeed),this.camera.fov=this.currentFOV,this.camera.updateProjectionMatrix(),this.zoomTransitionProgress=1-(this.currentFOV-this.zoomedFOV)/(this.baseFOV-this.zoomedFOV));const t=(a=this.player)!=null&&a.velocity?Math.sqrt(this.player.velocity.x**2+this.player.velocity.z**2):0;t>.1?this.headBobTime+=e*t*2:this.headBobTime+=e*2;const s=((c=(l=this.fpsControls)==null?void 0:l.input)==null?void 0:c.sprint)??!1;this.rift.particleSystem.update(e),this.rift.decalSystem.update(e),this.rift.tracerSystem.update(e),this.rift.weaponSystem.update(e,this.mouseMovement,s,this.headBobTime),this.rift.screenEffects.update(e),this.rift.hudManager.updateKillfeed(e);const i=this.rift.getCameraRecoil();if(this.fpsControls&&(Math.abs(i.pitch)>1e-4||Math.abs(i.yaw)>1e-4)){this.fpsControls.movementY-=i.pitch*e*.5,this.fpsControls.movementX-=i.yaw*e*.5;const h=Math.PI/2;this.fpsControls.movementY=Math.max(-h,Math.min(h,this.fpsControls.movementY))}const n=this.rift.getShakeOffset();if(n.length()>1e-4){const h=n.clone();h.applyQuaternion(this.camera.quaternion),this.camera.position.add(h)}this.player&&this.rift.hudManager.updateHealth(this.player.health,this.player.maxHealth);const o=this.rift.weaponSystem.currentConfig;this.rift.hudManager.updateWeaponName(o.name),this.rift.hudManager.updateAmmo(this.rift.weaponSystem.currentMag,this.rift.weaponSystem.reserveAmmo),this.rift.hudManager.showReloading(this.rift.weaponSystem.isReloading),this.rift.hudManager.updateCrosshair(this.rift.weaponSystem.getCurrentSpread()),this.gameModeManager&&this.gameModeManager.update(e),this.networkManager&&this.player&&this.networkManager.update(e,this.player,this.camera),this.mouseMovement.x=0,this.mouseMovement.y=0}onMouseMove(e,t){this.mouseMovement.x=e,this.mouseMovement.y=t}_syncRenderComponent(e){if(e.renderComponent&&(e._renderComponentCallback?e._renderComponentCallback(e,e.renderComponent):e.renderComponent.matrix.copy(e.worldMatrix)),e.children)for(const t of e.children)this._syncRenderComponent(t)}}function kt(r,e){e.matrix.copy(r.worldMatrix)}function Mr(r,e){e.matrixWorld.copy(r.worldMatrix),e.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.matrix.copy(r.worldMatrix)}const Qi=new Sr;window.world=Qi;const wi=document.getElementById("start");wi&&wi.addEventListener("click",()=>{const r=document.getElementById("startScreen");r&&r.remove(),Qi.init()});
//# sourceMappingURL=index-Dfs48HFN.js.map
